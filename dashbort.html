<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HUB Operacional - Pinheiro (Premium Dashboard)</title>
    
    <!-- Scripts Firebase (Compat Mode) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* CONFIGURAÇÃO GERAL */
        html, body { min-height: 100vh; overflow-y: auto; overflow-x: hidden; background: #020617; font-family: 'Plus Jakarta Sans', sans-serif; color: #f1f5f9; scroll-behavior: smooth; }
        .glass { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        #timer-bar { height: 4px; background: #3b82f6; width: 0%; transition: width 0.1s linear; position: fixed; top: 0; left: 0; z-index: 9999; border-radius: 0 4px 4px 0; }
        
        /* Molduras Pódio */
        .gold-border { border: 4px solid #FFD700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); }
        .silver-border { border: 3px solid #C0C0C0; box-shadow: 0 0 15px rgba(192, 192, 192, 0.3); }
        .bronze-border { border: 2px solid #CD7F32; box-shadow: 0 0 10px rgba(205, 127, 50, 0.3); }

        /* EFEITO DE ULTRAPASSAGEM (RANKING) */
        #ranking-compact-list { position: relative; width: 100%; }
        .ranking-item-compact { 
            position: absolute; width: 100%;
            transition: all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* ESTILO REPOSIÇÃO ER ORIGINAL */
        .er-section { margin-top: 2rem; margin-bottom: 5rem; }
        .er-header { cursor: pointer; transition: transform 0.3s; }
        .er-header:hover { transform: scale(1.005); }
        .er-style { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; border-radius: 24px; overflow: hidden; }
        .er-content { display: none; background: #ffffff; }
        .er-content.open { display: block; animation: slideDown 0.4s forwards; }
        
        .er-table { width: 100%; border-collapse: collapse; }
        .er-table th { background: #fdfdfd; padding: 18px; text-align: left; font-size: 0.8rem; text-transform: uppercase; color: #64748b; border-bottom: 2px solid #e2e8f0; }
        .er-table td { padding: 18px; font-size: 0.95rem; border-bottom: 1px solid #f1f5f9; color: #1e293b; }
        .er-table tr:nth-child(even) { background-color: #f1f5f9; }
        
        .badge-open { display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 800; background: #eff6ff; color: #1e40af; border: 1px solid #dbeafe; }
        .dot { height: 8px; width: 8px; background: #2563eb; border-radius: 50%; margin-right: 8px; position: relative; }
        .dot::after { content: ''; position: absolute; inset: 0; background: #2563eb; border-radius: 50%; animation: pulse 2s infinite; }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(4); opacity: 0; } }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="timer-bar"></div>

    <div class="max-w-[1750px] mx-auto space-y-8">
        
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-6 glass p-6 rounded-[2rem]">
            <div>
                <h1 class="text-3xl font-black italic uppercase tracking-tighter">HUB <span class="text-blue-500">OPERACIONAL</span></h1>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                    <p class="text-[10px] text-blue-400 font-bold uppercase tracking-widest italic">Sincronizado via Firebase</p>
                </div>
            </div>
            <div class="flex gap-2 bg-black/30 p-1.5 rounded-2xl border border-white/5">
                <button id="btn-hoje" class="px-8 py-3 rounded-xl text-xs font-black transition-all">HOJE</button>
                <button id="btn-semana" class="px-8 py-3 rounded-xl text-xs font-black transition-all">SEMANA</button>
                <button id="btn-mes" class="px-8 py-3 rounded-xl text-xs font-black transition-all">MÊS</button>
            </div>
        </header>

        <!-- DASHBOARD SUPERIOR -->
        <div class="flex flex-col gap-8">
            <!-- Linha 1: Gráfico e Totais -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-2 glass p-8 rounded-[2.5rem] flex items-center justify-around h-64">
                    <div style="height: 200px; width: 200px;"><canvas id="teamChart"></canvas></div>
                    <div id="chart-legend" class="text-xs font-bold uppercase space-y-2 text-slate-400"></div>
                </div>
                <div class="flex flex-col gap-4">
                    <div class="glass p-6 rounded-[2.5rem] border-l-4 border-blue-500 flex-1 flex flex-col justify-center text-center">
                        <p class="text-[10px] text-slate-500 uppercase font-black mb-1">Total de Pedidos</p>
                        <h2 id="global-total" class="text-5xl font-black text-white">0</h2>
                    </div>
                    <div class="glass p-6 rounded-[2.5rem] border-l-4 border-emerald-500 flex-1 flex flex-col justify-center text-center">
                        <p class="text-[10px] text-slate-500 uppercase font-black mb-1">Média da Equipe</p>
                        <h2 id="global-avg" class="text-5xl font-black text-white">0</h2>
                    </div>
                </div>
            </div>

            <!-- Linha 2: Pódio e Ranking (ALINHADOS) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Pódio (Esquerda) -->
                <div id="podium-area" class="glass p-8 rounded-[2.5rem] flex justify-center items-end gap-10 h-[480px]"></div>
                
                <!-- Ranking Performance (Direita) -->
                <div class="glass rounded-[2.5rem] p-8 flex flex-col h-[480px]">
                    <h3 class="text-center text-slate-500 font-black uppercase text-xs mb-8 tracking-widest italic">Performance da Equipe</h3>
                    <div class="flex-1 overflow-y-auto custom-scroll pr-2">
                        <div id="ranking-compact-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEÇÃO INFERIOR: REPOSIÇÃO ER -->
        <div class="er-section">
            <div class="er-style shadow-2xl">
                <div class="bg-[#0f172a] p-10 text-center er-header" onclick="toggleER()">
                    <h2 class="text-4xl font-black text-white tracking-[0.2em] uppercase">Reposição ER</h2>
                    <div id="er-count-container" class="mt-4 flex flex-col items-center">
                        <span id="er-count-num" class="text-6xl font-black text-blue-500">0</span>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em]">Itens Pendentes</span>
                    </div>
                    <p class="text-slate-500 text-[9px] mt-6 uppercase font-bold tracking-widest italic animate-pulse">Clique para abrir/fechar visualização</p>
                </div>
                
                <div id="er-toggle-content" class="er-content">
                    <div class="p-6 bg-white border-b flex justify-center">
                        <button id="er-copy-btn" class="max-w-md w-full bg-[#2563eb] text-white py-5 rounded-2xl font-black text-sm uppercase hover:bg-blue-700 transition-all shadow-xl">COPIAR LISTA (CÓDIGO | QUANTIDADE)</button>
                    </div>
                    <div class="bg-white overflow-x-auto">
                        <table class="er-table">
                            <thead>
                                <tr>
                                    <th style="width: 100px;">Data</th>
                                    <th style="width: 220px;">Solicitante</th>
                                    <th style="width: 150px;">Código</th>
                                    <th>Descrição Completa</th>
                                    <th style="width: 100px; text-align: center;">Qtd</th>
                                    <th style="width: 150px; text-align: right;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="er-body"></tbody>
                        </table>
                        <div id="er-empty" class="hidden p-20 text-center text-slate-300 font-bold uppercase text-lg italic">✅ TUDO PRONTO - NENHUM ITEM PENDENTE</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Input -->
    <input type="file" id="uploadInput" class="hidden" accept="image/*">

    <script>
        // CONFIGURAÇÕES FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDlp5p7c3xpc42cRa1un_-zd3HNwqnGuQU",
            authDomain: "petisco-a5880.firebaseapp.com",
            databaseURL: "https://petisco-a5880-default-rtdb.firebaseio.com",
            projectId: "petisco-a5880",
            storageBucket: "petisco-a5880.firebasestorage.app",
            messagingSenderId: "211799950005",
            appId: "1:211799950005:web:836bb02c084bc906bdf4fc"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const API_KEY_IMGBB = "6161a9db426f51baa788f0823269c981";
        const CONFIG = {
            SEP_ID: '1CInfRwxUS7nMFWqzYaQIoQyUGq76RULk-XMp6cASVRg',
            SEP_ABA: 'Separação - FEV/26',
            REPO_ID: '1pQD4qViThkVjxsbFj8yrG7p2wdW0vuo_197hKVtvTRY',
            REPO_ABA: 'REPOSIÇÃO DEZ/25'
        };

        let allSepData = [], fotoCache = {}, currentFilter = 'hoje', chartInstance = null, timer = 0;
        const colorPalette = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#f43f5e', '#fb923c'];

        Chart.register(ChartDataLabels);

        // Escutar fotos do Firebase
        db.ref('fotos_separadores').on('value', snap => {
            fotoCache = snap.val() || {};
            renderSeparacao();
        });

        // Função de Upload (ImgBB -> Firebase)
        function triggerUpload(nome) {
            const input = document.getElementById('uploadInput');
            input.onchange = async e => {
                const file = e.target.files[0];
                if (!file) return;
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY_IMGBB}`, { method: 'POST', body: formData });
                    const result = await res.json();
                    if (result.success) {
                        db.ref('fotos_separadores/' + nome.replace(/\s/g, '_').replace(/\./g, '_')).set(result.data.url);
                        alert(`Foto de ${nome} salva no sistema!`);
                    }
                } catch (err) { alert("Erro no upload."); }
            };
            input.click();
        }

        function animateCounter(id, start, end, duration) {
            const obj = document.getElementById(id);
            if (!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function toggleER() {
            document.getElementById('er-toggle-content').classList.toggle('open');
        }

        async function updateDashboard() {
            try {
                const resRepo = await fetch(`https://opensheet.elk.sh/${CONFIG.REPO_ID}/${encodeURIComponent(CONFIG.REPO_ABA)}`);
                const dataRepo = await resRepo.json();
                const filtered = dataRepo.filter(i => {
                    const keys = Object.keys(i);
                    const status = String(i[keys.find(k => /situa|separa|status|ok/i.test(k))] || '').trim();
                    const codCol = keys.find(k => /cód|cod|part/i.test(k));
                    return String(i[codCol] || '').trim() !== "" && status === "";
                });
                renderReposicao(filtered);
            } catch (e) {}

            const urlSep = `https://docs.google.com/spreadsheets/d/${CONFIG.SEP_ID}/gviz/tq?tqx=responseHandler:processSep&sheet=${encodeURIComponent(CONFIG.SEP_ABA)}`;
            const script = document.createElement('script'); script.src = urlSep; document.body.appendChild(script);
        }

        window.processSep = function(response) {
            allSepData = response.table.rows.map(r => ({
                dataStr: r.c[0] ? (r.c[0].f || r.c[0].v.toString()) : "",
                nome: r.c[2] ? String(r.c[2].v).trim().toUpperCase() : "",
                qtd: r.c[3] ? Number(r.c[3].v) : 0
            })).filter(r => r.nome && r.nome !== "ESTOQUISTA");
            renderSeparacao();
        };

        function renderSeparacao() {
            const now = new Date(); now.setHours(0,0,0,0);
            const summary = {};
            allSepData.forEach(item => {
                const p = item.dataStr.split('/');
                const d = new Date(p[2] || now.getFullYear(), p[1]-1, p[0]);
                let inc = false;
                if (currentFilter === 'hoje' && d.getTime() === now.getTime()) inc = true;
                else if (currentFilter === 'semana' && (now - d) / 86400000 <= 7) inc = true;
                else if (currentFilter === 'mes' && d.getMonth() === now.getMonth()) inc = true;
                if (inc) {
                    if (!summary[item.nome]) summary[item.nome] = { qtd: 0 };
                    summary[item.nome].qtd += item.qtd;
                }
            });

            const stats = Object.entries(summary).map(([nome, d], i) => ({
                nome, qtd: d.qtd, color: colorPalette[i % colorPalette.length],
                foto: fotoCache[nome.replace(/\s/g, '_').replace(/\./g, '_')] || `https://ui-avatars.com/api/?name=${nome}&background=334155&color=fff`
            })).sort((a,b) => b.qtd - a.qtd);

            animateCounter('global-total', 0, stats.reduce((a, b) => a + b.qtd, 0), 1000);
            animateCounter('global-avg', 0, stats.length ? Math.round(stats.reduce((a,b)=>a+b.qtd,0)/stats.length) : 0, 1000);

            renderPodium(stats);
            renderRanking(stats, stats.reduce((a,b)=>a+b.qtd,0));
            updateChart(stats, stats.reduce((a,b)=>a+b.qtd,0));
        }

        function renderPodium(stats) {
            const [p1, p2, p3] = stats;
            const area = document.getElementById('podium-area');
            area.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="w-20 h-20 silver-border rounded-full overflow-hidden bg-slate-800"><img src="${p2?.foto || ''}" class="w-full h-full object-cover"></div>
                    <p class="text-[10px] font-black mt-2 text-slate-400">2º ${p2?.nome || ''}</p>
                    <p class="text-3xl font-black">${p2?.qtd || 0}</p>
                </div>
                <div class="flex flex-col items-center pb-8">
                    <i class="fas fa-crown text-yellow-400 text-3xl mb-1 animate-bounce"></i>
                    <div class="w-36 h-36 gold-border rounded-full overflow-hidden bg-slate-800"><img src="${p1?.foto || ''}" class="w-full h-full object-cover"></div>
                    <p class="text-xs font-black mt-3 text-yellow-500 uppercase tracking-widest text-center">${p1?.nome || ''}</p>
                    <p class="text-5xl font-black">${p1?.qtd || 0}</p>
                </div>
                <div class="flex flex-col items-center">
                    <div class="w-16 h-16 bronze-border rounded-full overflow-hidden bg-slate-800"><img src="${p3?.foto || ''}" class="w-full h-full object-cover"></div>
                    <p class="text-[10px] font-black mt-2 text-slate-400">3º ${p3?.nome || ''}</p>
                    <p class="text-3xl font-black">${p3?.qtd || 0}</p>
                </div>`;
        }

        function renderRanking(stats, total) {
            const container = document.getElementById('ranking-compact-list');
            const rowH = 68;
            container.style.height = `${stats.length * rowH}px`;
            stats.forEach((s, idx) => {
                let el = document.getElementById(`rank-${s.nome.replace(/\s/g, '_')}`);
                if (!el) {
                    el = document.createElement('div');
                    el.id = `rank-${s.nome.replace(/\s/g, '_')}`;
                    el.className = 'ranking-item-compact flex items-center gap-3 p-3 glass rounded-2xl cursor-pointer hover:bg-white/5 transition-all';
                    el.onclick = () => triggerUpload(s.nome);
                    container.appendChild(el);
                }
                const perc = total > 0 ? ((s.qtd/total)*100).toFixed(1) : 0;
                el.style.top = `${idx * rowH}px`;
                el.innerHTML = `
                    <span class="text-sm font-black text-slate-600 w-6">#${idx+1}</span>
                    <div class="w-10 h-10 rounded-full overflow-hidden border border-white/20 bg-slate-800"><img src="${s.foto}" class="w-full h-full object-cover"></div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center"><span class="text-xs font-black uppercase text-slate-200 truncate pr-2">${s.nome}</span><span class="text-lg font-black text-blue-400">${s.qtd}</span></div>
                        <div class="w-full h-1 bg-white/5 mt-1 rounded-full overflow-hidden"><div class="h-full" style="width: ${perc}%; background:${s.color}; shadow: 0 0 10px ${s.color};"></div></div>
                    </div><span class="text-[9px] font-bold text-slate-500 w-10 text-right">${perc}%</span>`;
            });
        }

        function updateChart(stats, total) {
            const ctx = document.getElementById('teamChart').getContext('2d');
            const data = { labels: stats.map(s => s.nome), datasets: [{ data: stats.map(s => s.qtd), backgroundColor: stats.map(s => s.color), borderWidth: 0 }] };
            if (chartInstance) { chartInstance.data = data; chartInstance.update(); }
            else { chartInstance = new Chart(ctx, { type: 'doughnut', data, options: { cutout: '80%', plugins: { legend: false, datalabels: { color: '#fff', font: { weight: 'bold', size: 10 }, formatter: v => total > 0 ? Math.round((v/total)*100)+'%' : '' } } } }); }
            document.getElementById('chart-legend').innerHTML = stats.slice(0, 5).map(s => `<div class="flex items-center gap-2"><div class="w-2.5 h-2.5 rounded-full" style="background:${s.color}"></div>${s.nome}: ${total > 0 ? ((s.qtd/total)*100).toFixed(1) : 0}%</div>`).join('');
        }

        function renderReposicao(data) {
            const tbody = document.getElementById('er-body');
            animateCounter('er-count-num', 0, data.length, 1500);
            if (data.length === 0) { document.getElementById('er-empty').classList.remove('hidden'); tbody.innerHTML = ''; return; }
            document.getElementById('er-empty').classList.add('hidden');
            tbody.innerHTML = data.map(i => {
                const keys = Object.keys(i);
                return `<tr>
                    <td style="color:#2563eb; font-weight:700;">${String(Object.values(i)[0]).substring(0,5)}</td>
                    <td style="color:#64748b; font-weight:500;">${i[keys[5]] || '---'}</td>
                    <td style="color:#2563eb; font-weight:800;">${i[keys.find(k => /cód|cod|part/i.test(k))] || '-'}</td>
                    <td class="font-medium">${i[keys.find(k => /desc/i.test(k))] || '-'}</td>
                    <td style="text-align:center; font-weight:900; color:#ef4444; font-size: 1.2rem;">${i[keys.find(k => /qtd|quant/i.test(k))] || '0'}</td>
                    <td style="text-align:right;"><span class="badge-open"><span class="dot"></span>ABERTO</span></td>
                </tr>`;
            }).join('');
        }

        function changeFilter(f) { 
            currentFilter = f; 
            document.querySelectorAll('button[id^="btn-"]').forEach(b => b.className = "px-8 py-3 rounded-xl text-xs font-black transition-all text-slate-500");
            document.getElementById(`btn-${f}`).className = "px-8 py-3 rounded-xl text-xs font-black transition-all bg-blue-600 text-white shadow-xl scale-105 ring-2 ring-blue-500/20";
            updateDashboard(); 
        }

        setInterval(() => {
            timer += 1.666; 
            document.getElementById('timer-bar').style.width = timer + '%';
            if (timer >= 100) {
                timer = 0;
                changeFilter(['hoje', 'semana', 'mes'][(['hoje', 'semana', 'mes'].indexOf(currentFilter) + 1) % 3]);
            }
        }, 100);

        document.getElementById('er-copy-btn').onclick = (e) => {
            e.stopPropagation();
            const text = filteredRepoData.map(i => `${i[Object.keys(i).find(k => /cód|cod|part/i.test(k))]} | ${i[Object.keys(i).find(k => /qtd|quant/i.test(k))]}`).join('\n');
            navigator.clipboard.writeText(text).then(() => { 
                const btn = document.getElementById('er-copy-btn');
                const orig = btn.innerText; btn.innerText = "✅ LISTA COPIADA!";
                setTimeout(() => btn.innerText = orig, 2000);
            });
        };

        updateDashboard(); changeFilter('hoje');
    </script>
</body>
</html>