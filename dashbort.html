<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPERAX | TV Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #020617; 
            color: #f1f5f9;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 1.5rem;
        }

        /* Container de Vidro Robusto */
        .glass { 
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(12px); 
            border: 2px solid rgba(255,255,255,0.08); 
            border-radius: 2rem;
        }

        /* Barra de tempo discreta no topo */
        #timer-bar { height: 4px; background: #3b82f6; width: 0%; position: fixed; top: 0; left: 0; transition: width 0.1s linear; }

        /* Scrollbars para listas */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }

        /* Avatares da Equipe */
        .avatar-box { 
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover; 
            background: #2563eb; display: flex; align-items: center; justify-content: center; 
            font-weight: 800; cursor: pointer; border: 4px solid transparent; transition: 0.3s;
        }
        .avatar-box:hover { border-color: #3b82f6; transform: scale(1.05); }

        /* Podium Classes */
        .p-gold { border-color: #fbbf24; box-shadow: 0 0 20px rgba(251, 191, 36, 0.2); }
        .p-silver { border-color: #94a3b8; }
        .p-bronze { border-color: #b45309; }

        /* Animação suave */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body>

    <div id="timer-bar"></div>
    <input type="file" id="photo-upload" class="hidden" accept="image/*">

    <!-- CABEÇALHO -->
    <header class="flex justify-between items-center mb-6 px-4">
        <div class="flex items-center gap-6">
            <h1 class="text-5xl font-black italic tracking-tighter uppercase">OPERA<span class="text-blue-500">X</span></h1>
            <div class="h-10 w-1 bg-white/10 rounded-full"></div>
            <div class="flex flex-col">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></span>
                    <span class="text-xs font-bold uppercase tracking-widest text-slate-400">Sincronizado</span>
                </div>
                <p class="text-[10px] text-slate-600 font-bold uppercase tracking-widest">Painel de TV - VD Pinheiro</p>
            </div>
        </div>
        
        <div class="flex gap-2 glass p-1.5">
            <button onclick="changeFilter('hoje')" id="btn-hoje" class="px-8 py-3 rounded-2xl text-xs font-black transition-all">HOJE</button>
            <button onclick="changeFilter('semana')" id="btn-semana" class="px-8 py-3 rounded-2xl text-xs font-black transition-all">SEMANA</button>
            <button onclick="changeFilter('mes')" id="btn-mes" class="px-8 py-3 rounded-2xl text-xs font-black transition-all">MÊS</button>
        </div>
    </header>

    <!-- GRID PRINCIPAL -->
    <main class="flex-1 flex gap-6 overflow-hidden">
        
        <!-- ESQUERDA: SEPARAÇÃO (62%) -->
        <section class="w-[62%] flex flex-col gap-6 overflow-y-auto custom-scroll pr-2">
            
            <!-- Cards de Métricas -->
            <div class="grid grid-cols-2 gap-6">
                <div class="glass p-8 flex justify-between items-center border-l-8 border-blue-600">
                    <div>
                        <p class="text-slate-500 text-xs font-black uppercase mb-1">Pedidos Totais</p>
                        <h2 id="global-total" class="text-7xl font-black">0</h2>
                    </div>
                    <i class="fas fa-boxes-packing text-blue-500/10 text-6xl"></i>
                </div>
                <div class="glass p-8 flex justify-between items-center border-l-8 border-emerald-500">
                    <div>
                        <p class="text-slate-500 text-xs font-black uppercase mb-1">Média Equipe</p>
                        <h2 id="global-avg" class="text-7xl font-black">0</h2>
                    </div>
                    <i class="fas fa-chart-line text-emerald-500/10 text-6xl"></i>
                </div>
            </div>

            <!-- Centro: Gráfico e Podium -->
            <div class="grid grid-cols-2 gap-6">
                <div class="glass p-8 flex flex-col items-center justify-center">
                    <h3 class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest">Participação (%)</h3>
                    <div style="height: 240px; width: 240px;"><canvas id="teamChart"></canvas></div>
                </div>
                <div class="glass p-8 flex flex-col items-center justify-center">
                    <h3 class="text-[10px] font-black text-slate-500 uppercase mb-8 tracking-widest">Top Performance</h3>
                    <div id="podium-area" class="flex justify-around items-end w-full gap-2"></div>
                </div>
            </div>

            <!-- Ranking Table -->
            <div class="glass overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-white/5 text-slate-500 text-[10px] uppercase font-black">
                        <tr>
                            <th class="px-8 py-5">Rank</th>
                            <th class="px-8 py-5">Colaborador</th>
                            <th class="px-8 py-5 text-center">Pedidos</th>
                            <th class="px-8 py-5 text-center">Desempenho</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body" class="divide-y divide-white/5 font-bold text-sm"></tbody>
                </table>
            </div>
        </section>

        <!-- DIREITA: REPOSIÇÃO ER (38%) -->
        <section class="w-[38%] flex flex-col glass overflow-hidden">
            <div class="p-8 border-b border-white/5 bg-white/5 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-black uppercase italic tracking-tighter">Reposição <span class="text-blue-500">ER</span></h2>
                    <p id="repo-count" class="text-[10px] text-blue-400 font-bold uppercase tracking-widest mt-1">Carregando...</p>
                </div>
                <button onclick="copyRepoList()" class="bg-blue-600 hover:bg-blue-500 text-white w-12 h-12 rounded-2xl transition-all shadow-lg flex items-center justify-center">
                    <i class="fas fa-copy text-lg"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll p-6 space-y-4" id="repo-list">
                <!-- Itens da lista -->
            </div>
        </section>
    </main>

    <script>
        const API_IMGBB = "6161a9db426f51baa788f0823269c981";
        const CONFIG = {
            separacao: { id: '1CInfRwxUS7nMFWqzYaQIoQyUGq76RULk-XMp6cASVRg', aba: 'Separação - FEV/26' },
            reposicao: { id: '1pQD4qViThkVjxsbFj8yrG7p2wdW0vuo_197hKVtvTRY', aba: 'REPOSIÇÃO DEZ/25' }
        };

        let currentFilter = 'hoje';
        let timer = 0;
        let chartInstance = null;
        let dataSeparacao = [];
        let dataReposicao = [];
        let uploadTarget = null;

        // SISTEMA DE FOTOS (EXCLUSIVO SEPARAÇÃO)
        function getAvatar(name, sizeClass, borderClass = "") {
            const photo = localStorage.getItem('opx_p_' + name);
            const content = photo 
                ? `<img src="${photo}" class="avatar-box">` 
                : `<div class="avatar-box">${name.charAt(0).toUpperCase()}</div>`;
            return `<div class="${sizeClass} ${borderClass} p-1" onclick="triggerUpload('${name}')">${content}</div>`;
        }

        function triggerUpload(name) {
            uploadTarget = name;
            document.getElementById('photo-upload').click();
        }

        document.getElementById('photo-upload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file || !uploadTarget) return;
            const formData = new FormData();
            formData.append('image', file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${API_IMGBB}`, { method: 'POST', body: formData });
                const json = await res.json();
                if (json.success) {
                    localStorage.setItem('opx_p_' + uploadTarget, json.data.url);
                    renderSeparacao();
                }
            } catch (err) { alert("Erro ao carregar"); }
        });

        // BUSCA DE DADOS
        async function fetchData() {
            try {
                const res = await fetch(`https://opensheet.elk.sh/${CONFIG.reposicao.id}/${encodeURIComponent(CONFIG.reposicao.aba)}`);
                const json = await res.json();
                dataReposicao = json.filter(item => {
                    const keys = Object.keys(item);
                    const sitCol = keys.find(k => /situa|separa|status|ok/i.test(k));
                    const codCol = keys.find(k => /cód|cod|part/i.test(k));
                    return (item[codCol] || '').trim() !== "" && (item[sitCol] || '').trim() === "";
                });
                renderReposicao();
            } catch (e) { console.error("Erro ER"); }

            const script = document.createElement('script');
            script.src = `https://docs.google.com/spreadsheets/d/${CONFIG.separacao.id}/gviz/tq?tqx=responseHandler:processSep&sheet=${encodeURIComponent(CONFIG.separacao.aba)}`;
            document.body.appendChild(script);
        }

        window.processSep = function(response) {
            const rows = response.table.rows;
            dataSeparacao = rows.map(row => ({
                data: row.c[0] ? (row.c[0].f || "") : "", 
                nome: row.c[2] ? row.c[2].v : "",         
                qtd: row.c[3] ? row.c[3].v : 0           
            })).filter(r => r.nome && r.nome !== "Estoquista");
            renderSeparacao();
        };

        function renderSeparacao() {
            const now = new Date();
            const todayStr = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}`;
            const summary = {};
            dataSeparacao.forEach(item => {
                if (currentFilter === 'hoje' && !String(item.data).includes(todayStr)) return;
                summary[item.nome] = (summary[item.nome] || 0) + item.qtd;
            });

            const stats = Object.entries(summary).map(([nome, pedidos]) => ({
                nome, pedidos, color: `hsl(${Math.abs(nome.length * 85) % 360}, 65%, 50%)`
            })).sort((a, b) => b.pedidos - a.pedidos);

            const total = stats.reduce((acc, s) => acc + s.pedidos, 0);
            const media = stats.length > 0 ? Math.round(total / stats.length) : 0;

            document.getElementById('global-total').innerText = total;
            document.getElementById('global-avg').innerText = media;

            // Filtros Estilo
            document.querySelectorAll('header button').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
            document.getElementById(`btn-${currentFilter}`).classList.add('bg-blue-600', 'text-white');

            // Podium
            const podium = document.getElementById('podium-area');
            if(stats.length > 0) {
                const [p1, p2, p3] = stats;
                podium.innerHTML = `
                    <div class="flex flex-col items-center order-2 animate">
                        ${getAvatar(p2?.nome || '', "w-20 h-20", "p-silver")}
                        <p class="text-[9px] font-black mt-2 text-slate-400 uppercase tracking-widest">${p2?.nome || ''}</p>
                        <p class="text-2xl font-black">${p2?.pedidos || 0}</p>
                    </div>
                    <div class="flex flex-col items-center order-1 mb-6 animate">
                        <i class="fas fa-crown text-yellow-500 text-sm mb-1"></i>
                        ${getAvatar(p1.nome, "w-28 h-28", "p-gold")}
                        <p class="text-xs font-black mt-2 text-yellow-500 uppercase tracking-widest">${p1.nome}</p>
                        <p class="text-5xl font-black">${p1.pedidos}</p>
                    </div>
                    <div class="flex flex-col items-center order-3 animate">
                        ${getAvatar(p3?.nome || '', "w-16 h-16", "p-bronze")}
                        <p class="text-[9px] font-black mt-2 text-slate-400 uppercase tracking-widest">${p3?.nome || ''}</p>
                        <p class="text-2xl font-black">${p3?.pedidos || 0}</p>
                    </div>`;
            }

            // Tabela
            const tbody = document.getElementById('ranking-body');
            tbody.innerHTML = stats.map((s, i) => `
                <tr class="hover:bg-white/5 transition-all animate">
                    <td class="px-8 py-4 font-black text-slate-700 italic text-xl">#${i + 1}</td>
                    <td class="px-8 py-4 flex items-center gap-4">
                        ${getAvatar(s.nome, "w-10 h-10")}
                        <span class="font-black text-slate-200 uppercase tracking-tighter">${s.nome}</span>
                    </td>
                    <td class="px-8 py-4 text-center font-black text-blue-500 text-3xl">${s.pedidos}</td>
                    <td class="px-8 py-4 text-center font-black text-xs ${s.pedidos >= media ? 'text-emerald-500' : 'text-rose-500'}">
                        ${s.pedidos >= media ? '+' : ''}${s.pedidos - media}
                    </td>
                </tr>`).join('');

            updateChart(stats, total);
        }

        // LISTA DE REPOSIÇÃO ER
        function renderReposicao() {
            const container = document.getElementById('repo-list');
            container.innerHTML = '';
            if(dataReposicao.length === 0) {
                document.getElementById('repo-count').innerText = "0 PENDÊNCIAS";
                return;
            }
            document.getElementById('repo-count').innerText = `${dataReposicao.length} ITENS PENDENTES`;
            
            container.innerHTML = dataReposicao.map((row, i) => {
                const keys = Object.keys(row);
                const values = Object.values(row);
                const cod = row[keys.find(k => /cód|cod|part/i.test(k))] || '-';
                const qtd = row[keys.find(k => /qtd|quant/i.test(k))] || '0';
                const desc = row[keys.find(k => /desc/i.test(k))] || 'Sem descrição';
                const solic = row[keys[5]] || '---';

                return `
                <div class="glass p-6 flex justify-between items-center border-l-8 border-blue-600 animate">
                    <div class="flex-1 pr-4">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="text-[9px] font-black bg-blue-600/20 text-blue-400 px-2 py-0.5 rounded">${String(values[0]).substring(0, 5)}</span>
                            <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest italic">${solic}</span>
                        </div>
                        <h4 class="text-xl font-black text-white uppercase leading-none mb-1">${cod}</h4>
                        <p class="text-[9px] text-slate-400 font-bold uppercase truncate max-w-[200px]">${desc}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-4xl font-black text-rose-500">${qtd}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function updateChart(stats, total) {
            const ctx = document.getElementById('teamChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: stats.map(s => s.nome),
                    datasets: [{ data: stats.map(s => s.pedidos), backgroundColor: stats.map(s => s.color), borderWidth: 0 }]
                },
                options: {
                    cutout: '88%',
                    plugins: { 
                        legend: false, 
                        datalabels: { 
                            color: '#fff', 
                            font: { weight: '800', size: 10 },
                            formatter: (v) => total > 0 ? ((v / total) * 100).toFixed(0) + '%' : '' 
                        } 
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function copyRepoList() {
            const text = dataReposicao.map(item => {
                const keys = Object.keys(item);
                const cod = String(item[keys.find(k => /cód|cod|part/i.test(k))] || '').trim();
                const qtd = String(item[keys.find(k => /qtd|quant/i.test(k))] || '0').trim();
                return `${cod} | ${qtd}`;
            }).join('\n');
            navigator.clipboard.writeText(text).then(() => alert("Copiado!"));
        }

        function changeFilter(f) { currentFilter = f; timer = 0; renderSeparacao(); }

        setInterval(() => {
            timer += 0.25;
            document.getElementById('timer-bar').style.width = timer + '%';
            if (timer >= 100) {
                timer = 0;
                const filters = ['hoje', 'semana', 'mes'];
                changeFilter(filters[(filters.indexOf(currentFilter) + 1) % 3]);
            }
        }, 100);

        setInterval(fetchData, 60000);
        fetchData();
        Chart.register(ChartDataLabels);
    </script>
</body>
</html>
