<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZK47 PRO | Enterprise Logistics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap');
        
        :root { --primary: #fbbf24; --bg-deep: #020617; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-deep); color: #f1f5f9; min-height: 100vh; overflow-x: hidden; }

        .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; }
        .input-field { background: #020617; border: 2px solid #1e293b; color: white; font-family: 'JetBrains Mono', monospace; border-radius: 0.75rem; text-align: center; }
        .tab-active { background: var(--primary); color: #000; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); }

        .row-divider { border-bottom: 1px solid rgba(51, 65, 85, 0.5); }

        @media print {
            @page { margin: 0.4cm; }
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; padding: 0 !important; }
            .glass-panel { border: none !important; background: white !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
            table { width: 100% !important; border-collapse: collapse !important; }
            .row-divider { border-bottom: 1px solid #000 !important; page-break-inside: avoid; }
            td { padding: 4px 2px !important; line-height: 1.1 !important; border-bottom: 0.5px solid #000; }
            
            .print-address { font-weight: 800 !important; font-size: 11pt !important; color: black !important; display: block; letter-spacing: -0.5px; }
            .print-code { font-size: 10pt !important; font-family: 'JetBrains Mono', monospace !important; font-weight: 700 !important; }
            .print-name { font-size: 9pt !important; font-weight: 600 !important; text-transform: uppercase; }
            .print-qty { font-size: 16pt !important; font-weight: 900 !important; border: 2px solid black !important; padding: 0 8px !important; display: inline-block; }
            .header-print { border-bottom: 3px solid black !important; margin-bottom: 10px !important; display: flex !important; justify-content: space-between !important; align-items: center; }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="p-4">

    <div id="loader" class="fixed inset-0 z-[100] bg-slate-950/90 backdrop-blur-md flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-amber-500 font-bold uppercase text-xs tracking-widest">Sincronização em Tempo Real...</p>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-amber-500 text-slate-950 px-8 py-4 rounded-2xl font-black text-sm opacity-0 transition-all duration-300 z-[9999] shadow-2xl text-center"><span></span></div>

    <div class="max-w-7xl mx-auto space-y-4">
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 no-print">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-amber-500 rounded-lg flex items-center justify-center shadow-lg"><i class="fa-solid fa-bolt text-slate-950 text-xl"></i></div>
                <div>
                    <h1 class="text-lg font-black uppercase tracking-tighter text-white leading-none">ZK47 <span class="text-amber-500 font-light">PRO</span></h1>
                    <span class="text-[8px] text-emerald-500 font-bold uppercase tracking-widest flex items-center gap-1 mt-1">
                        <i class="fa-solid fa-circle text-[5px] animate-pulse"></i> Base Master Sincronizada
                    </span>
                </div>
            </div>
            <div class="flex gap-2">
                <label class="bg-slate-800 text-slate-100 px-6 py-3 rounded-xl text-[11px] font-black uppercase cursor-pointer border border-slate-700 hover:bg-slate-700 transition-all flex items-center gap-2 shadow-lg">
                    <i class="fa-solid fa-cloud-arrow-up text-amber-500"></i> Atualizar Base Master
                    <input type="file" class="hidden" onchange="App.handleFileUpload(this)">
                </label>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-4 no-print">
                <section class="glass-panel p-5">
                    <div class="flex p-1 bg-slate-950 rounded-xl mb-4 border border-slate-800">
                        <button id="tabEti" onclick="App.setMode('etiqueta')" class="flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase transition-all tab-active">Etiquetas</button>
                        <button id="tabSep" onclick="App.setMode('separacao')" class="flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase transition-all text-slate-500">Separação</button>
                    </div>

                    <div id="etiquetaView" class="space-y-4">
                        <input type="text" id="mainCode" class="input-field w-full px-4 py-4 text-md font-bold" placeholder="Bipar Código..." onfocus="App.setActiveInput(this)" oninput="App.updateSearch(this.value)">
                        <div id="liveAddress" class="grid grid-cols-4 gap-1 opacity-0 transition-opacity">
                            <div class="bg-slate-950 p-1 rounded border border-slate-800 text-center"><span class="block text-[6px] text-slate-500 uppercase">Rua</span><span id="lRua" class="text-[10px] font-bold text-white">-</span></div>
                            <div class="bg-slate-950 p-1 rounded border border-slate-800 text-center"><span class="block text-[6px] text-slate-500 uppercase">Rack</span><span id="lRack" class="text-[10px] font-bold text-white">-</span></div>
                            <div class="bg-slate-950 p-1 rounded border border-slate-800 text-center"><span class="block text-[6px] text-slate-500 uppercase">Lin</span><span id="lLin" class="text-[10px] font-bold text-white">-</span></div>
                            <div class="bg-slate-950 p-1 rounded border border-slate-800 text-center"><span class="block text-[6px] text-slate-500 uppercase">Col</span><span id="lCol" class="text-[10px] font-bold text-white">-</span></div>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <input type="text" id="valDate" class="input-field w-full p-2 text-xs" placeholder="Validade" onfocus="App.setActiveInput(this); App.setCurrentDate(this);">
                            <input type="text" id="valQtyEtq" class="input-field w-full p-2 text-xs" value="1" onfocus="App.setActiveInput(this)">
                            <input type="text" id="valQtyItens" class="input-field w-full p-2 text-xs" placeholder="Itens" onfocus="App.setActiveInput(this)">
                        </div>
                        <button onclick="App.addItemToQueue()" class="w-full bg-amber-500 text-slate-950 py-4 rounded-xl text-xs font-black uppercase shadow-lg hover:brightness-110 transition-all">Adicionar à Fila</button>
                    </div>

                    <div id="separacaoView" class="hidden space-y-4">
                        <textarea id="bulkList" class="bg-slate-950 border border-slate-800 w-full h-32 p-3 text-xs font-mono rounded-xl text-slate-300 outline-none" placeholder="Código | Quantidade..."></textarea>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="App.processBulkSeparation()" class="bg-blue-600 text-white py-4 rounded-xl text-xs font-black uppercase">Gerar Lista</button>
                            <button onclick="window.print()" class="bg-white text-slate-900 py-4 rounded-xl text-xs font-black uppercase"><i class="fa-solid fa-print"></i> Imprimir</button>
                        </div>
                    </div>
                </section>
                <section id="keyboard" class="grid grid-cols-3 gap-1.5 bg-slate-900/40 p-3 rounded-3xl border border-slate-800/50 no-print"></section>
            </div>

            <div class="lg:col-span-8">
                <section class="glass-panel p-5 min-h-[600px] flex flex-col text-white">
                    <div class="hidden print:flex header-print">
                        <h1 class="text-xl font-black uppercase tracking-tighter">Checklist de Separação</h1>
                        <div class="text-right text-[10px] font-bold">
                            <p>Data: <span id="pDate"></span></p>
                            <p>Total Itens: <span id="pTotal"></span></p>
                        </div>
                    </div>
                    <div class="flex-grow">
                        <table class="w-full text-left">
                            <tbody id="mainTableBody"></tbody>
                        </table>
                    </div>
                    <div id="footerActions" class="mt-4 no-print border-t border-slate-800 pt-4 flex justify-between items-center px-2">
                        <span id="footerInfo" class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Sincronizado</span>
                        <button onclick="App.clearCurrentCollection()" class="text-rose-500 text-[10px] font-black uppercase flex items-center gap-1">
                            <i class="fa-solid fa-trash-can"></i> Limpar Lista
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCiy4DOVPYYr_UtglmnVWUdZ8SqM26Neo8",
            authDomain: "zpl47-f751d.firebaseapp.com",
            projectId: "zpl47-f751d",
            databaseURL: "https://zpl47-f751d-default-rtdb.firebaseio.com"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.App = {
            inventory: [],
            mode: 'etiqueta',
            activeInput: null,

            findProduct(code) {
                if (!code) return null;
                const searchCode = String(code).trim();
                const cleanedSearch = this.cleanId(searchCode);
                return this.inventory.find(i => String(i.COD).trim() === searchCode || this.cleanId(i.COD) === cleanedSearch);
            },

            cleanId(code) {
                if (!code) return '';
                const str = String(code).replace(/\D/g, '');
                return str.length === 13 ? str.substring(7, 12) : str;
            },

            // LIMPEZA DE COORDENADAS: Remove RUA, RACK, RCK e R do início para não duplicar
            formatCoord(val) {
                let s = String(val || '').trim();
                return s.replace(/^(rua|rack|rck|r)\s*/gi, '').trim();
            },

            normalizeProduct(p) {
                if (!p) return null;
                return {
                    COD: String(p.COD || p.codigo || '').trim(),
                    NOM: String(p.NOM || p.nome || p.descricao || 'S/N').trim(),
                    RUA: this.formatCoord(p.RUA || p.rua),
                    RCK: this.formatCoord(p.RCK || p.rack),
                    LIN: String(p.LIN || p.linha || '?').trim(),
                    COL: String(p.COL || p.coluna || '?').trim(),
                    QTD_ESTOQUE: String(p.QTD_ESTOQUE || p.qtd_estoque || '0').trim()
                };
            },

            setCurrentDate(input) {
                const now = new Date();
                input.value = `${String(now.getMonth() + 1).padStart(2, '0')}${now.getFullYear()}`;
            },

            listenMasterProducts() {
                onValue(ref(db, "master_products"), (snap) => {
                    this.inventory = snap.exists() ? Object.values(snap.val()).map(p => this.normalizeProduct(p)) : [];
                });
            },

            attachListener() {
                const path = this.mode === 'etiqueta' ? "print_queue" : "active_separation";
                onValue(ref(db, path), (snap) => {
                    const data = snap.val();
                    if (this.mode === 'etiqueta') this.renderQueue(data); else this.renderSeparation(data);
                    if(data) document.getElementById('pTotal').textContent = Object.keys(data).length;
                });
            },

            renderQueue(data) {
                const items = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
                const body = document.getElementById('mainTableBody');
                body.innerHTML = items.map(i => `
                    <tr class="row-divider">
                        <td class="py-3 px-2">
                            <span class="text-[10px] text-amber-500 font-bold font-mono uppercase">${i.codigo_barras}</span>
                            <p class="text-sm font-bold text-white uppercase truncate">${i.tempName}</p>
                        </td>
                        <td class="text-right py-3 px-2">
                            <button onclick="App.deleteItem('${i.id}')" class="text-rose-500 hover:text-white transition-all w-8 h-8 rounded-lg hover:bg-rose-500/20"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('footerActions').innerHTML = `
                    <div class="grid grid-cols-2 gap-3 w-full">
                        <button onclick="App.generateZPL('download')" class="bg-amber-500 text-slate-950 py-3 rounded-xl text-[10px] font-black uppercase transition-all">Baixar ZPL</button>
                        <button onclick="App.generateZPL('copy')" class="bg-slate-800 text-amber-500 py-3 rounded-xl text-[10px] font-black uppercase border border-amber-500/30 transition-all">Copiar ZPL</button>
                    </div>
                `;
            },

            renderSeparation(data) {
                let items = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
                const collator = new Intl.Collator('pt', { numeric: true });
                const body = document.getElementById('mainTableBody');
                body.innerHTML = items.sort((a,b) => {
                    const mA = this.findProduct(a.code) || a;
                    const mB = this.findProduct(b.code) || b;
                    return collator.compare((mA.RUA||'')+(mA.RCK||'')+(mA.LIN||''), (mB.RUA||'')+(mB.RCK||'')+(mB.LIN||''));
                }).map(i => {
                    const master = this.findProduct(i.code) || i;
                    const isDone = i.status === 'done';
                    const displayAddr = `R ${this.formatCoord(master.RUA)} | R ${this.formatCoord(master.RCK)} | ${master.LIN}/${master.COL}`;
                    return `
                    <tr class="row-divider ${isDone ? 'opacity-20' : ''} hover:bg-slate-900/30 transition-all">
                        <td class="py-3 px-1">
                            <div class="print-address text-amber-500 uppercase font-black tracking-tighter text-[13px]">${displayAddr}</div>
                            <div class="mt-1">
                                <span class="print-code text-[14px] text-white font-mono font-bold leading-none">${i.code}</span>
                                <p class="print-name text-[11px] font-semibold text-slate-300 uppercase leading-none mt-1">
                                    ${master.NOM || i.name} 
                                    <span class="no-print text-[9px] font-black text-blue-400 ml-2 uppercase">EST: ${master.QTD_ESTOQUE || 0}</span>
                                </p>
                            </div>
                        </td>
                        <td class="text-center py-2 no-print w-20">
                            <div onclick="App.editQuantity('${i.id}', '${i.qty}')" class="cursor-pointer">
                                <span class="text-xl font-black text-amber-500 bg-amber-500/10 px-3 py-1 rounded-lg block">${i.qty || 1}</span>
                                <span class="text-[7px] text-slate-500 font-bold uppercase mt-1 block">Pedir</span>
                            </div>
                        </td>
                        <td class="hidden print:table-cell text-center py-2 w-20"><span class="print-qty">${i.qty || 1}</span></td>
                        <td class="text-right py-2 px-1 no-print w-16">
                            <button onclick="App.toggleStatus('${i.id}', '${i.status}')" class="w-11 h-11 rounded-xl border border-slate-700 ${isDone ? 'bg-emerald-500 border-emerald-500 text-slate-950 shadow-lg shadow-emerald-500/20' : 'text-slate-600'} transition-all flex items-center justify-center">
                                <i class="fa-solid fa-check text-xl"></i>
                            </button>
                        </td>
                    </tr>
                `}).join('');
            },

            updateSearch(val) {
                const prod = this.findProduct(val);
                const live = document.getElementById('liveAddress');
                if (prod && val.length >= 5) {
                    document.getElementById('lRua').textContent = prod.RUA || "-";
                    document.getElementById('lRack').textContent = prod.RCK || "-";
                    document.getElementById('lLin').textContent = prod.LIN || "-";
                    document.getElementById('lCol').textContent = prod.COL || "-";
                    live.style.opacity = "1";
                } else { live.style.opacity = "0"; }
            },

            setMode(m) {
                this.mode = m;
                document.getElementById('tabEti').className = `flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase transition-all ${m === 'etiqueta' ? 'tab-active' : 'text-slate-500'}`;
                document.getElementById('tabSep').className = `flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase transition-all ${m === 'separacao' ? 'tab-active' : 'text-slate-500'}`;
                document.getElementById('etiquetaView').classList.toggle('hidden', m !== 'etiqueta');
                document.getElementById('separacaoView').classList.toggle('hidden', m !== 'separacao');
                this.attachListener();
            },

            async handleFileUpload(input) {
                const file = input.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    document.getElementById('loader').classList.remove('hidden');
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                    const produtos = {};
                    for (let i = 1; i < rows.length; i++) {
                        const r = rows[i]; if (!r[0]) continue;
                        produtos[r[0]] = { COD: String(r[0]), NOM: String(r[1] || 'S/N'), RUA: String(r[4] || ''), RCK: String(r[5] || ''), LIN: String(r[6] || ''), COL: String(r[7] || ''), QTD_ESTOQUE: String(r[10] || '0') };
                    }
                    await set(ref(db, "master_products"), produtos);
                    document.getElementById('loader').classList.add('hidden');
                    this.showToast("Base Master Atualizada!");
                    input.value = "";
                };
                reader.readAsArrayBuffer(file);
            },

            async processBulkSeparation() {
                const area = document.getElementById('bulkList');
                const lines = area.value.split('\n').filter(l => l.trim() !== '');
                if (!lines.length) return;
                document.getElementById('loader').classList.remove('hidden');
                for (let line of lines) {
                    const tokens = line.trim().split(/[\s|;,]+/);
                    const code = tokens[0];
                    let qty = 1;
                    for (let i = tokens.length - 1; i >= 0; i--) { if (!isNaN(tokens[i])) { qty = parseInt(tokens[i]); break; } }
                    await push(ref(db, "active_separation"), { code, qty: String(qty), status: 'pending' });
                }
                area.value = "";
                document.getElementById('loader').classList.add('hidden');
                this.showToast("Lista Gerada!");
            },

            async generateZPL(action) {
                const snap = await get(ref(db, "print_queue"));
                const items = snap.val() ? Object.values(snap.val()) : [];
                if (!items.length) { this.showToast("Fila Vazia!"); return; }
                let zpl = "";
                const clean = (t) => String(t || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
                for (let i = 0; i < items.length; i += 2) {
                    zpl += "^XA\n^CI28\n^PW812\n^LL1218\n";
                    [0, 600].forEach((y, idx) => {
                        const it = items[i + idx];
                        if (it) {
                            const r = it.fullData || {};
                            // MONTAGEM DO ENDEREÇO DA ETIQUETA: RUA: [VALOR] RCK: [VALOR]
                            const addrStr = `RUA: ${clean(r.RUA)} RCK: ${clean(r.RCK)}  ${clean(r.LIN)}/${clean(r.COL)}`;
                            zpl += `^FO20,${y+20}^A0N,110,100^FD${this.cleanId(it.codigo_barras)}^FS\n`;
                            if (it.validade) zpl += `^FO235,${y+10}^GB550,70,80^FS\n^FO250,${y+20}^A0N,105,100^FR^FDVAL: ${clean(it.validade)}^FS\n`;
                            zpl += `^FO20,${y+150}^A0N,60,60^FB770,2,0,L,0^FD${clean(it.tempName)}^FS\n`;
                            zpl += `^FO20,${y+320}^A0N,45,45^FD${addrStr}^FS\n`;
                            if (it.qtdItens) zpl += `^FO580,${y+320}^A0N,80,80^FDQ:${it.qtdItens}^FS\n`;
                            zpl += `^BY3,3,180^FO60,${y+380}^BCN,180,Y,N,N^FD${it.codigo_barras}^FS\n`;
                        }
                    });
                    zpl += "^XZ\n";
                }
                if (action === 'copy') { await navigator.clipboard.writeText(zpl); this.showToast("ZPL Copiado!"); }
                else { const blob = new Blob([zpl], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Labels_${Date.now()}.zpl`; a.click(); }
                await remove(ref(db, "print_queue"));
            },

            async deleteItem(id) { await remove(ref(db, (this.mode === 'etiqueta' ? 'print_queue' : 'active_separation') + '/' + id)); },
            async toggleStatus(id, s) { await set(ref(db, `active_separation/${id}/status`), s === 'done' ? 'pending' : 'done'); },
            async editQuantity(id, q) { const nq = prompt("Qtd:", q); if (nq && !isNaN(nq)) await update(ref(db, `active_separation/${id}`), { qty: String(nq) }); },
            async clearCurrentCollection() { if (confirm("Limpar lista?")) await remove(ref(db, this.mode === 'etiqueta' ? "print_queue" : "active_separation")); },
            async syncInventory() { const snap = await get(ref(db, "master_products")); this.inventory = snap.exists() ? Object.values(snap.val()).map(p => this.normalizeProduct(p)) : []; this.showToast("Sincronizado!"); },
            initKeyboard() {
                const kb = document.getElementById('keyboard');
                [1,2,3,4,5,6,7,8,9,'DEL',0,'CLR'].forEach(v => {
                    const btn = document.createElement('button');
                    btn.className = `h-12 rounded-xl font-bold text-md transition-all ${v === 'DEL' ? 'bg-rose-500/10 text-rose-500' : (v === 'CLR' ? 'bg-amber-500 text-slate-950' : 'bg-slate-950 text-white border border-slate-800')}`;
                    btn.textContent = v;
                    btn.onclick = () => { if (!this.activeInput) return; if (v === 'DEL') this.activeInput.value = this.activeInput.value.slice(0,-1); else if (v === 'CLR') this.activeInput.value = ""; else this.activeInput.value += v; if(this.activeInput.id === 'mainCode') this.updateSearch(this.activeInput.value); };
                    kb.appendChild(btn);
                });
            },
            setActiveInput(el) { this.activeInput = el; document.querySelectorAll('.input-field').forEach(i => i.classList.remove('ring-2', 'ring-amber-500')); el.classList.add('ring-2', 'ring-amber-500'); },
            showToast(msg) { const t = document.getElementById('toast'); t.querySelector('span').textContent = msg; t.classList.remove('opacity-0'); setTimeout(() => t.classList.add('opacity-0'), 2500); },
            async addItemToQueue() {
                const val = document.getElementById('mainCode').value; if (!val) return;
                const p = this.findProduct(val) || { NOM: "AVULSO", COD: val };
                const qEtq = parseInt(document.getElementById('valQtyEtq').value) || 1;
                for (let i = 0; i < qEtq; i++) { await push(ref(db, "print_queue"), { codigo_barras: val, validade: document.getElementById('valDate').value, qtdItens: document.getElementById('valQtyItens').value, tempName: p.NOM, fullData: this.normalizeProduct(p) }); }
                document.getElementById('mainCode').value = ""; this.showToast("Item Adicionado!");
            }
        };

        window.addEventListener('DOMContentLoaded', () => { App.initKeyboard(); App.listenMasterProducts(); App.setMode('etiqueta'); });
    </script>
</body>
</html>