<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZPL ZK47 PRO | Dev. Benilson Amorim</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        :root { --gold: #FFD700; --bg: #010409; }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: #f8fafc; overflow-x: hidden; background-image: radial-gradient(circle at 50% -20%, #443308 0%, transparent 50%); }
        .glass { background: #0d1117; border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 1.5rem; padding: 1.2rem; }
        .input-pro { background: #000; border: 1px solid #30363d; color: white; outline: none; font-family: 'JetBrains Mono', monospace; border-radius: 12px; padding: 12px; width: 100%; font-size: 1.2rem; font-weight: bold; text-align: center; }
        .input-pro:focus { border-color: var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); }
        .input-active { border-color: var(--gold) !important; background: #1a1608 !important; }
        
        .btn-primary { background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); border-radius: 14px; font-weight: 800; text-transform: uppercase; color: #000; padding: 14px; width: 100%; cursor: pointer; border: none; }
        .btn-primary:active { transform: scale(0.95); }

        .app-kb { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; background: #0d1117; padding: 12px; border-radius: 20px; border: 1px solid #443308; }
        .kb-key { background: #161b22; border: 1px solid #30363d; padding: 15px; border-radius: 12px; text-align: center; font-weight: 800; font-size: 1.4rem; color: #fff; cursor: pointer; user-select: none; }
        .kb-key:active { background: var(--gold); color: #000; }
        .kb-key-action { background: #B8860B; color: #000; }

        .tab-btn { flex: 1; padding: 10px; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #64748b; cursor: pointer; border-radius: 8px; }
        .tab-btn.active { background-color: var(--gold); color: #000; }

        .location-card { background: #0d1117; border: 2px solid #FFD700; border-radius: 20px; }
    </style>
</head>
<body class="min-h-screen p-2 flex flex-col items-center">

    <div id="loader" class="fixed inset-0 z-[100] bg-black/90 flex flex-col items-center justify-center hidden">
        <div class="w-12 h-12 border-4 border-yellow-900/30 border-t-yellow-500 rounded-full animate-spin"></div>
        <p class="text-yellow-500 mt-4 font-bold text-xs uppercase">Processando...</p>
    </div>

    <div id="toast" class="fixed top-4 right-4 bg-yellow-500 text-black px-6 py-3 rounded-xl font-black uppercase text-xs shadow-2xl opacity-0 transition-all duration-300 z-[9999]">
        <span>Mensagem</span>
    </div>

    <div class="w-full max-w-4xl space-y-4">
        
        <header class="flex flex-col items-center gap-4 glass p-6 rounded-[2.5rem]">
            <i class="fa-solid fa-qrcode text-yellow-500 text-3xl"></i>
            <div class="flex gap-2">
                <button onclick="window.loadFromCloud()" class="bg-yellow-900/20 text-yellow-500 px-4 py-2 rounded-xl text-[10px] font-black border border-yellow-800 uppercase">Sincronizar Nuvem</button>
                <label class="bg-slate-800 text-slate-400 px-4 py-2 rounded-xl text-[10px] font-black border border-slate-700 uppercase cursor-pointer">
                    Importar Excel <input type="file" id="excelInput" class="hidden" onchange="window.handleFileUpload(this)" accept=".xlsx, .xls">
                </label>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-4">
            <div class="lg:col-span-5 space-y-4">
                <section class="glass p-5 rounded-[2rem]">
                    <div class="flex p-1 bg-slate-900 rounded-xl mb-6 border border-slate-800">
                        <button onclick="window.setMode('validade')" id="tabVal" class="tab-btn active">Validade</button>
                        <button onclick="window.setMode('endereco')" id="tabEnd" class="tab-btn">Endereço</button>
                    </div>

                    <div class="space-y-4">
                        <input type="text" id="mainCode" class="input-pro" placeholder="DIGITE O CÓDIGO" inputmode="none" onfocus="window.setActiveInput(this)" oninput="window.updateSearch(this.value)">
                        
                        <div id="locationInfo" class="location-card p-4 hidden">
                            <div id="previewName" class="text-center font-black text-yellow-500 uppercase mb-2 text-xs"></div>
                            <div class="grid grid-cols-2 gap-2 text-[10px] text-white">
                                <div class="bg-black/40 p-2 rounded">RUA: <span id="infoRua">-</span></div>
                                <div class="bg-black/40 p-2 rounded">RACK: <span id="infoRack">-</span></div>
                                <div class="bg-black/40 p-2 rounded">LINHA: <span id="infoLinha">-</span></div>
                                <div class="bg-black/40 p-2 rounded">COL: <span id="infoColuna">-</span></div>
                            </div>
                        </div>

                        <div id="valRow" class="grid grid-cols-2 gap-3">
                            <input type="text" id="valDate" class="input-pro text-sm" placeholder="MMAAAA" onfocus="window.setActiveInput(this)">
                            <input type="text" id="valQtyEtq" class="input-pro text-sm" value="1" onfocus="window.setActiveInput(this)">
                        </div>

                        <button onclick="window.addItem()" class="btn-primary">Adicionar à Fila</button>
                    </div>
                </section>

                <section class="app-kb">
                    <button onclick="window.pressKey('1')" class="kb-key">1</button>
                    <button onclick="window.pressKey('2')" class="kb-key">2</button>
                    <button onclick="window.pressKey('3')" class="kb-key">3</button>
                    <button onclick="window.pressKey('4')" class="kb-key">4</button>
                    <button onclick="window.pressKey('5')" class="kb-key">5</button>
                    <button onclick="window.pressKey('6')" class="kb-key">6</button>
                    <button onclick="window.pressKey('7')" class="kb-key">7</button>
                    <button onclick="window.pressKey('8')" class="kb-key">8</button>
                    <button onclick="window.pressKey('9')" class="kb-key">9</button>
                    <button onclick="window.backspace()" class="kb-key kb-key-action"><i class="fa-solid fa-delete-left"></i></button>
                    <button onclick="window.pressKey('0')" class="kb-key">0</button>
                    <button onclick="window.clearInput()" class="kb-key kb-key-action"><i class="fa-solid fa-trash"></i></button>
                </section>
            </div>

            <div class="lg:col-span-7 space-y-4">
                <section class="glass p-6 min-h-[400px]">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs font-black uppercase tracking-widest">Fila (<span id="queueBadge">0</span>)</span>
                        <button onclick="window.clearQueue()" class="text-red-500 text-[10px] font-black">LIMPAR</button>
                    </div>
                    <div class="overflow-y-auto max-h-[300px]">
                        <table class="w-full text-xs text-left">
                            <tbody id="queueTable" class="divide-y divide-yellow-900/10"></tbody>
                        </table>
                    </div>
                    <button onclick="window.generateZPL()" class="w-full bg-yellow-500 text-black font-black py-4 mt-4 rounded-xl uppercase">Gerar Etiquetas ZPL</button>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIGURAÇÃO FIREBASE (ATUALIZADA)
        const firebaseConfig = {
            apiKey: "AIzaSyCiy4DOVPYYr_UtglmnVWUdZ8SqM26Neo8",
            authDomain: "zpl47-f751d.firebaseapp.com",
            databaseURL: "https://zpl47-f751d-default-rtdb.firebaseio.com",
            projectId: "zpl47-f751d",
            storageBucket: "zpl47-f751d.firebasestorage.app",
            messagingSenderId: "919369222408",
            appId: "1:919369222408:web:7dbe2f87af81e3f22784bd",
            measurementId: "G-50VR9BSRTX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const productsRef = ref(db, "master_products");
        const queueRef = ref(db, "print_queue");

        window.inventory = [];
        window.activeInput = null;
        window.mode = 'validade';

        // Lógica de Identificador (5 dígitos)
        const getSearchKey = (val) => {
            const clean = String(val).replace(/\D/g, '');
            if (clean.length === 13) return clean.substring(7, 12);
            return clean;
        };

        // CARREGAR DADOS DO FIREBASE
        window.loadFromCloud = async () => {
            document.getElementById('loader').classList.remove('hidden');
            try {
                const snap = await get(productsRef);
                window.inventory = snap.exists() ? Object.values(snap.val()) : [];
                window.showToast("Nuvem Sincronizada: " + window.inventory.length + " itens");
            } catch (err) {
                alert("Erro ao conectar: Verifique as regras do banco!");
            }
            document.getElementById('loader').classList.add('hidden');
        };

        // IMPORTAR EXCEL (MAPEADO PELAS COLUNAS A, B, E, F, G, H)
        window.handleFileUpload = (input) => {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('loader').classList.remove('hidden');
            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    // Lê a primeira aba usando cabeçalhos por letra (A, B, C...)
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: "A" });
                    
                    const master = {};
                    json.forEach((row, index) => {
                        // Ignora a primeira linha se for cabeçalho
                        if (index === 0) return;

                        const cod = String(row.A || "").trim();
                        if (cod) {
                            master[cod] = {
                                COD: cod,
                                NOM: String(row.B || "SEM NOME").toUpperCase(),
                                RUA: String(row.E || ""),
                                RCK: String(row.F || ""),
                                LIN: String(row.G || ""),
                                COL: String(row.H || "")
                            };
                        }
                    });

                    await set(productsRef, master);
                    window.loadFromCloud();
                    window.showToast("Importação Concluída!");
                } catch (err) {
                    alert("Erro no processamento do Excel: " + err.message);
                } finally {
                    document.getElementById('loader').classList.add('hidden');
                    input.value = "";
                }
            };
            reader.readAsArrayBuffer(file);
        };

        // BUSCA DE PRODUTO EM TEMPO REAL
        window.updateSearch = (val) => {
            if (val.length < 3) {
                document.getElementById('locationInfo').classList.add('hidden');
                return;
            }

            const searchKey = getSearchKey(val);
            const prod = window.inventory.find(i => String(i.COD).includes(searchKey));
            
            const infoBox = document.getElementById('locationInfo');
            if (prod) {
                document.getElementById('previewName').textContent = prod.NOM;
                document.getElementById('infoRua').textContent = prod.RUA || "-";
                document.getElementById('infoRack').textContent = prod.RCK || "-";
                document.getElementById('infoLinha').textContent = prod.LIN || "-";
                document.getElementById('infoColuna').textContent = prod.COL || "-";
                infoBox.classList.remove('hidden');
            } else {
                document.getElementById('previewName').textContent = "NÃO ENCONTRADO";
                infoBox.classList.add('hidden');
            }
        };

        // ADICIONAR À FILA
        window.addItem = async () => {
            const val = document.getElementById('mainCode').value;
            if (!val) return;

            const searchKey = getSearchKey(val);
            const prod = window.inventory.find(i => String(i.COD).includes(searchKey)) || { NOM: "PRODUTO AVULSO", COD: val };
            
            const qty = parseInt(document.getElementById('valQtyEtq').value) || 1;
            const validade = document.getElementById('valDate').value;

            for(let i=0; i<qty; i++) {
                await push(queueRef, {
                    codigo_barras: val,
                    tempName: prod.NOM,
                    validade: window.mode === 'validade' ? validade : "",
                    fullData: prod,
                    timestamp: Date.now() + i
                });
            }
            window.showToast("Adicionado!");
            window.clearInput();
        };

        // ESCUTA A FILA DO FIREBASE
        onValue(queueRef, (snap) => {
            const data = snap.val();
            const list = data ? Object.keys(data).map(k => ({id: k, ...data[k]})) : [];
            document.getElementById('queueBadge').textContent = list.length;
            document.getElementById('queueTable').innerHTML = list.map((item, idx) => `
                <tr class="border-b border-yellow-900/10">
                    <td class="p-2 font-bold text-yellow-600">${idx+1}</td>
                    <td class="p-2"><b>${item.codigo_barras}</b><br><span class="text-[9px]">${item.tempName}</span></td>
                    <td class="p-2 text-right"><button onclick="window.removeItem('${item.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td>
                </tr>
            `).join('');
            window.currentQueueData = list;
        });

        // GERAÇÃO DE ZPL
        window.generateZPL = () => {
            const queue = window.currentQueueData;
            if (!queue || queue.length === 0) return alert("Fila vazia!");

            let zpl = "";
            for (let i = 0; i < queue.length; i += 2) {
                zpl += "^XA\n^CI28^PW812^LL1218\n";
                const draw = (item, y) => {
                    if (!item) return "";
                    const ident = getSearchKey(item.codigo_barras);
                    let s = `^FO20,${y+30}^A0N,100,90^FD${ident}^FS\n`;
                    if(item.validade) s += `^FO235,${y+20}^GB550,65,75^FS^FO250,${y+30}^A0N,95,90^FR^FDVAL: ${item.validade}^FS\n`;
                    s += `^FO20,${y+140}^A0N,60,60^FB770,2,0,L,0^FD${item.tempName.substring(0,40)}^FS\n`;
                    s += `^FO20,${y+280}^A0N,40,40^FDRUA: ${item.fullData?.RUA || ""}  RCK: ${item.fullData?.RCK || ""}^FS\n`;
                    s += `^FO20,${y+330}^A0N,40,40^FDLIN: ${item.fullData?.LIN || ""}  COL: ${item.fullData?.COL || ""}^FS\n`;
                    s += `^BY2,3,120^FO60,${y+400}^BCN,120,Y,N,N^FD${item.codigo_barras}^FS\n`;
                    return s;
                };
                zpl += draw(queue[i], 0);
                if (queue[i+1]) zpl += draw(queue[i+1], 600);
                zpl += "^XZ\n";
            }

            const blob = new Blob([zpl], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `etiquetas_${Date.now()}.zpl`;
            a.click();
            window.showToast("ZPL Baixado!");
        };

        // FUNÇÕES DE UI
        window.removeItem = (id) => remove(ref(db, `print_queue/${id}`));
        window.clearQueue = () => confirm("Limpar toda a fila?") && remove(queueRef);
        window.setActiveInput = (el) => {
            window.activeInput = el;
            document.querySelectorAll('.input-pro').forEach(i => i.classList.remove('input-active'));
            el.classList.add('input-active');
        };
        window.pressKey = (v) => {
            if(!window.activeInput) window.activeInput = document.getElementById('mainCode');
            window.activeInput.value += v;
            if(window.activeInput.id === 'mainCode') window.updateSearch(window.activeInput.value);
        };
        window.backspace = () => {
            if(!window.activeInput) return;
            window.activeInput.value = window.activeInput.value.slice(0, -1);
            if(window.activeInput.id === 'mainCode') window.updateSearch(window.activeInput.value);
        };
        window.clearInput = () => {
            if(window.activeInput) window.activeInput.value = "";
            document.getElementById('locationInfo').classList.add('hidden');
        };
        window.setMode = (m) => {
            window.mode = m;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(m==='validade'?'tabVal':'tabEnd').classList.add('active');
            document.getElementById('valRow').classList.toggle('hidden', m === 'endereco');
        };
        window.showToast = (m) => {
            const t = document.getElementById('toast');
            t.querySelector('span').textContent = m;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 2000);
        };

        // Inicialização
        window.loadFromCloud();
    </script>
</body>
</html>
