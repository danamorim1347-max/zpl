--- START OF FILE index.html ---
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZPL ZK47 PRO | Dev. Benilson Amorim</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        :root { --gold: #FFD700; --accent: #FFD700; --bg: #010409; }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: #f8fafc; overflow-x: hidden; background-image: radial-gradient(circle at 50% -20%, #443308 0%, transparent 50%); }
        .glass { background: #0d1117; border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 1.5rem; padding: 1.2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .input-pro { background: #000; border: 1px solid #30363d; color: white; outline: none; font-family: 'JetBrains Mono', monospace; border-radius: 12px; padding: 12px; width: 100%; font-size: 1.2rem; font-weight: bold; text-align: center; }
        .input-pro:focus { border-color: var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); }
        .input-active { border-color: var(--gold) !important; background: #1a1608 !important; }
        
        .btn-primary { background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); border-radius: 14px; font-weight: 800; text-transform: uppercase; color: #000; padding: 14px; width: 100%; }
        .btn-primary:active { transform: scale(0.95); }

        .app-kb { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; background: #0d1117; padding: 12px; border-radius: 20px; border: 1px solid #443308; }
        .kb-key { background: #161b22; border: 1px solid #30363d; padding: 15px; border-radius: 12px; text-align: center; font-weight: 800; font-size: 1.4rem; color: #fff; cursor: pointer; transition: 0.1s; }
        .kb-key:active { background: var(--gold); color: #000; transform: scale(0.9); }
        .kb-key-action { background: #B8860B; color: #000; }

        .location-card { background: linear-gradient(145deg, #161b22, #0d1117); border: 2px solid #FFD700; border-radius: 20px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .tab-btn { flex: 1; py: 2; font-size: 9px; font-weight: 900; text-transform: uppercase; transition: all 0.3s; color: #64748b; }
        .tab-btn.active { background-color: var(--gold); color: #000; border-radius: 8px; box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2); }

        .qty-saved-badge { background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; padding: 2px 8px; border-radius: 10px; font-size: 8px; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body class="min-h-screen p-2 md:p-6 flex flex-col items-center">

    <div id="loader" class="fixed inset-0 z-[100] bg-slate-950/98 backdrop-blur-md flex flex-col items-center justify-center hidden">
        <div class="w-16 h-16 border-4 border-yellow-900/30 border-t-yellow-500 rounded-full animate-spin"></div>
        <p id="loaderText" class="mt-4 text-yellow-500 font-black uppercase text-[10px] tracking-widest">Processando...</p>
    </div>

    <div id="toast" class="fixed top-4 right-4 bg-yellow-600 text-black px-6 py-3 rounded-xl font-black uppercase text-sm shadow-2xl opacity-0 translate-y-10 transition-all duration-300 z-[9999]">
        <span>Mensagem</span>
    </div>

    <div class="w-full max-w-4xl space-y-4 pb-20">
        
        <header class="flex flex-col items-center justify-center gap-4 glass p-6 rounded-[2.5rem]">
            <div class="w-20 h-20 bg-slate-900 border-2 border-yellow-500 flex items-center justify-center rounded-full shadow-[0_0_30px_rgba(255,215,0,0.2)]">
                <svg viewBox="0 0 100 100" class="w-12 h-12 fill-yellow-500">
                    <path d="M50,10 C30,10 15,30 15,55 C15,75 35,90 50,90 C65,90 85,75 85,55 C85,30 70,10 50,10 Z" />
                    <ellipse cx="32" cy="50" rx="12" ry="18" fill="#020617" transform="rotate(-15 32 50)" />
                    <ellipse cx="68" cy="50" rx="12" ry="18" fill="#020617" transform="rotate(15 68 50)" />
                </svg>
            </div>
            <button onclick="window.loadFromCloud()" class="bg-yellow-900/20 text-yellow-500 px-5 py-2 rounded-xl text-[10px] font-black border border-yellow-800 uppercase">
                <i class="fa-solid fa-sync"></i> Sync Nebula Cloud
            </button>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-4">
            <div class="lg:col-span-5 space-y-4">
                
                <section class="glass p-5 rounded-[2.5rem]">
                    <!-- ABAS DE NAVEGAÇÃO -->
                    <div class="flex p-1 bg-slate-900 rounded-xl mb-6 border border-slate-800">
                        <button onclick="window.setMode('validade')" id="tabVal" class="tab-btn active">Validade</button>
                        <button onclick="window.setMode('endereco')" id="tabEnd" class="tab-btn">Endereço</button>
                        <button onclick="window.setMode('localizar')" id="tabLoc" class="tab-btn">Localizar</button>
                    </div>

                    <div class="space-y-4">
                        <!-- INPUT PRINCIPAL -->
                        <div id="uiManual">
                            <div class="relative">
                                <input type="text" id="mainCode" class="input-pro" placeholder="Digite ou Escaneie..." inputmode="none" onfocus="window.setActiveInput(this)">
                                <div id="qtySavedIndicator" class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
                                    <span class="qty-saved-badge">QTY SALVA</span>
                                </div>
                            </div>
                            <div id="previewName" class="text-[10px] font-bold text-yellow-500 truncate uppercase mt-2 text-center min-h-[1.5rem]"></div>
                        </div>

                        <!-- PAINEL DE LOCALIZAÇÃO (EXCLUSIVO MODO LOCALIZAR) -->
                        <div id="locationResult" class="hidden location-card p-4 space-y-3">
                            <div class="text-center border-b border-yellow-500/20 pb-2">
                                <span class="text-yellow-500 text-[10px] font-black uppercase tracking-widest">Endereço Encontrado</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-center">
                                <div class="bg-black/40 p-2 rounded-lg">
                                    <div class="text-slate-500 text-[8px] uppercase">Rua</div>
                                    <div id="resRua" class="text-xl font-black text-white">--</div>
                                </div>
                                <div class="bg-black/40 p-2 rounded-lg">
                                    <div class="text-slate-500 text-[8px] uppercase">Rack</div>
                                    <div id="resRack" class="text-xl font-black text-white">--</div>
                                </div>
                                <div class="bg-black/40 p-2 rounded-lg">
                                    <div class="text-slate-500 text-[8px] uppercase">Linha</div>
                                    <div id="resLinha" class="text-xl font-black text-white">--</div>
                                </div>
                                <div class="bg-black/40 p-2 rounded-lg">
                                    <div class="text-slate-500 text-[8px] uppercase">Coluna</div>
                                    <div id="resColuna" class="text-xl font-black text-white">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- OPÇÕES DE VALIDADE -->
                        <div id="valRow" class="grid grid-cols-2 gap-3">
                            <input type="text" id="valDate" class="input-pro" placeholder="MMAAAA" inputmode="none" onfocus="window.setActiveInput(this)">
                            <input type="text" id="valQtyEtq" class="input-pro" value="1" inputmode="none" onfocus="window.setActiveInput(this)">
                        </div>

                        <!-- OPÇÕES DE ENDEREÇO EM MASSA -->
                        <div id="endOptions" class="hidden">
                            <div class="flex gap-2 p-1 bg-slate-800 rounded-lg mb-3">
                                <button onclick="window.switchSub('single')" id="subS" class="flex-1 py-1.5 text-[9px] font-black rounded bg-yellow-600 text-black shadow">UNICO</button>
                                <button onclick="window.switchSub('mass')" id="subM" class="flex-1 py-1.5 text-[9px] font-black rounded text-slate-500">MASSA</button>
                            </div>
                            <div id="areaMass" class="hidden">
                                <textarea id="endMassList" class="w-full input-pro h-32 text-[10px] text-left" placeholder="Cole os códigos aqui..."></textarea>
                            </div>
                        </div>

                        <!-- QUANTIDADE ITEM -->
                        <div id="qtyRow" class="flex items-center justify-between p-3 bg-slate-950/50 rounded-xl border border-yellow-900/20">
                            <span class="text-[9px] font-black text-yellow-700 uppercase">Imprimir Qtd?</span>
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="qtyToggle" checked onchange="window.toggleQtyInput()" class="w-4 h-4 accent-yellow-500">
                                <input type="text" id="qtyItm" class="w-16 input-pro text-sm py-1" value="1" inputmode="none" onfocus="window.setActiveInput(this)">
                            </div>
                        </div>

                        <button id="btnAction" onclick="window.addItem()" class="w-full btn-primary py-4 text-[11px] tracking-[4px]">ADICIONAR À FILA</button>
                    </div>
                </section>

                <!-- TECLADO NUMÉRICO -->
                <section class="app-kb">
                    <button onclick="window.pressKey('1')" class="kb-key">1</button>
                    <button onclick="window.pressKey('2')" class="kb-key">2</button>
                    <button onclick="window.pressKey('3')" class="kb-key">3</button>
                    <button onclick="window.pressKey('4')" class="kb-key">4</button>
                    <button onclick="window.pressKey('5')" class="kb-key">5</button>
                    <button onclick="window.pressKey('6')" class="kb-key">6</button>
                    <button onclick="window.pressKey('7')" class="kb-key">7</button>
                    <button onclick="window.pressKey('8')" class="kb-key">8</button>
                    <button onclick="window.pressKey('9')" class="kb-key">9</button>
                    <button onclick="window.backspace()" class="kb-key kb-key-action"><i class="fa-solid fa-delete-left"></i></button>
                    <button onclick="window.pressKey('0')" class="kb-key">0</button>
                    <button onclick="window.clearInput()" class="kb-key kb-key-action"><i class="fa-solid fa-trash-can text-sm"></i></button>
                </section>
            </div>

            <!-- FILA DE IMPRESSÃO (DIREITA) -->
            <div class="lg:col-span-7 flex flex-col h-full">
                <section class="glass p-6 rounded-[3.5rem] flex-grow flex flex-col min-h-[500px]">
                    <div class="flex justify-between items-center mb-6 border-b border-yellow-900/20 pb-4 font-black text-[10px] tracking-[2px]">
                        <div>FILA DE IMPRESSÃO (<span id="queueBadge">0</span>)</div>
                        <button onclick="window.clearQueue()" class="text-red-500 hover:text-red-400 uppercase">Limpar</button>
                    </div>
                    
                    <div class="flex-grow overflow-y-auto bg-slate-950/40 rounded-[2.5rem] h-[28rem] custom-scrollbar">
                        <table class="w-full text-left">
                            <tbody id="queueTable" class="divide-y divide-yellow-900/10 text-xs"></tbody>
                        </table>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button onclick="window.generateZPL()" class="bg-yellow-500 text-black font-black py-4 rounded-2xl uppercase tracking-widest text-[11px]">Gerar ZPL</button>
                        <button id="btnDownload" onclick="window.downloadFile()" disabled class="bg-slate-800 text-yellow-700 font-black py-4 rounded-2xl border border-yellow-900/30 uppercase text-[10px] opacity-50 cursor-not-allowed">Salvar .ZPL</button>
                    </div>
                    <textarea id="finalZPL" readonly class="mt-4 w-full h-24 bg-black text-cyan-500 font-mono text-[8px] p-4 rounded-xl border border-cyan-900/20 hidden"></textarea>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCiy4DOVPYYr_UtglmnVWUdZ8SqM26Neo8",
            authDomain: "zpl47-f751d.firebaseapp.com",
            projectId: "zpl47-f751d",
            databaseURL: "https://zpl47-f751d-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const queueRef = ref(db, "print_queue");
        const productsRef = ref(db, "master_products");

        window.inventory = [];
        window.queue = []; 
        window.activeInput = null; 
        window.mode = 'validade'; 
        window.subMode = 'single';

        // ============ LÓGICA DE LOCALIZAÇÃO ============
        
        // Função para encontrar produto pelos primeiros 5 dígitos
        window.locateProductByShortCode = (digits) => {
            if (digits.length < 5) return null;
            const search = digits.substring(0, 5); // Pega apenas os primeiros 5
            
            // Procura no inventário por um código que contenha ou termine com esses 5 dígitos (ajustado para ZK47)
            return window.inventory.find(item => {
                const cleanCod = String(item.COD).replace(/\D/g,'');
                return cleanCod.includes(search) || cleanCod.endsWith(search);
            });
        };

        window.updateLocationDisplay = (prod) => {
            const panel = document.getElementById('locationResult');
            if (prod) {
                panel.classList.remove('hidden');
                document.getElementById('resRua').textContent = prod.RUA || '--';
                document.getElementById('resRack').textContent = prod.RCK || '--';
                document.getElementById('resLinha').textContent = prod.LIN || '--';
                document.getElementById('resColuna').textContent = prod.COL || '--';
                document.getElementById('previewName').textContent = prod.NOM;
                document.getElementById('previewName').style.color = "#FFD700";
            } else {
                panel.classList.add('hidden');
                document.getElementById('previewName').textContent = "NÃO LOCALIZADO";
                document.getElementById('previewName').style.color = "#ff4444";
            }
        };

        // ============ UI E MODOS ============

        window.setMode = (m) => {
            window.mode = m;
            // Atualizar classes dos botões
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(m === 'validade') document.getElementById('tabVal').classList.add('active');
            if(m === 'endereco') document.getElementById('tabEnd').classList.add('active');
            if(m === 'localizar') document.getElementById('tabLoc').classList.add('active');

            // Mostrar/Esconder seções
            document.getElementById('valRow').classList.toggle('hidden', m !== 'validade');
            document.getElementById('endOptions').classList.toggle('hidden', m !== 'endereco');
            document.getElementById('qtyRow').classList.toggle('hidden', m === 'localizar');
            document.getElementById('btnAction').classList.toggle('hidden', m === 'localizar');
            document.getElementById('locationResult').classList.add('hidden');
            
            window.clearInput();
        };

        window.setActiveInput = (el) => {
            window.activeInput = el;
            document.querySelectorAll('.input-pro').forEach(i => i.classList.remove('input-active'));
            el.classList.add('input-active');
        };

        window.pressKey = (val) => {
            if(!window.activeInput) window.activeInput = document.getElementById('mainCode');
            
            // Lógica para data de validade
            if(window.activeInput.id === 'valDate') {
                let v = window.activeInput.value.replace(/\D/g, ''); 
                if(v.length < 6) v += val; 
                if(v.length >= 2) v = v.substring(0, 2) + '/' + v.substring(2, 6);
                window.activeInput.value = v;
                return;
            }

            window.activeInput.value += val;

            // Lógica de Busca Automática (Modo Localizar)
            if(window.mode === 'localizar' && window.activeInput.id === 'mainCode') {
                const currentVal = window.activeInput.value;
                if(currentVal.length >= 5) {
                    const prod = window.locateProductByShortCode(currentVal);
                    window.updateLocationDisplay(prod);
                }
            } else if (window.activeInput.id === 'mainCode' && window.activeInput.value.length >= 8) {
                window.handleScan(window.activeInput.value);
            }
        };

        window.backspace = () => {
            if(!window.activeInput) return;
            window.activeInput.value = window.activeInput.value.slice(0, -1);
            
            if(window.mode === 'localizar' && window.activeInput.id === 'mainCode') {
                if(window.activeInput.value.length >= 5) {
                    const prod = window.locateProductByShortCode(window.activeInput.value);
                    window.updateLocationDisplay(prod);
                } else {
                    document.getElementById('locationResult').classList.add('hidden');
                    document.getElementById('previewName').textContent = "";
                }
            }
        };

        window.clearInput = () => { 
            if(window.activeInput) window.activeInput.value = ""; 
            document.getElementById('previewName').textContent = "";
            document.getElementById('locationResult').classList.add('hidden');
        };

        // ============ FIREBASE SYNC ============

        window.loadFromCloud = async () => {
            document.getElementById('loader').classList.remove('hidden');
            try {
                const snapshot = await get(productsRef);
                const data = snapshot.val();
                if (data) {
                    window.inventory = Object.values(data);
                    window.showToast(`Sincronizado: ${window.inventory.length} itens`);
                }
            } catch (error) {
                window.showToast('Erro na sincronização', 'error');
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        };

        window.handleScan = async (val) => {
            const p = window.inventory.find(i => String(i.COD).includes(val));
            if (p) {
                document.getElementById('previewName').textContent = p.NOM;
                if (p.QTY_DEFAULT && p.QTY_DEFAULT !== '1') {
                    document.getElementById('qtyItm').value = p.QTY_DEFAULT;
                    document.getElementById('qtySavedIndicator').classList.remove('hidden');
                }
            }
        };

        window.addItem = async () => {
            const code = document.getElementById('mainCode').value;
            if(!code) return;

            const p = window.inventory.find(i => String(i.COD).includes(code)) || { NOM: 'NÃO CADASTRADO', COD: code };
            
            await push(queueRef, {
                codigo: code,
                validade: window.mode === 'validade' ? document.getElementById('valDate').value : "",
                tempName: p.NOM,
                fullData: { ...p, qtyItm: document.getElementById('qtyToggle').checked ? document.getElementById('qtyItm').value : "" },
                created_at: Date.now()
            });
            
            window.showToast("Adicionado à fila");
            window.clearInput();
        };

        onValue(queueRef, (snapshot) => {
            const data = snapshot.val();
            window.queue = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
            window.updateUI();
        });

        window.updateUI = () => {
            const tb = document.getElementById('queueTable');
            document.getElementById('queueBadge').textContent = window.queue.length;
            
            if(window.queue.length === 0) {
                tb.innerHTML = '<tr><td class="p-10 text-center opacity-20 uppercase font-black">Vazio</td></tr>';
                return;
            }

            tb.innerHTML = window.queue.map((item, idx) => `
                <tr class="border-b border-yellow-900/10">
                    <td class="p-3 font-black text-yellow-600">${idx+1}</td>
                    <td class="p-3">
                        <div class="font-black text-white uppercase">${item.codigo}</div>
                        <div class="text-[8px] text-slate-500 uppercase">${item.tempName}</div>
                    </td>
                    <td class="p-3 text-right">
                        <button onclick="window.removeItem('${item.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('btnDownload').disabled = window.queue.length === 0;
            document.getElementById('btnDownload').style.opacity = window.queue.length === 0 ? "0.5" : "1";
        };

        window.removeItem = (id) => remove(ref(db, `print_queue/${id}`));
        window.clearQueue = () => confirm("Limpar fila?") && remove(queueRef);

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.querySelector('span').textContent = msg;
            t.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-10'), 2000);
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            window.loadFromCloud();
            window.setActiveInput(document.getElementById('mainCode'));
        });

    </script>
</body>
</html>
