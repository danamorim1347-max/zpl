<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZK47 LOGISTIC PRO | Dev. Benilson Amorim</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        
        :root { --accent: #06b6d4; --bg-dark: #020617; }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-dark); 
            color: #f8fafc; 
            overflow-x: hidden;
            background-image: radial-gradient(circle at 50% -20%, #083344 0%, transparent 50%);
        }
        
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-cyan { border: 1px solid rgba(6, 182, 212, 0.2); box-shadow: 0 0 30px rgba(6, 182, 212, 0.05); }
        
        .input-pro { 
            background: rgba(30, 41, 59, 0.5); 
            border: 1px solid rgba(51, 65, 85, 1); 
            color: white; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            outline: none; 
            font-family: 'JetBrains Mono', monospace; 
        }
        .input-pro:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(6, 182, 212, 0.2); background: rgba(30, 41, 59, 0.8); }
        
        .btn-primary { 
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(8, 145, 178, 0.3);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(8, 145, 178, 0.5); }
        .btn-primary:active { transform: translateY(0); }

        .dev-badge {
            background: linear-gradient(135deg, #0f172a, #0891b2);
            padding: 5px 15px;
            border-radius: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid rgba(6, 182, 212, 0.3);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.1);
        }

        .switch-pro input:checked + .slider-pro { background-color: var(--accent); }
        .slider-pro { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider-pro:before { position: absolute; content: ""; height: 14px; width: 14px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-pro:before { transform: translateX(20px); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- OVERLAY LOADING -->
    <div id="loader" class="fixed inset-0 z-[100] bg-slate-950/80 backdrop-blur-md flex flex-col items-center justify-center hidden">
        <div class="relative w-24 h-24">
            <div class="absolute inset-0 border-4 border-cyan-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-t-cyan-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <svg viewBox="0 0 100 100" class="w-12 h-12 fill-cyan-400">
                    <path d="M50,10 C30,10 15,30 15,55 C15,75 35,90 50,90 C65,90 85,75 85,55 C85,30 70,10 50,10 Z" />
                </svg>
            </div>
        </div>
        <p class="mt-6 text-cyan-400 font-bold tracking-[4px] animate-pulse">SYNCING WITH NEBULA...</p>
    </div>

    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- HEADER PRO -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-6 glass glass-cyan p-6 rounded-[2rem]">
            <div class="flex items-center gap-6">
                <!-- LOGO ET -->
                <div class="relative group">
                    <div class="absolute inset-0 bg-cyan-500 blur-2xl opacity-20 group-hover:opacity-40 transition"></div>
                    <div class="relative w-20 h-20 bg-slate-900 border-2 border-cyan-500 flex items-center justify-center rounded-3xl rotate-3 group-hover:rotate-0 transition-transform duration-500">
                        <svg viewBox="0 0 100 100" class="w-12 h-12 fill-cyan-400">
                            <path d="M50,10 C30,10 15,30 15,55 C15,75 35,90 50,90 C65,90 85,75 85,55 C85,30 70,10 50,10 Z" />
                            <ellipse cx="32" cy="50" rx="12" ry="18" fill="#020617" transform="rotate(-15 32 50)" />
                            <ellipse cx="68" cy="50" rx="12" ry="18" fill="#020617" transform="rotate(15 68 50)" />
                        </svg>
                    </div>
                </div>
                <div>
                    <h1 class="text-4xl font-extrabold tracking-tighter italic">ZK47 <span class="text-cyan-500">LOGISTIC PRO</span></h1>
                    <div class="flex items-center gap-3 mt-2">
                        <span class="dev-badge text-[10px] text-white">Dev. Benilson Amorim</span>
                        <span class="px-3 py-1 bg-slate-800 rounded-full text-[9px] font-bold text-slate-400 uppercase tracking-widest border border-slate-700">Enterprise V31.0</span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="window.loadFromCloud()" class="bg-slate-800 hover:bg-slate-700 text-cyan-400 px-6 py-3 rounded-2xl text-xs font-bold transition flex items-center gap-2 border border-slate-700">
                    <i class="fa-solid fa-cloud-arrow-down"></i> PULL FROM CLOUD
                </button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- PAINEL DE CONTROLE (ESQUERDA) -->
            <div class="lg:col-span-5 space-y-8">
                
                <!-- DATABASE MANAGEMENT -->
                <section class="glass p-8 rounded-[2.5rem] space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-sm font-extrabold uppercase tracking-widest text-slate-400">Data Management</h2>
                        <div id="prodCount" class="text-[10px] font-bold bg-cyan-500/10 text-cyan-400 px-4 py-1 rounded-full border border-cyan-500/20 uppercase">No Data</div>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <label class="group cursor-pointer">
                            <div class="p-8 border-2 border-dashed border-slate-700 rounded-[2rem] hover:border-cyan-500 hover:bg-cyan-500/5 transition-all text-center">
                                <i class="fa-solid fa-file-csv text-4xl text-slate-600 group-hover:text-cyan-500 mb-4 transition"></i>
                                <p class="text-sm font-bold text-slate-400 group-hover:text-white transition">Import Logistics Master (.xlsx)</p>
                            </div>
                            <input type="file" id="fileInput" class="hidden" onchange="window.handleFileUpload(this)">
                        </label>
                        <button id="btnPushCloud" onclick="window.saveToCloud()" class="hidden w-full bg-cyan-600/10 hover:bg-cyan-600/20 text-cyan-400 border border-cyan-500/30 py-4 rounded-2xl text-xs font-black uppercase tracking-widest transition">
                            Sync Base to Nebula
                        </button>
                    </div>
                </section>

                <!-- INPUT ENGINE -->
                <section class="glass p-8 rounded-[2.5rem] relative overflow-hidden">
                    <div id="lockOverlay" class="absolute inset-0 z-20 bg-slate-950/90 flex flex-col items-center justify-center text-center p-8 transition-opacity duration-500">
                        <i class="fa-solid fa-shield-halved text-4xl text-cyan-900 mb-4"></i>
                        <p class="text-xs font-black text-cyan-900 uppercase tracking-[4px]">Access Restricted</p>
                    </div>

                    <!-- SELECTOR -->
                    <div class="flex p-1.5 bg-slate-900/80 rounded-2xl mb-8 border border-slate-800">
                        <button onclick="window.setMode('validade')" id="tabVal" class="flex-1 py-3 rounded-xl text-xs font-black transition-all bg-cyan-600 text-white">VALIDADE</button>
                        <button onclick="window.setMode('endereco')" id="tabEnd" class="flex-1 py-3 rounded-xl text-xs font-black transition-all text-slate-500">ENDEREÇO</button>
                    </div>

                    <!-- MODO VALIDADE -->
                    <div id="uiValidade" class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-2">Master Code (EAN)</label>
                            <input type="tel" id="valCode" class="w-full input-pro p-4 rounded-2xl text-xl" placeholder="Aguardando Bipe..." oninput="window.handleScan(this, 'val')">
                            <div id="valPreview" class="px-2 text-xs font-bold text-cyan-400 truncate min-h-[1rem]"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-2">Expiry Date</label>
                                <input type="tel" id="valDate" class="w-full input-pro p-4 rounded-2xl text-center" placeholder="MMAAAA" oninput="window.maskDate(this)">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-2">Labels Qty</label>
                                <input type="number" id="valQtyEtq" class="w-full input-pro p-4 rounded-2xl text-center" value="1">
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-4 bg-slate-900/50 rounded-2xl border border-slate-800">
                            <div>
                                <p class="text-xs font-black text-white">PRINT ITEM QTY</p>
                                <p class="text-[9px] text-slate-500 font-bold uppercase">Incluir quantidade na etiqueta</p>
                            </div>
                            <label class="switch-pro relative inline-block w-11 h-6">
                                <input type="checkbox" id="valQtyToggle" checked onchange="window.toggleQtyInput('val')">
                                <span class="slider-pro"></span>
                            </label>
                            <input type="number" id="valQtyItm" class="w-16 input-pro p-2 rounded-lg text-center font-bold" value="1">
                        </div>

                        <button onclick="window.addItem('val')" class="w-full btn-primary py-5 rounded-[1.5rem] text-sm font-black tracking-widest">COMMIT TO QUEUE</button>
                    </div>

                    <!-- MODO ENDEREÇO -->
                    <div id="uiEndereco" class="hidden space-y-6">
                        <div class="flex gap-2 p-1 bg-slate-800/50 rounded-xl mb-4">
                            <button onclick="window.switchEndSubMode('single')" id="subS" class="flex-1 py-1.5 text-[10px] font-black rounded-lg bg-cyan-600 text-white transition">MANUAL</button>
                            <button onclick="window.switchEndSubMode('mass')" id="subM" class="flex-1 py-1.5 text-[10px] font-black rounded-lg text-slate-500 transition">MODO MASSA</button>
                        </div>

                        <div id="endManual">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-2">Address Scan</label>
                                <input type="tel" id="endCode" class="w-full input-pro p-4 rounded-2xl text-xl" placeholder="Bipar Unidade..." oninput="window.handleScan(this, 'end')">
                                <div id="endPreview" class="px-2 text-xs font-bold text-cyan-400 truncate min-h-[1rem]"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-6">
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-2">Labels</label>
                                    <input type="number" id="endQtyEtq" class="w-full input-pro p-4 rounded-2xl text-center" value="1">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-2">Qty/Itm</label>
                                    <input type="number" id="endQtyItm" class="w-full input-pro p-4 rounded-2xl text-center" value="1">
                                </div>
                            </div>
                        </div>

                        <div id="endMass" class="hidden space-y-4">
                            <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-2">Paste Multiple Codes</label>
                            <textarea id="endMassList" class="w-full input-pro p-4 rounded-2xl h-40 text-xs" placeholder="Ex:&#10;7891010...&#10;7892020..."></textarea>
                            <p class="text-[9px] text-slate-500 font-bold px-2 italic">* O sistema usará a quantidade salva no banco para cada item.</p>
                        </div>

                        <button id="btnCommitEnd" onclick="window.addItem('end')" class="w-full btn-primary py-5 rounded-[1.5rem] text-sm font-black tracking-widest">TRANSMIT DATA</button>
                    </div>
                </section>
            </div>

            <!-- FILA DE IMPRESSÃO (DIREITA) -->
            <div class="lg:col-span-7 flex flex-col h-full">
                <section class="glass p-8 rounded-[3rem] flex-grow flex flex-col min-h-[500px]">
                    <div class="flex justify-between items-center mb-8">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-slate-800 rounded-2xl flex items-center justify-center border border-slate-700">
                                <i class="fa-solid fa-list-check text-cyan-500 text-sm"></i>
                            </div>
                            <h2 class="font-black text-white text-lg tracking-tight uppercase">Queue Buffer</h2>
                        </div>
                        <div class="flex items-center gap-4">
                            <span id="queueBadge" class="bg-cyan-500 text-slate-950 px-4 py-1 rounded-xl text-xs font-black">0</span>
                            <button onclick="window.clearQueue()" class="text-[10px] font-black text-red-500 hover:text-red-400 transition uppercase tracking-widest">Wipe Data</button>
                        </div>
                    </div>
                    
                    <div class="flex-grow overflow-y-auto bg-slate-950/40 rounded-[2rem] border border-slate-800/50 h-[30rem] custom-scrollbar">
                        <table class="w-full text-left">
                            <tbody id="queueTable" class="divide-y divide-slate-800/50"></tbody>
                        </table>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 mt-8">
                        <button onclick="window.generateZPL()" class="bg-white hover:bg-slate-200 text-slate-950 font-black py-5 rounded-2xl transition active:scale-95 text-xs tracking-[2px] uppercase">Compile Engine</button>
                        <button onclick="window.copyZPL()" id="btnCopy" disabled class="bg-slate-800 text-slate-600 font-bold py-3 rounded-2xl border border-slate-700 cursor-not-allowed transition uppercase text-[10px]">Copy</button>
                        <button onclick="window.downloadFile()" id="btnDownload" disabled class="bg-slate-800 text-slate-600 font-bold py-3 rounded-2xl border border-slate-700 cursor-not-allowed transition uppercase text-[10px]">File</button>
                    </div>
                    
                    <textarea id="finalZPL" readonly class="mt-6 w-full h-32 bg-black text-cyan-500/60 font-mono text-[10px] p-6 rounded-3xl border border-cyan-900/20 hidden shadow-inner"></textarea>
                </section>
            </div>
        </main>

        <footer class="flex flex-col items-center justify-center py-10 gap-6 opacity-40 hover:opacity-100 transition duration-700">
            <svg viewBox="0 0 100 100" class="w-12 h-12 fill-slate-700">
                <path d="M50,10 C30,10 15,30 15,55 C15,75 35,90 50,90 C65,90 85,75 85,55 C85,30 70,10 50,10 Z" />
            </svg>
            <div class="text-center">
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-[8px]">Benilson Amorim</p>
                <p class="text-[9px] text-slate-600 font-bold mt-1 uppercase">ZK47 Galactic Hardware & Software &copy; 2024</p>
            </div>
        </footer>
    </div>

    <div id="toast" class="fixed bottom-12 left-1/2 -translate-x-1/2 bg-cyan-600 text-white px-12 py-4 rounded-full shadow-[0_0_50px_rgba(8,145,178,0.4)] font-black text-xs uppercase tracking-widest opacity-0 transition-all duration-500 z-[100] translate-y-10">
        <span>Transmitting Signal...</span>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const SUPABASE_URL = "https://sypxyzbqbwzizkrlxhvm.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5cHh5emJxYnd6aXprcmx4aHZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5ODcyNTksImV4cCI6MjA4MjU2MzI1OX0.VklEmQH9lonsXujpxA9jp0GJNUDXGDJbD5TotqpVcjc";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        window.inventory = [];
        window.queue = [];
        window.mode = 'validade';
        window.endSubMode = 'single';

        async function fetchQueue() {
            const { data } = await supabase.from('print_queue').order('created_at', { ascending: true });
            window.queue = data || [];
            window.updateUI();
        }

        supabase.channel('mothership').on('postgres_changes', { event: '*', schema: 'public', table: 'print_queue' }, fetchQueue).subscribe();
        
        fetchQueue();
        setTimeout(() => document.getElementById('statusBox').classList.add('hidden'), 3000);

        // EXCEL HANDLING
        window.handleFileUpload = async (input) => {
            const f = input.files[0]; if (!f) return;
            document.getElementById('loader').classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                window.inventory = json.slice(1).map(x => ({
                    COD: String(x[0]||"").trim(), NOM: String(x[1]||"").trim(),
                    RUA: String(x[4]||"").trim(), RCK: String(x[5]||"").trim(),
                    LIN: String(x[6]||"").trim(), COL: String(x[7]||"").trim(),
                    QTY_DEFAULT: '1'
                })).filter(i => i.COD);
                
                document.getElementById('lockOverlay').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('prodCount').innerText = `${window.inventory.length} MASTER ITEMS`;
                document.getElementById('btnPushCloud').classList.remove('hidden');
                document.getElementById('loader').classList.add('hidden');
                window.showToast("DATABASE DEPLOYED");
            };
            reader.readAsArrayBuffer(f);
        };

        window.saveToCloud = async () => {
            document.getElementById('loader').classList.remove('hidden');
            await supabase.from('products').delete().neq('COD', 'X');
            await supabase.from('products').insert(window.inventory);
            window.showToast("NEBULA SYNCED");
            document.getElementById('loader').classList.add('hidden');
        };

        window.loadFromCloud = async () => {
            document.getElementById('loader').classList.remove('hidden');
            const { data } = await supabase.from('products').select('*');
            if(data?.length) {
                window.inventory = data;
                document.getElementById('lockOverlay').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('prodCount').innerText = `${data.length} CLOUD ITEMS`;
                window.showToast("CLOUD ACCESS GRANTED");
            }
            document.getElementById('loader').classList.add('hidden');
        };

        // SCAN ENGINE
        window.handleScan = (el, type) => {
            let full = el.value.replace(/\D/g,'');
            let short = window.extractShortCode(full);
            const p = window.inventory.find(i => String(i.COD) === String(short));
            const pr = document.getElementById(type + 'Preview');
            const qr = document.getElementById(type + 'QtyItm');

            if(p) { 
                pr.innerText = p.NOM; 
                pr.classList.replace('text-slate-700', 'text-cyan-400');
                qr.value = p.QTY_DEFAULT || '1';
            } else { 
                pr.innerText = "NO SIGNAL RECORD (" + short + ")"; 
                pr.classList.replace('text-cyan-400', 'text-slate-700'); 
            }
        };

        window.toggleQtyInput = (type) => {
            const isOff = !document.getElementById(type + 'QtyToggle').checked;
            document.getElementById(type + 'QtyItm').classList.toggle('opacity-20', isOff);
            document.getElementById(type + 'QtyItm').readOnly = isOff;
        };

        // ADD LOGIC (SINGLE & MASS)
        window.addItem = async (m) => {
            document.getElementById('loader').classList.remove('hidden');
            
            if (m === 'end' && window.endSubMode === 'mass') {
                await window.addMassItems();
                document.getElementById('loader').classList.add('hidden');
                return;
            }

            const prefix = m === 'val' ? 'val' : 'end';
            const fullCode = document.getElementById(prefix + 'Code').value;
            const shortCode = window.extractShortCode(fullCode);
            const qtyEtq = parseInt(document.getElementById(prefix + 'QtyEtq').value) || 1;
            const qtyItm = document.getElementById(prefix + 'QtyItm').value;
            const printQty = m === 'val' ? document.getElementById('valQtyToggle').checked : true;
            const validade = m === 'val' ? document.getElementById('valDate').value : "";

            if(!fullCode) { document.getElementById('loader').classList.add('hidden'); return; }

            const p = window.inventory.find(i => String(i.COD) === String(shortCode)) || { NOM: 'UNKNOWN OBJECT' };
            if(printQty) await supabase.from('products').update({ QTY_DEFAULT: qtyItm }).eq('COD', shortCode);

            const batch = [];
            for(let i=0; i < qtyEtq; i++) {
                batch.push({
                    codigo: fullCode,
                    validade: validade,
                    tempName: p.NOM,
                    fullData: { ...p, qtyItm: printQty ? qtyItm : "" },
                    created_at: Date.now() + i
                });
            }
            await supabase.from('print_queue').insert(batch);
            document.getElementById(prefix + 'Code').value = "";
            document.getElementById(prefix + 'Preview').innerText = "";
            document.getElementById(prefix + 'Code').focus();
            document.getElementById('loader').classList.add('hidden');
            window.showToast("BUFFERED");
        };

        window.addMassItems = async () => {
            const raw = document.getElementById('endMassList').value;
            const lines = raw.split(/[\n,;\s]+/).filter(c => c.trim().length > 0);
            
            if (lines.length === 0) return;

            const batch = [];
            lines.forEach((fullCode, i) => {
                const shortCode = window.extractShortCode(fullCode);
                const p = window.inventory.find(item => String(item.COD) === String(shortCode)) || { NOM: 'UNKNOWN' };
                batch.push({
                    codigo: fullCode,
                    validade: "",
                    tempName: p.NOM,
                    fullData: { ...p, qtyItm: p.QTY_DEFAULT || "1" },
                    created_at: Date.now() + i
                });
            });

            const { error } = await supabase.from('print_queue').insert(batch);
            if (!error) {
                document.getElementById('endMassList').value = "";
                window.showToast(`${lines.length} OBJECTS PROCESSED`);
            }
        };

        window.removeItem = async (id) => { await supabase.from('print_queue').delete().eq('id', id); };
        window.clearQueue = async () => { if(confirm("Wipe print memory?")) await supabase.from('print_queue').delete().neq('codigo', 'X'); };

        window.extractShortCode = (v) => {
            let clean = v.replace(/\D/g,'');
            return clean.length >= 12 ? clean.slice(-6, -1) : clean;
        };
        window.maskDate = (el) => { 
            let v=el.value.replace(/\D/g,''); 
            if(v.length>2) v = v.substring(0,2)+'/'+v.substring(2,6); 
            el.value=v; 
        };

        window.updateUI = () => {
            const tb = document.getElementById('queueTable');
            document.getElementById('queueBadge').innerText = window.queue.length;
            
            if (window.queue.length === 0) {
                tb.innerHTML = `<tr><td colspan="4" class="p-20 text-center text-slate-800 font-black uppercase tracking-[10px]">No Signal</td></tr>`;
            } else {
                tb.innerHTML = window.queue.map((i, idx) => `
                    <tr class="hover:bg-cyan-500/5 transition group">
                        <td class="p-6 text-[10px] text-slate-800 font-black w-10">${String(idx+1).padStart(2,'0')}</td>
                        <td class="p-6">
                            <div class="font-black text-slate-200 text-sm tracking-tight">${i.codigo}</div>
                            <div class="text-[9px] text-slate-600 font-bold uppercase mt-1 tracking-wider">${i.tempName}</div>
                        </td>
                        <td class="p-6 text-cyan-600 font-mono text-[10px] text-center font-black">
                            ${i.validade ? i.validade : (i.fullData.qtyItm ? 'Q:'+i.fullData.qtyItm : '--')}
                        </td>
                        <td class="p-6 text-right">
                            <button onclick="window.removeItem(${i.id})" class="w-10 h-10 rounded-full hover:bg-red-500/10 text-slate-800 hover:text-red-500 transition active:scale-90"><i class="fa-solid fa-xmark"></i></button>
                        </td>
                    </tr>`).join('');
            }
            
            const has = window.queue.length > 0;
            ['btnCopy', 'btnDownload'].forEach(b => {
                const el = document.getElementById(b);
                el.disabled = !has;
                el.className = has ? "bg-slate-900 text-cyan-400 font-black py-4 rounded-2xl border border-cyan-900/30 shadow-lg transition hover:bg-slate-800" : "bg-slate-900 text-slate-800 font-bold py-4 rounded-2xl border border-slate-800";
            });
        };

        window.setMode = (m) => {
            window.mode = m;
            document.getElementById('uiValidade').classList.toggle('hidden', m!=='validade');
            document.getElementById('uiEndereco').classList.toggle('hidden', m!=='endereco');
            document.getElementById('tabVal').className = m==='validade' ? "flex-1 py-3 rounded-xl text-xs font-black bg-cyan-600 text-white shadow-lg transition" : "flex-1 py-3 rounded-xl text-xs font-black text-slate-500 transition";
            document.getElementById('tabEnd').className = m==='endereco' ? "flex-1 py-3 rounded-xl text-xs font-black bg-cyan-600 text-white shadow-lg transition" : "flex-1 py-3 rounded-xl text-xs font-black text-slate-500 transition";
        };

        window.switchEndSubMode = (sm) => {
            window.endSubMode = sm;
            document.getElementById('endManual').classList.toggle('hidden', sm!=='single');
            document.getElementById('endMass').classList.toggle('hidden', sm!=='mass');
            document.getElementById('subS').className = sm==='single' ? "flex-1 py-1.5 text-[10px] font-black rounded-lg bg-cyan-600 text-white" : "flex-1 py-1.5 text-[10px] font-black rounded-lg text-slate-500";
            document.getElementById('subM').className = sm==='mass' ? "flex-1 py-1.5 text-[10px] font-black rounded-lg bg-cyan-600 text-white" : "flex-1 py-1.5 text-[10px] font-black rounded-lg text-slate-500";
            document.getElementById('btnCommitEnd').innerText = sm==='single' ? 'TRANSMIT DATA' : 'BATCH INJECTION';
        };

        window.generateZPL = () => {
            if(!window.queue.length) return;
            let full = "";
            const clean = (t, type) => {
                if (!t) return "";
                let s = String(t).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
                if (type === 'R') s = s.replace(/^RUA[:\s]*/g, "");
                if (type === 'K') s = s.replace(/^(RACK|RCK)[:\s]*/g, "");
                if (type === 'L') s = s.replace(/^(LINHA|LIN)[:\s]*/g, "");
                if (type === 'C') s = s.replace(/^(COLUNA|COL)[:\s]*/g, "");
                return s.trim().substring(0, 28);
            };

            for(let i=0; i<window.queue.length; i+=2) {
                let t = window.queue[i], b = window.queue[i+1];
                const render = (item, y) => {
                    if(!item) return "";
                    const d = item.fullData || {};
                    const fullCod = String(item.codigo); 
                    const shortCod = window.extractShortCode(fullCod);
                    const qtyItm = d.qtyItm || "";
                    let z = `^FO20,${y+30}^A0N,100,90^FD${shortCod}^FS\n`;
                    if(item.validade) z += `^FO235,${y+20}^GB550,65,75^FS\n^FO250,${y+30}^A0N,95,90^FR^FDVAL: ${item.validade}^FS\n`;
                    z += `^FO20,${y+140}^A0N,70,70^FB770,2,0,L,0^FD${clean(item.tempName)}^FS\n`;
                    z += `^FO20,${y+300}^A0N,45,45^FDRUA: ${clean(d.RUA,'R')} - RCK: ${clean(d.RCK,'K')}^FS\n`;
                    z += `^FO20,${y+350}^A0N,45,45^FDLIN: ${clean(d.LIN,'L')} - COL: ${clean(d.COL,'C')}^FS\n`;
                    if(qtyItm) z += `^FO580,${y+310}^A0N,80,80^FDQ:${qtyItm}^FS\n`;
                    z += `^BY4,3,100^FO20,${y+410}^BCN,130,Y,N,N^FD${fullCod}^FS\n`;
                    return z;
                };
                let l = `^XA\n^CI28^PW812^LL1218^LH0,0\n`;
                l += render(t, 0);
                if(b) l += render(b, 600);
                l += `^XZ\n`; full += l;
            }
            document.getElementById('finalZPL').value = full;
            document.getElementById('finalZPL').classList.remove('hidden');
            window.showToast("ZPL COMPILED");
        };

        window.copyZPL = () => { const a = document.getElementById('finalZPL'); a.select(); navigator.clipboard.writeText(a.value); window.showToast("COPIED"); };
        window.downloadFile = () => { const blob = new Blob([document.getElementById('finalZPL').value], {type: 'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `zk47_out_${Date.now()}.zpl`; a.click(); };
        window.showToast = (msg) => { const t = document.getElementById('toast'); t.querySelector('span').innerText = msg; t.classList.remove('translate-y-10', 'opacity-0'); setTimeout(() => t.classList.add('translate-y-10', 'opacity-0'), 2500); };
    </script>
</body>
</html>
