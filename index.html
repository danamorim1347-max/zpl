<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZPL ZK47 PRO | Logística</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        :root { --gold: #FFD700; --bg: #010409; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: #f8fafc; background-image: radial-gradient(circle at 50% -20%, #443308 0%, transparent 50%); }
        .glass { background: #0d1117; border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 1.5rem; }
        .input-pro { background: #000; border: 1px solid #30363d; color: white; outline: none; font-family: 'JetBrains Mono', monospace; border-radius: 12px; text-align: center; }
        .input-pro:focus { border-color: var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); }
        .input-active { border-color: var(--gold) !important; background: #1a1608 !important; }
        .btn-primary { background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); border-radius: 14px; font-weight: 800; color: #000; cursor: pointer; transition: 0.2s; }
        .tab-btn { flex: 1; padding: 10px; font-size: 11px; font-weight: 900; text-transform: uppercase; color: #64748b; cursor: pointer; border-radius: 8px; }
        .tab-btn.active { background-color: var(--gold); color: #000; }
        .item-row.done { opacity: 0.3; background: #061108 !important; border-left: 4px solid #10b981; }
        .kb-key { background: #161b22; border: 1px solid #30363d; border-radius: 12px; text-align: center; font-weight: 800; font-size: 1.4rem; color: #fff; cursor: pointer; user-select: none; }
        .kb-key:active { background: var(--gold); color: #000; }
        @media print {
            header, #keyboard, .no-print, .tab-btn, .btn-primary, .glass { display: none !important; }
            body { background: white !important; color: black !important; }
            .print-area { display: block !important; width: 100% !important; }
            .font-white { color: black !important; }
        }
    </style>
</head>
<body class="min-h-screen p-2 flex flex-col items-center">

    <div id="loader" class="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center hidden">
        <div class="w-12 h-12 border-4 border-t-yellow-500 rounded-full animate-spin"></div>
    </div>

    <div id="toast" class="fixed top-4 right-4 bg-yellow-500 text-black px-6 py-3 rounded-xl font-black text-xs opacity-0 transition-all duration-300 z-[9999]"><span></span></div>

    <div class="w-full max-w-6xl space-y-4">
        <header class="flex justify-between items-center glass p-4 no-print">
            <div class="flex items-center gap-2"><i class="fa-solid fa-barcode text-yellow-500"></i><h1 class="font-black text-sm uppercase">ZK47 <span class="text-yellow-500">PRO</span></h1></div>
            <div class="flex gap-2">
                <button onclick="window.loadFromCloud()" class="bg-yellow-900/20 text-yellow-500 px-3 py-2 rounded-xl text-[10px] font-black uppercase">Sync</button>
                <label class="bg-slate-800 text-slate-400 px-3 py-2 rounded-xl text-[10px] font-black cursor-pointer uppercase">Excel <input type="file" class="hidden" onchange="window.handleFileUpload(this)"></label>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-4">
            <div class="lg:col-span-4 space-y-4 no-print">
                <section class="glass p-5">
                    <div class="flex p-1 bg-slate-900 rounded-xl mb-4 border border-slate-800">
                        <button onclick="window.setMode('etiqueta')" id="tabEti" class="tab-btn active">Etiquetas</button>
                        <button onclick="window.setMode('separacao')" id="tabSep" class="tab-btn">Separação</button>
                    </div>

                    <div id="etiquetaView" class="space-y-4">
                        <input type="text" id="mainCode" class="input-pro w-full p-3" placeholder="Bipar Código" onfocus="window.setActiveInput(this)" oninput="window.updateSearch(this.value)">
                        <div id="previewName" class="text-center font-black text-yellow-500 text-[11px] h-4 uppercase"></div>
                        <div id="liveAddress" class="grid grid-cols-4 gap-1 opacity-0">
                            <div class="bg-black/50 p-1 rounded text-center"><div class="text-[7px] text-slate-500">RUA</div><div id="lRua" class="text-xs font-bold">-</div></div>
                            <div class="bg-black/50 p-1 rounded text-center"><div class="text-[7px] text-slate-500">RCK</div><div id="lRack" class="text-xs font-bold">-</div></div>
                            <div class="bg-black/50 p-1 rounded text-center"><div class="text-[7px] text-slate-500">LIN</div><div id="lLin" class="text-xs font-bold">-</div></div>
                            <div class="bg-black/50 p-1 rounded text-center"><div class="text-[7px] text-slate-500">COL</div><div id="lCol" class="text-xs font-bold">-</div></div>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <input type="text" id="valDate" class="input-pro text-xs p-2" placeholder="MMAAAA" onfocus="window.setActiveInput(this)">
                            <input type="text" id="valQtyEtq" class="input-pro text-xs p-2" value="1" onfocus="window.setActiveInput(this)">
                            <input type="text" id="valQtyItens" class="input-pro text-xs p-2" placeholder="Qtd Itens" onfocus="window.setActiveInput(this)">
                        </div>
                        <button onclick="window.addItemToQueue()" class="btn-primary w-full py-3 uppercase text-xs">Adicionar</button>
                    </div>

                    <div id="separacaoView" class="hidden space-y-4">
                        <textarea id="bulkList" class="input-pro w-full p-4 h-32 text-left" placeholder="Código Qtd"></textarea>
                        <button onclick="window.processBulkSeparation()" class="btn-primary w-full py-3 uppercase text-xs">Gerar Checklist</button>
                    </div>
                </section>

                <section id="keyboard" class="grid grid-cols-3 gap-2 bg-slate-900/50 p-4 rounded-[2rem]">
                    <script>for(let i=1;i<=9;i++) document.write(`<button onclick="window.pressKey('${i}')" class="kb-key p-4">${i}</button>`);</script>
                    <button onclick="window.backspace()" class="kb-key text-red-500"><i class="fa-solid fa-delete-left"></i></button>
                    <button onclick="window.pressKey('0')" class="kb-key p-4">0</button>
                    <button onclick="window.clearActiveInput()" class="kb-key text-yellow-500">C</button>
                </section>
            </div>

            <div class="lg:col-span-8 space-y-4 print-area">
                <section class="glass p-6 min-h-[600px] flex flex-col">
                    <div id="headerList" class="flex justify-between items-center mb-6">
                        <h2 id="listTitle" class="font-black text-xs uppercase text-slate-400">Fila</h2>
                        <div class="flex gap-2 no-print">
                            <button id="btnPrint" onclick="window.printList()" class="hidden border border-yellow-500/20 px-3 py-1 rounded text-yellow-500 text-[10px]"><i class="fa-solid fa-print"></i></button>
                            <button onclick="window.clearCurrentCollection()" class="border border-red-500/20 px-3 py-1 rounded text-red-500 text-[10px]">LIMPAR</button>
                        </div>
                    </div>
                    <div class="flex-grow overflow-y-auto max-h-[400px]"><table class="w-full text-left"><tbody id="mainTableBody" class="divide-y divide-slate-800"></tbody></table></div>
                    <div id="footerActions" class="mt-6 pt-4 border-t border-slate-800 flex flex-col gap-2"></div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyCiy4DOVPYYr_UtglmnVWUdZ8SqM26Neo8", authDomain: "zpl47-f751d.firebaseapp.com", projectId: "zpl47-f751d", databaseURL: "https://zpl47-f751d-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        window.inventory = []; window.mode = 'etiqueta'; window.activeInput = null;
        const extractId = (c) => String(c).replace(/\D/g, '').length === 13 ? String(c).substring(7, 12) : String(c);

        window.updateSearch = (val) => {
            const prod = window.inventory.find(i => extractId(i.COD) === extractId(val));
            const live = document.getElementById('liveAddress');
            if(prod && val.length >= 5) {
                document.getElementById('previewName').textContent = prod.NOM;
                document.getElementById('lRua').textContent = prod.RUA || "-";
                document.getElementById('lRack').textContent = prod.RCK || "-";
                document.getElementById('lLin').textContent = prod.LIN || "-";
                document.getElementById('lCol').textContent = prod.COL || "-";
                live.style.opacity = "1";
            } else { live.style.opacity = "0"; document.getElementById('previewName').textContent = val.length >= 5 ? "NÃO CADASTRADO" : ""; }
        };

        window.setMode = (m) => {
            window.mode = m;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === (m==='etiqueta'?'tabEti':'tabSep')));
            document.getElementById('etiquetaView').classList.toggle('hidden', m !== 'etiqueta');
            document.getElementById('separacaoView').classList.toggle('hidden', m !== 'separacao');
            document.getElementById('btnPrint').classList.toggle('hidden', m !== 'separacao');
            window.refreshTable();
        };

        window.refreshTable = () => {
            const path = window.mode === 'etiqueta' ? "print_queue" : "active_separation";
            onValue(ref(db, path), (snap) => {
                const items = snap.val() ? Object.keys(snap.val()).map(k => ({id:k, ...snap.val()[k]})) : [];
                const body = document.getElementById('mainTableBody');
                if(window.mode === 'etiqueta') {
                    body.innerHTML = items.map(i => `<tr class="text-[11px]"><td class="p-2 font-bold">${i.tempName}<br><span class="text-slate-500">${i.codigo_barras}</span></td><td class="text-yellow-500 text-center">${i.validade||'-'}</td><td class="text-right">${i.qtdItens?'Q:'+i.qtdItens:''} <button onclick="window.deleteItem('${i.id}')" class="text-red-500 no-print ml-2"><i class="fa-solid fa-times"></i></button></td></tr>`).join('');
                    document.getElementById('footerActions').innerHTML = `<div class="grid grid-cols-2 gap-2"><button onclick="window.generateZPL('download')" class="btn-primary py-3 text-[10px]">DOWNLOAD ZPL</button><button onclick="window.generateZPL('copy')" class="btn-primary bg-slate-800 text-yellow-500 py-3 text-[10px]">COPIAR ZPL</button></div>`;
                } else {
                    items.sort((a,b)=>(a.rua+a.rack).localeCompare(b.rua+b.rack));
                    body.innerHTML = items.map(i => `<tr class="item-row ${i.status==='done'?'done':''} text-[11px]"><td class="p-2"><div class="bg-slate-800 text-white px-1 py-0.5 rounded text-[9px] uppercase font-white">${i.rua} ${i.rack}</div></td><td class="p-2"><span class="text-[9px] text-slate-500 font-white">${i.code}</span><br><b class="uppercase font-white">${i.name}</b></td><td class="text-center"><div onclick="window.editQuantity('${i.id}','${i.qty}')" class="p-1 rounded bg-yellow-500/10 text-yellow-500 font-black">${i.qty}</div></td><td class="text-right no-print"><button onclick="window.toggleStatus('${i.id}','${i.status}')" class="w-8 h-8 rounded-full border border-slate-700 ${i.status==='done'?'bg-green-500 text-black':''}"><i class="fa-solid fa-check"></i></button></td></tr>`).join('');
                    document.getElementById('footerActions').innerHTML = `<div class="text-center text-[9px] text-slate-500 uppercase">Ordenado por endereço</div>`;
                }
            });
        };

        window.addItemToQueue = async () => {
            const code = document.getElementById('mainCode').value; if(!code) return;
            const prod = window.inventory.find(i => extractId(i.COD) === extractId(code)) || {NOM: "AVULSO", COD: code};
            for(let i=0; i<(parseInt(document.getElementById('valQtyEtq').value)||1); i++) {
                await push(ref(db, "print_queue"), {codigo_barras: code, validade: document.getElementById('valDate').value, qtdItens: document.getElementById('valQtyItens').value, tempName: prod.NOM, fullData: prod});
            }
            window.clearActiveInput(); window.showToast("Adicionado!");
        };

        window.generateZPL = async (action) => {
            const snap = await get(ref(db, "print_queue")); const items = snap.val() ? Object.values(snap.val()) : [];
            if(!items.length) return;
            let zpl = ""; const cl = (t) => String(t||"").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
            for(let i=0; i<items.length; i+=2) {
                zpl += "^XA\n^CI28^PW812^LL1218\n";
                const lb = (item, y) => {
                    if(!item) return ""; const r = item.fullData || {};
                    let s = `^FO20,${y+30}^A0N,100,90^FD${extractId(item.codigo_barras)}^FS\n^FO235,${y+20}^GB550,65,75^FS^FO250,${y+30}^A0N,95,90^FR^FDVAL: ${item.validade||''}^FS\n^FO20,${y+140}^A0N,60,60^FB770,2,0,L,0^FD${cl(item.tempName)}^FS\n^FO20,${y+300}^A0N,40,40^FD${r.RUA||''} ${r.RCK||''}^FS\n`;
                    if(item.qtdItens) s += `^FO580,${y+310}^A0N,80,80^FDQ:${item.qtdItens}^FS\n`;
                    s += `^BY2,3,130^FO60,${y+410}^BCN,130,Y,N,N^FD${item.codigo_barras}^FS\n`; return s;
                };
                zpl += lb(items[i], 0) + lb(items[i+1], 600) + "^XZ\n";
            }
            if(action==='copy') { navigator.clipboard.writeText(zpl); window.showToast("Copiado!"); }
            else { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([zpl],{type:'text/plain'})); a.download = 'etiquetas.zpl'; a.click(); }
        };

        window.processBulkSeparation = async () => {
            const lines = document.getElementById('bulkList').value.split('\n');
            document.getElementById('loader').classList.remove('hidden');
            for(let line of lines) {
                const [code, qty] = line.trim().split(/[\s,t]+/);
                if(code) {
                    const prod = window.inventory.find(i => extractId(i.COD) === extractId(code)) || {NOM: "NÃO CADASTRADO", COD: code};
                    await push(ref(db, "active_separation"), {code, qty: qty||1, name: prod.NOM, rua: prod.RUA||'-', rack: prod.RCK||'-', status:'pending'});
                }
            }
            document.getElementById('bulkList').value = ""; document.getElementById('loader').classList.add('hidden');
        };

        window.loadFromCloud = async () => { document.getElementById('loader').classList.remove('hidden'); const snap = await get(ref(db, "master_products")); if(snap.exists()) window.inventory = Object.values(snap.val()); document.getElementById('loader').classList.add('hidden'); window.showToast("Sincronizado"); };
        window.handleFileUpload = (input) => { const reader = new FileReader(); reader.onload = async (e) => { const json = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type:'array'}).Sheets[XLSX.read(new Uint8Array(e.target.result), {type:'array'}).SheetNames[0]]); const master = {}; json.forEach(r => { const cod = String(r.COD||r.CÓDIGO||""); if(cod) master[cod] = {COD:cod, NOM:r.NOME||"S/N", RUA:r.RUA||"", RCK:r.RACK||"", LIN:r.LINHA||"", COL:r.COLUNA||""}; }); await set(ref(db, "master_products"), master); window.loadFromCloud(); }; reader.readAsArrayBuffer(input.files[0]); };
        window.printList = () => window.print();
        window.editQuantity = async (id, cur) => { const n = prompt("Nova Qtd:", cur); if(n) await update(ref(db, `active_separation/${id}`), {qty:n}); };
        window.toggleStatus = (id, cur) => set(ref(db, `active_separation/${id}/status`), cur==='done'?'pending':'done');
        window.deleteItem = (id) => remove(ref(db, (window.mode==='etiqueta'?'print_queue':'active_separation')+'/'+id));
        window.clearCurrentCollection = () => confirm("Limpar tudo?") && remove(ref(db, window.mode==='etiqueta'?"print_queue":"active_separation"));
        window.pressKey = (v) => { if(window.activeInput) { window.activeInput.value += v; if(window.activeInput.id==='mainCode') window.updateSearch(window.activeInput.value); } };
        window.backspace = () => { if(window.activeInput) { window.activeInput.value = window.activeInput.value.slice(0,-1); window.updateSearch(window.activeInput.value); } };
        window.clearActiveInput = () => { if(window.activeInput) { window.activeInput.value = ""; window.updateSearch(""); } };
        window.setActiveInput = (el) => { window.activeInput = el; document.querySelectorAll('.input-pro').forEach(i=>i.classList.remove('input-active')); el.classList.add('input-active'); };
        window.showToast = (m) => { const t = document.getElementById('toast'); t.querySelector('span').textContent=m; t.classList.remove('opacity-0'); setTimeout(()=>t.classList.add('opacity-0'),2000); };
        document.addEventListener('DOMContentLoaded', () => { window.loadFromCloud(); window.refreshTable(); });
    </script>
</body>
</html>