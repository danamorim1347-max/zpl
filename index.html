<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZPL ZK47 | Benilson Amorim</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --gold: #FFD700; --bg: #010409; }
        body { background-color: var(--bg); color: white; font-family: sans-serif; }
        .glass { background: #0d1117; border: 1px solid #30363d; border-radius: 1.5rem; padding: 1.5rem; }
        .input-pro { background: #000; border: 1px solid #30363d; color: white; padding: 12px; border-radius: 8px; width: 100%; font-size: 1.1rem; text-align: center; outline: none; }
        .input-pro:focus { border-color: var(--gold); }
        .btn-gold { background: linear-gradient(to bottom, #FFD700, #B8860B); color: black; font-weight: bold; padding: 12px; border-radius: 8px; width: 100%; text-transform: uppercase; }
        .btn-gold:active { transform: scale(0.98); }
        .dev-footer { background: linear-gradient(to right, #FFD700, #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; }
    </style>
</head>
<body class="p-4 flex flex-col items-center">

    <div class="w-full max-w-2xl space-y-6">
        
        <!-- HEADER -->
        <header class="flex flex-col items-center glass border-yellow-500/30">
            <div class="w-20 h-20 mb-2">
                <svg viewBox="0 0 100 100" class="fill-yellow-500">
                    <path d="M50,10 C30,10 15,30 15,55 C15,75 35,90 50,90 C65,90 85,75 85,55 C85,30 70,10 50,10 Z" />
                    <ellipse cx="32" cy="50" rx="12" ry="18" fill="#000" transform="rotate(-15 32 50)" />
                    <ellipse cx="68" cy="50" rx="12" ry="18" fill="#000" transform="rotate(15 68 50)" />
                </svg>
            </div>
            <button onclick="window.loadFromCloud()" class="text-[10px] border border-yellow-600 px-4 py-1 rounded text-yellow-500 font-bold uppercase">Sincronizar Banco</button>
        </header>

        <!-- DATABASE IMPORT -->
        <section class="glass space-y-4">
            <div class="flex justify-between text-[10px] font-bold text-gray-500 uppercase">
                <span>Base de Dados</span>
                <span id="prodCount" class="text-yellow-500">0 itens</span>
            </div>
            <input type="file" id="fileInput" class="hidden" onchange="window.handleFileUpload(this)">
            <button onclick="document.getElementById('fileInput').click()" class="border-2 border-dashed border-gray-700 w-full py-4 rounded-xl text-gray-500 text-sm">
                Selecionar Excel (.xlsx)
            </button>
            <button id="btnPush" onclick="window.saveToCloud()" class="hidden text-[10px] text-yellow-600 underline w-full">Subir base para nuvem</button>
        </section>

        <!-- INPUTS -->
        <section class="glass space-y-4">
            <div class="flex gap-2 p-1 bg-black rounded-lg">
                <button onclick="window.setMode('validade')" id="btnVal" class="flex-1 py-2 rounded bg-yellow-500 text-black font-bold text-xs uppercase">Validade</button>
                <button onclick="window.setMode('endereco')" id="btnEnd" class="flex-1 py-2 rounded text-gray-500 font-bold text-xs uppercase">Endereço</button>
            </div>

            <div id="formValidade" class="space-y-4">
                <input type="text" id="valCode" class="input-pro" placeholder="Bipar Código" onchange="window.handleCodeChange(this)">
                <div id="valName" class="text-center text-yellow-500 font-bold text-xs uppercase min-h-[1rem]"></div>
                <div class="flex gap-2">
                    <input type="text" id="valDate" class="input-pro" placeholder="Data (122026)" maxlength="6">
                    <input type="number" id="valQty" class="input-pro" value="1" placeholder="Qtd">
                </div>
                <button onclick="window.addItem('validade')" class="btn-gold">Adicionar</button>
            </div>

            <div id="formEndereco" class="hidden space-y-4">
                <div class="flex gap-2 mb-2">
                    <button onclick="window.setSubMode('unit')" id="subUnit" class="flex-1 text-[10px] font-bold text-yellow-500">UNITÁRIO</button>
                    <button onclick="window.setSubMode('mass')" id="subMass" class="flex-1 text-[10px] font-bold text-gray-600">MASSA</button>
                </div>
                <div id="areaUnit">
                    <input type="text" id="endCode" class="input-pro" placeholder="Bipar Unidade" onchange="window.handleCodeChange(this)">
                    <div id="endName" class="text-center text-yellow-500 font-bold text-xs uppercase mt-2"></div>
                </div>
                <div id="areaMass" class="hidden">
                    <textarea id="endList" class="input-pro h-32 text-xs" placeholder="Cole os códigos aqui..."></textarea>
                </div>
                <button onclick="window.addItem('endereco')" class="btn-gold">Adicionar Itens</button>
            </div>
        </section>

        <!-- FILA -->
        <section class="glass">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xs font-bold uppercase">Fila de Impressão (<span id="queueBadge">0</span>)</h2>
                <button onclick="window.clearQueue()" class="text-red-500 text-[10px] font-bold uppercase">Limpar</button>
            </div>
            <div class="max-h-60 overflow-y-auto border border-gray-800 rounded-lg custom-scrollbar">
                <table class="w-full text-xs text-left">
                    <tbody id="queueTable" class="divide-y divide-gray-800"></tbody>
                </table>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-4">
                <button onclick="window.generateZPL()" class="btn-gold py-4">Gerar ZPL</button>
                <button onclick="window.downloadFile()" class="bg-gray-800 text-white font-bold rounded-lg uppercase text-[10px]">Baixar .ZPL</button>
                <button onclick="window.copyZPL()" class="col-span-2 bg-gray-900 text-gray-400 py-2 rounded text-[10px] uppercase font-bold">Copiar Código</button>
            </div>
            <textarea id="finalZPL" class="hidden w-full mt-4 h-20 bg-black text-green-500 p-2 text-[10px] border border-gray-800"></textarea>
        </section>

        <footer class="text-center py-6">
            <div class="dev-footer text-xl">Benilson Amorim</div>
            <p class="text-[9px] text-gray-600 uppercase tracking-widest mt-1">ZK47 Galactic Protocol &copy; 2024</p>
        </footer>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const SUPABASE_URL = "https://dxaqwlslywmxucbjjdfj.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5cHh5emJxYnd6aXprcmx4aHZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NzcxMDgsImV4cCI6MjA4MzQ1MzEwOH0.Lh6l-ElPaYK09ssy7LlxGhJ4jY7ORVIq7iDMv85ZC3c";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        window.inventory = [];
        window.queue = [];
        window.mode = 'validade';
        window.subMode = 'unit';

        // --- FETCH E REALTIME ---
        async function fetchQueue() {
            const { data } = await supabase.from('print_queue').select('*').order('id', { ascending: true });
            window.queue = data || [];
            window.updateUI();
        }

        supabase.channel('custom-all-channel')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'print_queue' }, () => fetchQueue())
            .subscribe();

        fetchQueue();

        // --- LÓGICA DE EXCEL ---
        window.handleFileUpload = async (input) => {
            const f = input.files[0]; if (!f) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                window.inventory = json.slice(1).map(x => ({
                    COD: String(x[0]||"").trim(), NOM: String(x[1]||"").trim(),
                    RUA: String(x[4]||"").trim(), RCK: String(x[5]||"").trim(),
                    LIN: String(x[6]||"").trim(), COL: String(x[7]||"").trim()
                })).filter(i => i.COD);
                document.getElementById('prodCount').innerText = `${window.inventory.length} itens`;
                document.getElementById('btnPush').classList.remove('hidden');
            };
            reader.readAsArrayBuffer(f);
        };

        window.saveToCloud = async () => {
            await supabase.from('products').delete().neq('id', 0);
            const CHUNK = 500;
            for(let i=0; i < window.inventory.length; i += CHUNK) {
                await supabase.from('products').insert(window.inventory.slice(i, i + CHUNK));
            }
            alert("Base sincronizada com a nuvem!");
        };

        window.loadFromCloud = async () => {
            const { data } = await supabase.from('products').select('*');
            if(data) {
                window.inventory = data;
                document.getElementById('prodCount').innerText = `${data.length} itens (Nuvem)`;
            }
        };

        // --- LÓGICA DE SCANNER E BUSCA ---
        window.handleCodeChange = (el) => {
            const clean = el.value.replace(/\D/g,'');
            const p = window.findProd(clean);
            const display = window.mode === 'validade' ? 'valName' : 'endName';
            document.getElementById(display).innerText = p ? p.NOM : "Não encontrado";
        };

        window.findProd = (code) => {
            if(!code) return null;
            const full = String(code);
            const short = full.length === 13 ? full.slice(7, 12) : full.slice(-5);
            return window.inventory.find(i => String(i.COD) === full || String(i.COD) === short || String(i.COD) === String(parseInt(short)));
        };

        // --- ADICIONAR ITEM ---
        window.addItem = async (m) => {
            document.getElementById('loader').classList.remove('hidden');
            
            if (m === 'endereco' && window.subMode === 'mass') {
                const list = document.getElementById('endList').value.split(/[\n,;\s]+/).filter(x => x);
                const items = list.map(c => {
                    const p = window.findProd(c) || { NOM: 'Desconhecido' };
                    return { codigo: c, tempName: p.NOM, fullData: p, created_at: Date.now() };
                });
                await supabase.from('print_queue').insert(items);
                document.getElementById('endList').value = "";
            } else {
                const idCode = m === 'validade' ? 'valCode' : 'endCode';
                const code = document.getElementById(idCode).value;
                const p = window.findProd(code) || { NOM: 'Desconhecido' };
                const qty = parseInt(document.getElementById('valQty')?.value) || 1;
                const val = document.getElementById('valDate')?.value || "";
                
                const batch = [];
                for(let i=0; i<qty; i++) {
                    batch.push({ codigo: code, validade: val, tempName: p.NOM, fullData: p, created_at: Date.now() });
                }
                await supabase.from('print_queue').insert(batch);
                document.getElementById(idCode).value = "";
                if(document.getElementById('valDate')) document.getElementById('valDate').value = "";
            }
            document.getElementById('loader').classList.add('hidden');
        };

        window.removeItem = async (id) => await supabase.from('print_queue').delete().eq('id', id);
        window.clearQueue = async () => await supabase.from('print_queue').delete().neq('id', 0);

        // --- UI UTILS ---
        window.setMode = (m) => {
            window.mode = m;
            document.getElementById('formValidade').classList.toggle('hidden', m !== 'validade');
            document.getElementById('formEndereco').classList.toggle('hidden', m !== 'endereco');
            document.getElementById('btnVal').className = m === 'validade' ? "flex-1 py-2 rounded bg-yellow-500 text-black font-bold text-xs uppercase" : "flex-1 py-2 rounded text-gray-500 font-bold text-xs uppercase";
            document.getElementById('btnEnd').className = m === 'endereco' ? "flex-1 py-2 rounded bg-yellow-500 text-black font-bold text-xs uppercase" : "flex-1 py-2 rounded text-gray-500 font-bold text-xs uppercase";
        };

        window.setSubMode = (s) => {
            window.subMode = s;
            document.getElementById('areaUnit').classList.toggle('hidden', s !== 'unit');
            document.getElementById('areaMass').classList.toggle('hidden', s !== 'mass');
            document.getElementById('subUnit').classList.toggle('text-yellow-500', s === 'unit');
            document.getElementById('subMass').classList.toggle('text-yellow-500', s === 'mass');
        };

        window.maskDate = (val) => {
            let v = val.replace(/\D/g,'');
            if(v.length >= 2) v = v.substring(0,2) + '/' + v.substring(2,6);
            return v;
        };
        // Aplica mascara no input de data
        document.getElementById('valDate').addEventListener('keyup', (e) => {
            if(e.key !== 'Backspace') e.target.value = window.maskDate(e.target.value);
        });

        window.updateUI = () => {
            const tb = document.getElementById('queueTable');
            document.getElementById('queueBadge').innerText = window.queue.length;
            tb.innerHTML = window.queue.map((i, idx) => `
                <tr class="border-b border-gray-900">
                    <td class="p-3 text-gray-600 font-bold">${idx+1}</td>
                    <td class="p-3">
                        <div class="font-bold text-gray-200">${i.codigo}</div>
                        <div class="text-[9px] text-gray-500 uppercase">${i.tempName}</div>
                    </td>
                    <td class="p-3 text-yellow-500 font-bold">${i.validade || '--'}</td>
                    <td class="p-3 text-right">
                        <button onclick="window.removeItem(${i.id})" class="text-red-500"><i class="fa-solid fa-xmark"></i></button>
                    </td>
                </tr>`).join('');
            document.getElementById('btnDownload').disabled = window.queue.length === 0;
        };

        window.generateZPL = () => {
            let zpl = "";
            window.queue.forEach((item, idx) => {
                const d = item.fullData || {};
                const fullCod = item.codigo;
                const shortCod = fullCod.length === 13 ? fullCod.slice(7, 12) : fullCod.slice(-5);
                
                if (idx % 2 === 0) zpl += "^XA\n^CI28^PW812^LL1218^LH0,0\n";
                const y = (idx % 2 === 0) ? 0 : 600;

                zpl += `^FO0,${y+10}^A0N,120,80^FB812,1,0,C,1^FD${shortCod}^FS\n`;
                if(item.validade) {
                    zpl += `^FO235,${y+20}^GB550,65,75^FS\n`;
                    zpl += `^FO250,${y+30}^A0N,95,90^FR^FDVAL: ${item.validade}^FS\n`;
                }
                zpl += `^FO20,${y+140}^A0N,70,70^FB770,2,0,L,0^FD${d.NOM||item.tempName}^FS\n`;
                zpl += `^FO20,${y+300}^A0N,45,45^FDRUA: ${d.RUA||'--'} - RCK: ${d.RCK||'--'}^FS\n`;
                zpl += `^FO20,${y+350}^A0N,45,45^FDLIN: ${d.LIN||'--'} - COL: ${d.COL||'--'}^FS\n`;
                zpl += `^BY3,3,130^FO110,${y+410}^BCN,130,Y,N,N^FD${fullCod}^FS\n`;
                
                if (idx % 2 !== 0 || idx === window.queue.length - 1) zpl += "^XZ\n";
            });
            document.getElementById('finalZPL').value = zpl;
            document.getElementById('finalZPL').classList.remove('hidden');
        };

        window.downloadFile = () => {
            const blob = new Blob([document.getElementById('finalZPL').value], {type: 'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = "etiquetas.zpl"; a.click();
        };

        window.copyZPL = () => {
            const area = document.getElementById('finalZPL');
            area.select(); document.execCommand('copy');
            alert("Código copiado!");
        };
    </script>
</body>
</html>
