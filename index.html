<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZPL ZK47 PRO</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --gold: #FFD700; --bg: #010409; }
        body { background-color: var(--bg); color: white; font-family: sans-serif; overflow-x: hidden; }
        .glass { background: #0d1117; border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 1.5rem; padding: 1.5rem; }
        .input-pro { background: #000; border: 1px solid #30363d; color: white; padding: 12px; border-radius: 10px; width: 100%; font-size: 1.2rem; text-align: center; outline: none; }
        .input-pro:focus { border-color: var(--gold); }
        .btn-primary { background: linear-gradient(to bottom, #FFD700, #B8860B); color: black; font-weight: 800; padding: 14px; border-radius: 12px; width: 100%; text-transform: uppercase; }
        .dev-footer { background: linear-gradient(to right, #FFD700, #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; text-transform: uppercase; }
        .alien-logo { filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.5)); animation: float 4s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body class="p-2 md:p-6 flex flex-col items-center">

    <div id="loader" class="fixed inset-0 z-[100] bg-black/90 flex flex-col items-center justify-center hidden">
        <div class="w-12 h-12 border-4 border-yellow-600 border-t-white rounded-full animate-spin"></div>
    </div>

    <div class="w-full max-w-lg space-y-4 pb-20">
        
        <!-- HEADER APENAS ET -->
        <header class="flex flex-col items-center glass">
            <div class="alien-logo w-20 h-20">
                <svg viewBox="0 0 100 100" class="fill-yellow-500">
                    <path d="M50,10 C30,10 15,30 15,55 C15,75 35,90 50,90 C65,90 85,75 85,55 C85,30 70,10 50,10 Z" />
                    <ellipse cx="32" cy="50" rx="12" ry="18" fill="#000" transform="rotate(-15 32 50)" />
                    <ellipse cx="68" cy="50" rx="12" ry="18" fill="#000" transform="rotate(15 68 50)" />
                </svg>
            </div>
            <div id="syncStatus" class="text-[9px] font-bold text-emerald-500 uppercase tracking-widest mt-2">Sistema Online</div>
        </header>

        <!-- DATABASE -->
        <section class="glass space-y-3">
            <div class="flex justify-between items-center text-[10px] font-bold text-yellow-600">
                <span>DATABASE NODE</span>
                <button onclick="window.loadFromCloud()" class="underline">SYNC NUVEM</button>
            </div>
            <input type="file" id="fileInput" class="hidden" onchange="window.handleFileUpload(this)">
            <button onclick="document.getElementById('fileInput').click()" class="border border-dashed border-gray-600 w-full py-3 rounded-xl text-gray-500 text-xs">
                Importar Excel (.xlsx)
            </button>
            <div id="prodCount" class="text-center text-[10px] text-gray-500 uppercase">0 itens carregados</div>
        </section>

        <!-- INPUTS -->
        <section class="glass space-y-4">
            <div class="flex p-1 bg-black rounded-lg border border-gray-800">
                <button onclick="window.setMode('validade')" id="tabVal" class="flex-1 py-2 rounded-md text-[10px] font-bold bg-yellow-500 text-black">VALIDADE</button>
                <button onclick="window.setMode('endereco')" id="tabEnd" class="flex-1 py-2 rounded-md text-[10px] font-bold text-gray-500">ENDEREÇO</button>
            </div>

            <div id="formValidade" class="space-y-4">
                <input type="text" id="valCode" class="input-pro" placeholder="Bipar Código" autocomplete="off">
                <div id="valPreview" class="text-center text-yellow-500 font-bold text-xs uppercase min-h-[1.2rem]"></div>
                
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="valDate" class="input-pro" placeholder="Data (122026)" maxlength="7" oninput="window.handleDateInput(this)">
                    <input type="number" id="valQty" class="input-pro" value="1">
                </div>
                <button onclick="window.addItem('validade')" class="btn-primary">Adicionar</button>
            </div>

            <div id="formEndereco" class="hidden space-y-4">
                <div class="flex gap-4 justify-center border-b border-gray-800 pb-2">
                    <button onclick="window.setSubMode('unit')" id="subUnit" class="text-[10px] font-bold text-yellow-500 underline">UNITÁRIO</button>
                    <button onclick="window.setSubMode('mass')" id="subMass" class="text-[10px] font-bold text-gray-600">MASSA</button>
                </div>
                <div id="areaUnit">
                    <input type="text" id="endCode" class="input-pro" placeholder="Bipar Unidade" autocomplete="off">
                    <div id="endPreview" class="text-center text-yellow-500 font-bold text-xs uppercase mt-2"></div>
                </div>
                <div id="areaMass" class="hidden">
                    <textarea id="endMassList" class="input-pro h-32 text-xs text-left" placeholder="Cole os códigos aqui..."></textarea>
                </div>
                <button onclick="window.addItem('endereco')" class="btn-primary">Processar</button>
            </div>
        </section>

        <!-- FILA -->
        <section class="glass">
            <div class="flex justify-between items-center mb-4 text-[10px] font-bold uppercase">
                <span>Fila de Impressão (<span id="queueBadge">0</span>)</span>
                <button onclick="window.clearQueue()" class="text-red-500">Limpar</button>
            </div>
            <div class="max-h-60 overflow-y-auto border border-gray-800 rounded-lg custom-scrollbar">
                <table class="w-full text-xs text-left"><tbody id="queueTable" class="divide-y divide-gray-900"></tbody></table>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-4">
                <button onclick="window.generateZPL()" class="btn-primary">Gerar ZPL</button>
                <button id="btnDownload" onclick="window.downloadFile()" disabled class="bg-gray-800 text-white font-bold rounded-lg uppercase text-[10px]">Baixar .ZPL</button>
                <button id="btnCopy" onclick="window.copyZPL()" disabled class="col-span-2 bg-gray-900 text-gray-400 py-3 rounded-lg text-[10px] font-bold uppercase">Copiar Código</button>
            </div>
            <textarea id="finalZPL" class="hidden w-full mt-4 h-20 bg-black text-green-500 p-2 text-[8px] border border-gray-800"></textarea>
        </section>

        <footer class="text-center py-10">
            <div class="dev-footer text-2xl italic">Benilson Amorim</div>
        </footer>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const SUPABASE_URL = "https://dxaqwlslywmxucbjjdfj.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5cHh5emJxYnd6aXprcmx4aHZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NzcxMDgsImV4cCI6MjA4MzQ1MzEwOH0.Lh6l-ElPaYK09ssy7LlxGhJ4jY7ORVIq7iDMv85ZC3c";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        window.inventory = []; window.queue = []; window.mode = 'validade'; window.subMode = 'unit';

        // --- FETCH REALTIME ---
        async function fetchQueue() {
            const { data } = await supabase.from('print_queue').select('*').order('id', { ascending: true });
            window.queue = data || [];
            window.updateUI();
        }
        supabase.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'print_queue' }, () => fetchQueue()).subscribe();
        fetchQueue();

        // --- SCANNER FIX (NÃO APAGA NÚMEROS REPETIDOS) ---
        let scanBuffer = "";
        let scanTimer = null;
        document.addEventListener('keydown', (e) => {
            if(document.activeElement.tagName === 'TEXTAREA' || document.activeElement.type === 'number') return;
            if(e.key === 'Enter') {
                if(scanBuffer.length > 3) {
                    const el = window.mode === 'validade' ? document.getElementById('valCode') : document.getElementById('endCode');
                    el.value = scanBuffer;
                    window.handleSearch(scanBuffer);
                    scanBuffer = "";
                }
                return;
            }
            if(e.key.length === 1 && /[0-9]/.test(e.key)) {
                scanBuffer += e.key;
                clearTimeout(scanTimer);
                scanTimer = setTimeout(() => { scanBuffer = ""; }, 500);
            }
        });

        window.handleSearch = (val) => {
            const p = window.findProd(val);
            const display = window.mode === 'validade' ? 'valPreview' : 'endPreview';
            document.getElementById(display).innerText = p ? p.NOM : "Não Reconhecido";
        };

        window.findProd = (code) => {
            if(!code) return null;
            const full = String(code).trim();
            const short = full.length === 13 ? full.slice(7, 12) : full.slice(-5);
            return window.inventory.find(i => String(i.COD).trim() === full || String(i.COD).trim() === short || String(i.COD).trim() === String(parseInt(short)));
        };

        // --- DATA ---
        window.handleFileUpload = async (input) => {
            const f = input.files[0]; if (!f) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                window.inventory = json.slice(1).map(x => ({
                    COD: String(x[0]||"").trim(), NOM: String(x[1]||"").trim(),
                    RUA: String(x[4]||"").trim(), RCK: String(x[5]||"").trim(),
                    LIN: String(x[6]||"").trim(), COL: String(x[7]||"").trim()
                })).filter(i => i.COD);
                document.getElementById('prodCount').innerText = `${window.inventory.length} MASTER`;
                document.getElementById('btnPush').classList.remove('hidden');
            };
            reader.readAsArrayBuffer(f);
        };

        window.saveToCloud = async () => {
            document.getElementById('loader').classList.remove('hidden');
            await supabase.from('products').delete().neq('id', 0);
            const CHUNK = 400;
            for (let i = 0; i < Math.ceil(window.inventory.length / CHUNK); i++) {
                await supabase.from('products').insert(window.inventory.slice(i*CHUNK, (i+1)*CHUNK));
            }
            document.getElementById('loader').classList.add('hidden');
            alert("Nuvem atualizada!");
        };

        window.loadFromCloud = async () => {
            document.getElementById('loader').classList.remove('hidden');
            const { data } = await supabase.from('products').select('*');
            if(data) {
                window.inventory = data;
                document.getElementById('prodCount').innerText = `${data.length} CLOUD`;
            }
            document.getElementById('loader').classList.add('hidden');
        };

        // --- ADICIONAR ---
        window.addItem = async () => {
            document.getElementById('loader').classList.remove('hidden');
            const m = window.mode;
            
            if (m === 'endereco' && window.subMode === 'mass') {
                const list = document.getElementById('endMassList').value.split(/[\n,;\s]+/).filter(x => x);
                const batch = list.map(c => {
                    const p = window.findProd(c) || { NOM: 'Desconhecido' };
                    return { codigo: c, tempName: p.NOM, fullData: p, created_at: Date.now() };
                });
                await supabase.from('print_queue').insert(batch);
                document.getElementById('endMassList').value = "";
            } else {
                const inputEl = document.getElementById(m === 'validade' ? 'valCode' : 'endCode');
                const code = inputEl.value;
                if(!code) { document.getElementById('loader').classList.add('hidden'); return; }
                
                const p = window.findProd(code) || { NOM: 'Desconhecido' };
                const qty = parseInt(document.getElementById('valQty').value) || 1;
                const date = document.getElementById('valDate').value;
                
                const batch = [];
                for(let i=0; i<qty; i++) {
                    batch.push({ codigo: code, validade: date, tempName: p.NOM, fullData: p, created_at: Date.now() + i });
                }
                await supabase.from('print_queue').insert(batch);
                inputEl.value = ""; document.getElementById('previewName').innerText = "";
            }
            document.getElementById('loader').classList.add('hidden');
        };

        window.removeItem = async (id) => await supabase.from('print_queue').delete().eq('id', id);
        window.clearQueue = async () => { if(confirm("Limpar?")) await supabase.from('print_queue').delete().neq('id', 0); };

        window.handleDateInput = (el) => {
            let v = el.value.replace(/\D/g,'');
            if(v.length >= 2) v = v.substring(0,2) + '/' + v.substring(2,6);
            el.value = v;
        };

        window.updateUI = () => {
            const tb = document.getElementById('queueTable');
            document.getElementById('queueBadge').innerText = window.queue.length;
            tb.innerHTML = window.queue.map((i, idx) => `
                <tr class="border-b border-gray-900">
                    <td class="p-3 text-gray-700">${idx+1}</td>
                    <td class="p-3">
                        <div class="font-bold text-gray-200">${i.codigo}</div>
                        <div class="text-[9px] text-gray-500 uppercase">${i.tempName}</div>
                    </td>
                    <td class="p-3 text-yellow-500 font-bold">${i.validade || '--'}</td>
                    <td class="p-3 text-right"><button onclick="window.removeItem(${i.id})" class="text-red-500">X</button></td>
                </tr>`).join('');
            document.getElementById('btnDownload').disabled = window.queue.length === 0;
            document.getElementById('btnCopy').disabled = window.queue.length === 0;
        };

        window.setMode = (m) => {
            window.mode = m;
            document.getElementById('formValidade').classList.toggle('hidden', m !== 'validade');
            document.getElementById('formEndereco').classList.toggle('hidden', m !== 'endereco');
            document.getElementById('tabVal').className = m === 'validade' ? "flex-1 py-2 rounded-lg text-[10px] font-black bg-yellow-500 text-black" : "flex-1 py-2 text-[10px] font-black text-slate-500";
            document.getElementById('tabEnd').className = m === 'endereco' ? "flex-1 py-2 rounded-lg text-[10px] font-black bg-yellow-600 text-black" : "flex-1 py-2 text-[10px] font-black text-slate-500";
        };

        window.setSubMode = (s) => {
            window.subMode = s;
            document.getElementById('areaUnit').classList.toggle('hidden', s !== 'unit');
            document.getElementById('areaMass').classList.toggle('hidden', s !== 'mass');
            document.getElementById('subUnit').className = s === 'unit' ? "flex-1 text-[10px] font-black text-yellow-500 underline" : "flex-1 text-[10px] text-slate-600";
            document.getElementById('subMass').className = s === 'mass' ? "flex-1 text-[10px] font-black text-yellow-500 underline" : "flex-1 text-[10px] text-slate-600";
        };

        window.generateZPL = () => {
            let full = "";
            for(let i=0; i<window.queue.length; i+=2) {
                let t = window.queue[i], b = window.queue[i+1];
                const render = (item, y) => {
                    if(!item) return "";
                    const d = item.fullData || {};
                    const fullCod = item.codigo;
                    const shortCod = fullCod.length === 13 ? fullCod.slice(7, 12) : fullCod.slice(-5);
                    return `^FO0,${y+10}^A0N,120,80^FB812,1,0,C,1^FD${shortCod}^FS\n` +
                           (item.validade ? `^FO235,${y+20}^GB550,65,75^FS\n^FO250,${y+30}^A0N,95,90^FR^FDVAL: ${item.validade}^FS\n` : "") +
                           `^FO20,${y+140}^A0N,70,70^FB770,2,0,L,0^FD${item.tempName}^FS\n` +
                           `^FO20,${y+300}^A0N,45,45^FDRUA: ${d.RUA||'--'} - RCK: ${d.RCK||'--'}^FS\n` +
                           `^FO20,${y+350}^A0N,45,45^FDLIN: ${d.LIN||'--'} - COL: ${d.COL||'--'}^FS\n` +
                           `^BY3,3,130^FO110,${y+410}^BCN,130,Y,N,N^FD${fullCod}^FS\n`;
                };
                full += `^XA\n^CI28^PW812^LL1218^LH0,0\n${render(t, 0)}${render(b, 600)}^XZ\n`;
            }
            document.getElementById('finalZPL').value = full;
            document.getElementById('finalZPL').classList.remove('hidden');
        };

        window.copyZPL = () => { document.getElementById('finalZPL').select(); document.execCommand('copy'); alert("ZPL Copiado!"); };
        window.downloadFile = () => { const blob = new Blob([document.getElementById('finalZPL').value], {type: 'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `zk47_out.zpl`; a.click(); };
        window.showToast = (msg) => { const t = document.getElementById('toast'); t.querySelector('span').innerText = msg; t.style.opacity = "1"; setTimeout(() => t.style.opacity = "0", 3000); };
    </script>
</body>
</html>
