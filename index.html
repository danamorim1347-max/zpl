<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZPL ZK47 PRO | Logística</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        :root { --gold: #FFD700; --bg: #010409; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: #f8fafc; background-image: radial-gradient(circle at 50% -20%, #443308 0%, transparent 50%); }
        .glass { background: #0d1117; border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 1.5rem; }
        .input-pro { background: #000; border: 1px solid #30363d; color: white; outline: none; font-family: 'JetBrains Mono', monospace; border-radius: 12px; text-align: center; }
        .input-pro:focus { border-color: var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); }
        .input-pro:focus::placeholder { color: #aaa; }
        .input-active { border-color: var(--gold) !important; background: #1a1608 !important; }
        .btn-primary { background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); border-radius: 14px; font-weight: 800; color: #000; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #0d1117; border: 1px solid var(--gold); border-radius: 14px; font-weight: 800; color: var(--gold); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-gold-outline { background: transparent; border: 2px solid var(--gold); border-radius: 14px; font-weight: 800; color: var(--gold); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-gold-outline:disabled { opacity: 0.5; cursor: not-allowed; }
        .tab-btn { flex: 1; padding: 10px; font-size: 11px; font-weight: 900; text-transform: uppercase; color: #64748b; cursor: pointer; border-radius: 8px; }
        .tab-btn.active { background-color: var(--gold); color: #000; }
        .item-row.done { opacity: 0.3; background: #061108 !important; border-left: 4px solid #10b981; }
        .kb-key { background: #161b22; border: 1px solid #30363d; border-radius: 12px; text-align: center; font-weight: 800; font-size: 1.4rem; color: #fff; cursor: pointer; user-select: none; }
        .kb-key:active { background: var(--gold); color: #000; }
        .kb-key:disabled { opacity: 0.3; }
        @media print {
            body { background: white !important; color: black !important; }
            .no-print { display: none !important; }
            .print-area .glass { display: flex !important; background: white; border: none; color: black; }
            .glass { background: white; color: black; }
            .item-row.done { opacity: 0.3; filter: grayscale(1); }
            #mainTableBody, #mainTableBody * { color: black !important; }
            .font-white { color: black !important; }
        }
    </style>
</head>
<body class="min-h-screen p-2 flex flex-col items-center">

    <!-- Loader global -->
    <div id="loader" class="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center hidden">
        <div class="w-12 h-12 border-4 border-t-yellow-500 rounded-full animate-spin"></div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-4 right-4 bg-yellow-500 text-black px-6 py-3 rounded-xl font-black text-xs opacity-0 transition-all duration-300 z-[9999]"><span></span></div>

    <div class="w-full max-w-6xl space-y-4">
        <!-- Header -->
        <header class="flex justify-between items-center glass p-4 no-print">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-barcode text-yellow-500"></i>
                <h1 class="font-black text-sm uppercase">ZK47 <span class="text-yellow-500">PRO</span></h1>
            </div>
            <div class="flex gap-2">
                <button id="syncBtn" onclick="App.syncInventory()" class="bg-yellow-900/20 text-yellow-500 px-3 py-2 rounded-xl text-[10px] font-black uppercase flex items-center gap-1">
                    <i class="fa-solid fa-rotate"></i> Sincronizar
                </button>
                <label class="bg-slate-800 text-slate-400 px-3 py-2 rounded-xl text-[10px] font-black cursor-pointer uppercase flex items-center gap-1">
                    <i class="fa-solid fa-database"></i> Importar Cadastro
                    <input type="file" class="hidden" accept=".xlsx,.xls,.csv" onchange="App.handleFileUpload(this)">
                </label>
                <label class="bg-blue-800/30 text-blue-400 px-3 py-2 rounded-xl text-[10px] font-black cursor-pointer uppercase flex items-center gap-1">
                    <i class="fa-solid fa-file-import"></i> Importar Pedidos
                    <input type="file" class="hidden" accept=".xlsx,.xls,.csv" onchange="App.importOrderSheet(this)">
                </label>
            </div>
        </header>

        <!-- Conteúdo principal -->
        <main class="grid grid-cols-1 lg:grid-cols-12 gap-4">
            <!-- Coluna esquerda (controles) -->
            <div class="lg:col-span-4 space-y-4 no-print">
                <section class="glass p-5">
                    <!-- Abas -->
                    <div class="flex p-1 bg-slate-900 rounded-xl mb-4 border border-slate-800">
                        <button id="tabEti" onclick="App.setMode('etiqueta')" class="tab-btn active">Etiquetas</button>
                        <button id="tabSep" onclick="App.setMode('separacao')" class="tab-btn">Separação</button>
                    </div>

                    <!-- View Etiqueta -->
                    <div id="etiquetaView" class="space-y-4">
                        <input type="text" id="mainCode" class="input-pro w-full p-3" placeholder="Bipar Código" onfocus="App.setActiveInput(this)" oninput="App.updateSearch(this.value)">
                        <div id="previewName" class="text-center font-black text-yellow-500 text-[11px] h-4 uppercase"></div>
                        <div id="liveAddress" class="grid grid-cols-4 gap-1 opacity-0">
                            <div class="bg-black/50 p-1 rounded text-center"><div class="text-[7px] text-slate-500">RUA</div><div id="lRua" class="text-xs font-bold">-</div></div>
                            <div class="bg-black/50 p-1 rounded text-center"><div class="text-[7px] text-slate-500">RCK</div><div id="lRack" class="text-xs font-bold">-</div></div>
                            <div class="bg-black/50 p-1 rounded text-center"><div class="text-[7px] text-slate-500">LIN</div><div id="lLin" class="text-xs font-bold">-</div></div>
                            <div class="bg-black/50 p-1 rounded text-center"><div class="text-[7px] text-slate-500">COL</div><div id="lCol" class="text-xs font-bold">-</div></div>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <!-- DATA AUTOMÁTICA COM BARRA -->
                            <input type="text" id="valDate" class="input-pro text-xs p-2" placeholder="MM/AAAA" maxlength="7" onfocus="App.setActiveInput(this); App.setCurrentDate(this);" oninput="App.formatDate(this)">
                            <input type="text" id="valQtyEtq" class="input-pro text-xs p-2" value="1" onfocus="App.setActiveInput(this)" oninput="this.value = this.value.replace(/\D/g,'')">
                            <input type="text" id="valQtyItens" class="input-pro text-xs p-2" placeholder="Qtd Itens" onfocus="App.setActiveInput(this)" oninput="this.value = this.value.replace(/\D/g,'')">
                        </div>
                        
                        <!-- Botões de ação principais -->
                        <div class="grid grid-cols-2 gap-2">
                            <button id="btnGerarEtiquetasDownload" onclick="App.generateZPL('download')" class="btn-primary py-3 uppercase text-xs">
                                <i class="fa-solid fa-download"></i> DOWNLOAD
                            </button>
                            <button id="btnGerarEtiquetasCopy" onclick="App.generateZPL('copy')" class="btn-gold-outline py-3 uppercase text-xs">
                                <i class="fa-solid fa-copy"></i> COPIAR
                            </button>
                        </div>
                        
                        <button id="btnAddEtiqueta" onclick="App.addItemToQueue()" class="btn-secondary w-full py-3 uppercase text-xs">
                            <i class="fa-solid fa-plus"></i> Adicionar
                        </button>
                    </div>

                    <!-- View Separação -->
                    <div id="separacaoView" class="hidden space-y-4">
                        <textarea id="bulkList" class="input-pro w-full p-4 h-32 text-left" placeholder="Código | Nome | Quantidade (cole da planilha)" onfocus="App.setActiveInput(this)"></textarea>
                        <button id="btnGerarChecklist" onclick="App.processBulkSeparation()" class="btn-primary w-full py-3 uppercase text-xs">
                            <i class="fa-solid fa-list-check"></i> Gerar Checklist
                        </button>
                    </div>
                </section>

                <!-- Teclado virtual -->
                <section id="keyboard" class="grid grid-cols-3 gap-2 bg-slate-900/50 p-4 rounded-[2rem]"></section>
            </div>

            <!-- Coluna direita (lista) -->
            <div class="lg:col-span-8 space-y-4 print-area">
                <section class="glass p-6 min-h-[600px] flex flex-col">
                    <div id="headerList" class="flex justify-between items-center mb-6">
                        <h2 id="listTitle" class="font-black text-xs uppercase text-slate-400">
                            <i class="fa-solid fa-list mr-1"></i> Fila
                        </h2>
                        <div class="flex gap-2 no-print">
                            <button id="btnPrint" onclick="App.printList()" class="hidden border border-yellow-500/20 px-3 py-1 rounded text-yellow-500 text-[10px] flex items-center gap-1">
                                <i class="fa-solid fa-print"></i> Imprimir
                            </button>
                            <button id="btnExportSeparation" onclick="App.exportSeparationToExcel()" class="hidden border border-green-500/20 px-3 py-1 rounded text-green-500 text-[10px] flex items-center gap-1">
                                <i class="fa-solid fa-file-excel"></i> EXPORTAR EXCEL
                            </button>
                            <button onclick="App.clearCurrentCollection()" class="border border-red-500/20 px-3 py-1 rounded text-red-500 text-[10px] flex items-center gap-1">
                                <i class="fa-solid fa-trash-can"></i> LIMPAR
                            </button>
                        </div>
                    </div>
                    <div class="flex-grow overflow-y-auto max-h-[400px]">
                        <table class="w-full text-left">
                            <tbody id="mainTableBody" class="divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                    <div id="footerActions" class="mt-6 pt-4 border-t border-slate-800 flex flex-col gap-2"></div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        // ==================== FIREBASE INICIALIZAÇÃO ====================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCiy4DOVPYYr_UtglmnVWUdZ8SqM26Neo8",
            authDomain: "zpl47-f751d.firebaseapp.com",
            projectId: "zpl47-f751d",
            databaseURL: "https://zpl47-f751d-default-rtdb.firebaseio.com"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ==================== APLICATIVO ====================
        window.App = {
            // Estado
            inventory: [],
            mode: 'etiqueta',
            activeInput: null,
            unsubscribeQueue: null,
            unsubscribeSeparation: null,
            unsubscribeMaster: null,
            toastTimeout: null,

            // Utilitários
            extractId(code) {
                if (!code) return '';
                const str = String(code).replace(/\D/g, '');
                return str.length === 13 ? str.substring(7, 12) : str;
            },

            // ========== NORMALIZA PRODUTO ==========
            normalizeProduct(prod) {
                if (!prod) return null;
                return {
                    COD: String(prod.COD || prod.codigo || '').trim(),
                    NOM: String(prod.NOM || prod.nome || prod.descricao || 'S/N').trim(),
                    RUA: String(prod.RUA || prod.rua || '').trim(),
                    RCK: String(prod.RCK || prod.rack || '').trim(),
                    LIN: String(prod.LIN || prod.linha || '').trim(),
                    COL: String(prod.COL || prod.coluna || '').trim(),
                    QTD_ITENS: String(prod.QTD_ITENS || prod.qtd_itens || prod.quantidade || '').trim()
                };
            },

            // ========== DATA AUTOMÁTICA COM BARRA ==========
            setCurrentDate(input) {
                if (!input.value) {
                    const now = new Date();
                    const mes = String(now.getMonth() + 1).padStart(2, '0');
                    const ano = now.getFullYear();
                    input.value = `${mes}/${ano}`;
                    this.validateDate(input);
                }
            },

            // ========== FORMATADOR DE DATA COM BARRA ==========
            formatDate(input) {
                let v = input.value.replace(/\D/g, '');
                if (v.length > 6) v = v.slice(0, 6);
                
                if (v.length >= 2) {
                    v = v.slice(0, 2) + '/' + v.slice(2);
                }
                
                input.value = v;
                this.validateDate(input);
            },

            // ========== VALIDAÇÃO DE DATA ==========
            validateDate(input) {
                const v = input.value;
                if (v.length === 7) { // Formato MM/AAAA
                    const mes = parseInt(v.slice(0, 2), 10);
                    if (mes < 1 || mes > 12) {
                        this.showToast("Mês inválido", 3000);
                        input.classList.add('border-red-500');
                    } else {
                        input.classList.remove('border-red-500');
                    }
                }
            },

            // ========== INVENTÁRIO EM TEMPO REAL ==========
            listenMasterProducts() {
                if (this.unsubscribeMaster) this.unsubscribeMaster();
                this.unsubscribeMaster = onValue(ref(db, "master_products"), (snap) => {
                    this._updateInventoryFromSnapshot(snap);
                }, (error) => {
                    console.error("Erro ao ouvir master_products:", error);
                });
            },

            _updateInventoryFromSnapshot(snap) {
                if (snap.exists()) {
                    const data = snap.val();
                    this.inventory = Object.values(data)
                        .filter(p => p.COD && String(p.COD).trim() !== '')
                        .map(p => this.normalizeProduct(p));
                    console.log("Inventário atualizado:", this.inventory.length, "itens");
                } else {
                    this.inventory = [];
                    console.log("Inventário vazio");
                }
            },

            // ========== GERENCIAMENTO DE LISTENERS ==========
            attachListener() {
                if (this.unsubscribeQueue) this.unsubscribeQueue();
                if (this.unsubscribeSeparation) this.unsubscribeSeparation();

                const path = this.mode === 'etiqueta' ? "print_queue" : "active_separation";
                if (this.mode === 'etiqueta') {
                    this.unsubscribeQueue = onValue(ref(db, path), (snap) => {
                        this.renderQueue(snap.val());
                    });
                } else {
                    this.unsubscribeSeparation = onValue(ref(db, path), (snap) => {
                        this.renderSeparation(snap.val());
                    });
                }
            },

            // ========== RENDERIZAÇÃO ==========
            renderQueue(data) {
                const items = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
                const body = document.getElementById('mainTableBody');
                body.innerHTML = items.map(i => `
                    <tr class="text-[11px]">
                        <td class="p-2 font-bold">
                            ${i.tempName || ''}<br>
                            <span class="text-slate-500">${i.codigo_barras || ''}</span>
                        </td>
                        <td class="text-yellow-500 text-center">${i.validade || '-'}</td>
                        <td class="text-right">
                            ${i.qtdItens ? 'Q:' + i.qtdItens : ''}
                            <button onclick="App.deleteItem('${i.id}')" class="text-red-500 no-print ml-2">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                document.getElementById('footerActions').innerHTML = `
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btnDownloadZpl" onclick="App.generateZPL('download')" class="btn-primary py-3 text-[10px]">
                            <i class="fa-solid fa-download"></i> DOWNLOAD ZPL
                        </button>
                        <button id="btnCopyZpl" onclick="App.generateZPL('copy')" class="btn-secondary py-3 text-[10px]">
                            <i class="fa-solid fa-copy"></i> COPIAR ZPL
                        </button>
                    </div>
                `;
                document.getElementById('btnPrint').classList.toggle('hidden', this.mode !== 'separacao');
                document.getElementById('btnExportSeparation').classList.toggle('hidden', this.mode !== 'separacao');
            },

            renderSeparation(data) {
                let items = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
                const collator = new Intl.Collator('pt', { numeric: true });
                items.sort((a, b) => collator.compare((a.rua || '') + (a.rack || ''), (b.rua || '') + (b.rack || '')));

                const body = document.getElementById('mainTableBody');
                body.innerHTML = items.map(i => {
                    const endereco = `${i.rua || '-'} ${i.rack || '-'} · ${i.lin || '-'}/${i.col || '-'}`;
                    return `
                    <tr class="item-row ${i.status === 'done' ? 'done' : ''} text-[11px]">
                        <td class="p-2">
                            <div class="bg-slate-800 text-white px-1 py-0.5 rounded text-[9px] uppercase" title="Endereço completo">
                                ${endereco}
                            </div>
                        </td>
                        <td class="p-2">
                            <span class="text-[9px] text-slate-500">${i.code || ''}</span><br>
                            <b class="uppercase">${i.name || ''}</b>
                        </td>
                        <td class="text-center">
                            <div onclick="App.editQuantity('${i.id}', '${i.qty || 1}')" 
                                 class="p-1 rounded bg-yellow-500/10 text-yellow-500 font-black cursor-pointer">
                                ${i.qty || 1}
                            </div>
                        </td>
                        <td class="text-right no-print">
                            <button onclick="App.toggleStatus('${i.id}', '${i.status || 'pending'}')" 
                                    class="w-8 h-8 rounded-full border border-slate-700 ${i.status === 'done' ? 'bg-green-500 text-black' : ''}">
                                <i class="fa-solid fa-check"></i>
                            </button>
                        </td>
                    </tr>
                `}).join('');
                document.getElementById('footerActions').innerHTML = `
                    <div class="text-center text-[9px] text-slate-500 uppercase">
                        <i class="fa-solid fa-location-dot mr-1"></i> Ordenado por endereço
                    </div>
                `;
                document.getElementById('btnPrint').classList.toggle('hidden', this.mode !== 'separacao');
                document.getElementById('btnExportSeparation').classList.toggle('hidden', this.mode !== 'separacao');
            },

            // ========== BUSCA E PREVIEW ==========
            updateSearch(val) {
                const code = this.extractId(val);
                const prod = this.inventory.find(i => i.COD && this.extractId(i.COD) === code);
                const live = document.getElementById('liveAddress');
                if (prod && val.length >= 5) {
                    document.getElementById('previewName').textContent = prod.NOM || 'SEM NOME';
                    document.getElementById('lRua').textContent = prod.RUA || "-";
                    document.getElementById('lRack').textContent = prod.RCK || "-";
                    document.getElementById('lLin').textContent = prod.LIN || "-";
                    document.getElementById('lCol').textContent = prod.COL || "-";
                    live.style.opacity = "1";
                    
                    // PREENCHER QUANTIDADE DE ITENS DO CADASTRO
                    if (prod.QTD_ITENS) {
                        document.getElementById('valQtyItens').value = prod.QTD_ITENS;
                    } else {
                        document.getElementById('valQtyItens').value = '';
                    }
                } else {
                    live.style.opacity = "0";
                    document.getElementById('previewName').textContent = val.length >= 5 ? "NÃO CADASTRADO" : "";
                }
            },

            // ========== MODO ==========
            setMode(m) {
                this.mode = m;
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.toggle('active', b.id === (m === 'etiqueta' ? 'tabEti' : 'tabSep'));
                });
                document.getElementById('etiquetaView').classList.toggle('hidden', m !== 'etiqueta');
                document.getElementById('separacaoView').classList.toggle('hidden', m !== 'separacao');
                document.getElementById('btnPrint').classList.toggle('hidden', m !== 'separacao');
                document.getElementById('btnExportSeparation').classList.toggle('hidden', m !== 'separacao');
                this.attachListener();
            },

            // ========== ADICIONAR ETIQUETA ==========
            async addItemToQueue() {
                const code = document.getElementById('mainCode').value;
                if (!code) {
                    this.showToast("Digite um código");
                    return;
                }
                const prod = this.inventory.find(i => i.COD && this.extractId(i.COD) === this.extractId(code)) || { NOM: "AVULSO", COD: code };
                const normalizedProd = this.normalizeProduct(prod);
                const qtdEtq = parseInt(document.getElementById('valQtyEtq').value) || 1;
                const validade = document.getElementById('valDate').value;
                const qtdItens = document.getElementById('valQtyItens').value;

                const btn = document.getElementById('btnAddEtiqueta');
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Adicionando...';
                try {
                    for (let i = 0; i < qtdEtq; i++) {
                        await push(ref(db, "print_queue"), {
                            codigo_barras: code,
                            validade: validade,
                            qtdItens: qtdItens,
                            tempName: normalizedProd.NOM,
                            fullData: normalizedProd
                        });
                    }
                    this.clearActiveInput();
                    this.showToast(`${qtdEtq} etiqueta(s) adicionada(s)`);
                } catch (e) {
                    this.showToast("Erro ao adicionar", 3000);
                    console.error(e);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-plus"></i> Adicionar';
                }
            },

            // ========== GERAR ZPL ==========
            async generateZPL(action) {
                const snap = await get(ref(db, "print_queue"));
                const items = snap.val() ? Object.values(snap.val()) : [];
                if (!items.length) {
                    this.showToast("Nenhuma etiqueta na fila");
                    return;
                }

                // Desabilitar botões
                const btns = [
                    document.getElementById('btnGerarEtiquetasDownload'),
                    document.getElementById('btnGerarEtiquetasCopy'),
                    document.getElementById('btnDownloadZpl'),
                    document.getElementById('btnCopyZpl')
                ];
                btns.forEach(btn => {
                    if (btn) {
                        btn.disabled = true;
                        if (btn.id.includes('Download')) btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> GERANDO...';
                        if (btn.id.includes('Copy')) btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> COPIANDO...';
                    }
                });

                try {
                    let zpl = "";
                    const cleanText = (txt) => {
                        if (!txt) return "";
                        return String(txt)
                            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                            .toUpperCase()
                            .replace(/[^A-Z0-9\s\/\-.:,]/g, " ");
                    };

                    for (let i = 0; i < items.length; i += 2) {
                        zpl += "^XA\n^CI28\n^PW812\n^LL1218\n";
                        
                        // Etiqueta superior
                        if (items[i]) {
                            const item = items[i];
                            const r = item.fullData || {};
                            const codBarras = item.codigo_barras || '';
                            const y = 0;
                            
                            zpl += `^FO20,${y+20}^A0N,110,100^FD${this.extractId(codBarras)}^FS\n`;
                            
                            if (item.validade && item.validade.trim() !== '') {
                                zpl += `^FO235,${y+10}^GB550,70,80^FS\n`;
                                zpl += `^FO250,${y+20}^A0N,105,100^FR^FDVAL: ${cleanText(item.validade)}^FS\n`;
                            }
                            
                            zpl += `^FO20,${y+150}^A0N,60,60^FB770,2,0,L,0^FD${cleanText(item.tempName)}^FS\n`;
                            
                            const endereco = `${cleanText(r.RUA)} ${cleanText(r.RCK)}  ${cleanText(r.LIN)}/${cleanText(r.COL)}`.trim();
                            zpl += `^FO20,${y+320}^A0N,45,45^FD${endereco || ''}^FS\n`;
                            
                            if (item.qtdItens) {
                                zpl += `^FO580,${y+320}^A0N,80,80^FDQ:${item.qtdItens}^FS\n`;
                            }
                            
                            zpl += `^BY3,3,180^FO60,${y+380}^BCN,180,Y,N,N^FD${codBarras}^FS\n`;
                        }
                        
                        // Etiqueta inferior
                        if (items[i + 1]) {
                            const item = items[i + 1];
                            const r = item.fullData || {};
                            const codBarras = item.codigo_barras || '';
                            const y = 600;
                            
                            zpl += `^FO20,${y+20}^A0N,110,100^FD${this.extractId(codBarras)}^FS\n`;
                            
                            if (item.validade && item.validade.trim() !== '') {
                                zpl += `^FO235,${y+10}^GB550,70,80^FS\n`;
                                zpl += `^FO250,${y+20}^A0N,105,100^FR^FDVAL: ${cleanText(item.validade)}^FS\n`;
                            }
                            
                            zpl += `^FO20,${y+150}^A0N,60,60^FB770,2,0,L,0^FD${cleanText(item.tempName)}^FS\n`;
                            
                            const endereco = `${cleanText(r.RUA)} ${cleanText(r.RCK)}  ${cleanText(r.LIN)}/${cleanText(r.COL)}`.trim();
                            zpl += `^FO20,${y+320}^A0N,45,45^FD${endereco || ''}^FS\n`;
                            
                            if (item.qtdItens) {
                                zpl += `^FO580,${y+320}^A0N,80,80^FDQ:${item.qtdItens}^FS\n`;
                            }
                            
                            zpl += `^BY3,3,180^FO60,${y+380}^BCN,180,Y,N,N^FD${codBarras}^FS\n`;
                        }
                        
                        zpl += "^XZ\n";
                    }

                    if (action === 'copy') {
                        await navigator.clipboard.writeText(zpl);
                        this.showToast("✅ ZPL copiado! Fila limpa.");
                    } else {
                        const blob = new Blob([zpl], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `etiquetas_${new Date().getTime()}.zpl`;
                        a.click();
                        URL.revokeObjectURL(url);
                        this.showToast("✅ Download iniciado! Fila limpa.");
                    }

                    // LIMPAR FILA AUTOMATICAMENTE
                    await remove(ref(db, "print_queue"));

                } catch (e) {
                    this.showToast(`❌ Erro ao ${action === 'copy' ? 'copiar' : 'baixar'}`, 3000);
                    console.error(e);
                } finally {
                    // Restaurar botões
                    btns.forEach(btn => {
                        if (btn) {
                            btn.disabled = false;
                            if (btn.id.includes('Download')) btn.innerHTML = '<i class="fa-solid fa-download"></i> DOWNLOAD';
                            if (btn.id.includes('Copy')) btn.innerHTML = '<i class="fa-solid fa-copy"></i> COPIAR';
                            if (btn.id === 'btnDownloadZpl') btn.innerHTML = '<i class="fa-solid fa-download"></i> DOWNLOAD ZPL';
                            if (btn.id === 'btnCopyZpl') btn.innerHTML = '<i class="fa-solid fa-copy"></i> COPIAR ZPL';
                        }
                    });
                }
            },

            // ========== EXPORTAR LISTA DE SEPARAÇÃO PARA EXCEL ==========
            async exportSeparationToExcel() {
                const snap = await get(ref(db, "active_separation"));
                const items = snap.val() ? Object.keys(snap.val()).map(k => ({ id: k, ...snap.val()[k] })) : [];
                if (!items.length) {
                    this.showToast("Nenhum item na separação");
                    return;
                }

                const btn = document.getElementById('btnExportSeparation');
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> EXPORTANDO...';

                try {
                    const data = items.map(item => ({
                        Código: item.code || '',
                        Produto: item.name || '',
                        Endereço: `${item.rua || ''} ${item.rack || ''} · ${item.lin || ''}/${item.col || ''}`.trim(),
                        Quantidade: item.qty || 1,
                        Status: item.status === 'done' ? 'Concluído' : 'Pendente'
                    }));

                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(data);
                    XLSX.utils.book_append_sheet(wb, ws, 'Separação');
                    XLSX.writeFile(wb, `separacao_${new Date().getTime()}.xlsx`);
                    this.showToast("✅ Checklist exportado!");
                } catch (e) {
                    this.showToast("❌ Erro ao exportar", 3000);
                    console.error(e);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-file-excel"></i> EXPORTAR EXCEL';
                }
            },

            // ========== SEPARAÇÃO – PARSER INTELIGENTE ==========
            async processBulkSeparation() {
                const textarea = document.getElementById('bulkList');
                const lines = textarea.value.split('\n').filter(l => l.trim() !== '');
                if (!lines.length) return;

                const btn = document.getElementById('btnGerarChecklist');
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> GERANDO...';
                document.getElementById('loader').classList.remove('hidden');
                
                try {
                    for (let line of lines) {
                        const tokens = line.trim().split(/[\s|;,]+/).filter(t => t !== '');
                        if (tokens.length === 0) continue;
                        const code = tokens[0];
                        let qty = 1;
                        for (let i = tokens.length - 1; i >= 0; i--) {
                            if (!isNaN(tokens[i]) && tokens[i] !== '') {
                                qty = parseInt(tokens[i], 10);
                                break;
                            }
                        }
                        if (isNaN(qty) || qty <= 0) qty = 1;

                        const prod = this.inventory.find(i => i.COD && this.extractId(i.COD) === this.extractId(code)) 
                                    || { NOM: "NÃO CADASTRADO", COD: code };
                        const normalized = this.normalizeProduct(prod);
                        
                        await push(ref(db, "active_separation"), {
                            code,
                            qty: String(qty),
                            name: normalized.NOM,
                            rua: normalized.RUA || '-',
                            rack: normalized.RCK || '-',
                            lin: normalized.LIN || '-',
                            col: normalized.COL || '-',
                            status: 'pending'
                        });
                    }
                    textarea.value = "";
                    this.showToast("✅ Checklist gerado!");
                } catch (e) {
                    this.showToast("❌ Erro ao processar", 3000);
                    console.error(e);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-list-check"></i> Gerar Checklist';
                    document.getElementById('loader').classList.add('hidden');
                }
            },

            // ========== IMPORTAÇÃO DE PLANILHA DE PEDIDOS ==========
            async importOrderSheet(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    document.getElementById('loader').classList.remove('hidden');
                    try {
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i];
                            if (!row || row.length < 2) continue;
                            const code = String(row[0]).trim();
                            if (!code) continue;
                            
                            let qty = parseInt(row[2] !== undefined ? row[2] : row[1], 10);
                            if (isNaN(qty) || qty <= 0) qty = 1;

                            const prod = this.inventory.find(p => p.COD && this.extractId(p.COD) === this.extractId(code))
                                        || { NOM: "IMPORTADO", COD: code };
                            const normalized = this.normalizeProduct(prod);

                            await push(ref(db, "active_separation"), {
                                code,
                                qty: String(qty),
                                name: normalized.NOM,
                                rua: normalized.RUA || '-',
                                rack: normalized.RCK || '-',
                                lin: normalized.LIN || '-',
                                col: normalized.COL || '-',
                                status: 'pending'
                            });
                        }
                        this.showToast("✅ Pedidos importados!");
                    } catch (e) {
                        this.showToast("❌ Erro ao importar", 3000);
                        console.error(e);
                    } finally {
                        document.getElementById('loader').classList.add('hidden');
                        input.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            },

            // ========== SINCRONIZAÇÃO MANUAL ==========
            async syncInventory() {
                const btn = document.getElementById('syncBtn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> SINCRONIZANDO...';
                document.getElementById('loader').classList.remove('hidden');
                try {
                    const snap = await get(ref(db, "master_products"));
                    this._updateInventoryFromSnapshot(snap);
                    this.showToast(snap.exists() ? "✅ Inventário sincronizado" : "ℹ️ Nenhum produto cadastrado", 3000);
                } catch (e) {
                    this.showToast("❌ Erro na sincronia", 3000);
                    console.error(e);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Sincronizar';
                    document.getElementById('loader').classList.add('hidden');
                }
            },

            // ========== UPLOAD DE EXCEL PARA CADASTRO – PADRÃO FIXO ==========
            // COLUNAS: A=Código, B=Descrição, E=Rua, F=Rack, G=Linha, H=Coluna
            async handleFileUpload(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    
                    // Converter para array de arrays (linhas e colunas)
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    const produtos = {};
                    
                    // Pular cabeçalho (linha 0)
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row || row.length < 1) continue;
                        
                        // Índices das colunas (0-based)
                        // A=0, B=1, C=2, D=3, E=4, F=5, G=6, H=7
                        const codigo = row[0] ? String(row[0]).trim() : '';        // Coluna A
                        const descricao = row[1] ? String(row[1]).trim() : '';     // Coluna B
                        const rua = row[4] ? String(row[4]).trim() : '';           // Coluna E
                        const rack = row[5] ? String(row[5]).trim() : '';          // Coluna F
                        const linha = row[6] ? String(row[6]).trim() : '';         // Coluna G
                        const coluna = row[7] ? String(row[7]).trim() : '';        // Coluna H
                        
                        if (!codigo) continue;
                        
                        const prod = {
                            COD: codigo,
                            NOM: descricao || 'S/N',
                            RUA: rua,
                            RCK: rack,
                            LIN: linha,
                            COL: coluna,
                            QTD_ITENS: '' // Opcional, pode adicionar coluna depois
                        };
                        
                        produtos[codigo] = this.normalizeProduct(prod);
                    }

                    // SUBSTITUI COMPLETAMENTE OS DADOS ANTIGOS
                    await set(ref(db, "master_products"), produtos);
                    
                    // ATUALIZAÇÃO IMEDIATA
                    const newSnap = await get(ref(db, "master_products"));
                    this._updateInventoryFromSnapshot(newSnap);
                    
                    this.showToast(`✅ ${Object.keys(produtos).length} produtos importados! Cadastro substituído.`);
                    input.value = '';
                };
                reader.readAsArrayBuffer(file);
            },

            // ========== AÇÕES DA TABELA ==========
            async deleteItem(id) {
                await remove(ref(db, (this.mode === 'etiqueta' ? 'print_queue' : 'active_separation') + '/' + id));
                this.showToast("Item removido");
            },

            async toggleStatus(id, curStatus) {
                const newStatus = curStatus === 'done' ? 'pending' : 'done';
                await set(ref(db, `active_separation/${id}/status`), newStatus);
            },

            async editQuantity(id, curQty) {
                const newQty = prompt("Nova quantidade:", curQty);
                if (newQty && !isNaN(newQty) && newQty > 0) {
                    await update(ref(db, `active_separation/${id}`), { qty: String(newQty) });
                }
            },

            async clearCurrentCollection() {
                if (!confirm("Limpar toda a lista?")) return;
                const path = this.mode === 'etiqueta' ? "print_queue" : "active_separation";
                await remove(ref(db, path));
                this.showToast("✅ Lista limpa");
            },

            printList() {
                window.print();
            },

            // ========== TECLADO VIRTUAL ==========
            initKeyboard() {
                const kb = document.getElementById('keyboard');
                kb.innerHTML = '';
                for (let i = 1; i <= 9; i++) {
                    kb.appendChild(this.createKey(i));
                }
                kb.appendChild(this.createKey('backspace', '<i class="fa-solid fa-delete-left"></i>'));
                kb.appendChild(this.createKey(0));
                kb.appendChild(this.createKey('clear', 'C'));
            },

            createKey(val, html) {
                const btn = document.createElement('button');
                btn.className = 'kb-key p-4';
                if (val === 'backspace') btn.classList.add('text-red-500');
                if (val === 'clear') btn.classList.add('text-yellow-500');
                btn.innerHTML = html !== undefined ? html : val;
                btn.onclick = (e) => {
                    e.preventDefault();
                    if (val === 'backspace') this.backspace();
                    else if (val === 'clear') this.clearActiveInput();
                    else this.pressKey(String(val));
                };
                return btn;
            },

            pressKey(v) {
                if (this.activeInput) {
                    this.activeInput.value += v;
                    if (this.activeInput.id === 'mainCode') this.updateSearch(this.activeInput.value);
                }
            },

            backspace() {
                if (this.activeInput) {
                    this.activeInput.value = this.activeInput.value.slice(0, -1);
                    if (this.activeInput.id === 'mainCode') this.updateSearch(this.activeInput.value);
                }
            },

            clearActiveInput() {
                if (this.activeInput) {
                    this.activeInput.value = "";
                    if (this.activeInput.id === 'mainCode') this.updateSearch("");
                }
            },

            setActiveInput(el) {
                this.activeInput = el;
                document.querySelectorAll('.input-pro').forEach(i => i.classList.remove('input-active'));
                el.classList.add('input-active');
            },

            // ========== TOAST ==========
            showToast(msg, duration = 2000) {
                if (this.toastTimeout) clearTimeout(this.toastTimeout);
                const toast = document.getElementById('toast');
                toast.querySelector('span').textContent = msg;
                toast.classList.remove('opacity-0');
                this.toastTimeout = setTimeout(() => {
                    toast.classList.add('opacity-0');
                }, duration);
            }
        };

        // ==================== INICIALIZAÇÃO ====================
        window.addEventListener('DOMContentLoaded', () => {
            App.initKeyboard();
            App.listenMasterProducts();
            App.setMode('etiqueta');
            App.updateSearch('');
        });

        window.App = App;
    </script>
</body>
</html>
