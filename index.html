<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZPL ZK47 PRO | Dev. Benilson Amorim</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        :root { --gold: #FFD700; --bg: #010409; }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: #f8fafc; overflow-x: hidden; background-image: radial-gradient(circle at 50% -20%, #443308 0%, transparent 50%); }
        .glass { background: #0d1117; border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 1.5rem; padding: 1.2rem; }
        .input-pro { background: #000; border: 1px solid #30363d; color: white; outline: none; font-family: 'JetBrains Mono', monospace; border-radius: 12px; padding: 12px; width: 100%; font-size: 1.2rem; font-weight: bold; text-align: center; }
        .input-pro:focus { border-color: var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); }
        .input-active { border-color: var(--gold) !important; background: #1a1608 !important; }
        
        .btn-primary { background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); border-radius: 14px; font-weight: 800; text-transform: uppercase; color: #000; padding: 14px; width: 100%; cursor: pointer; border: none; }
        .btn-primary:active { transform: scale(0.95); }

        .app-kb { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; background: #0d1117; padding: 12px; border-radius: 20px; border: 1px solid #443308; }
        .kb-key { background: #161b22; border: 1px solid #30363d; padding: 15px; border-radius: 12px; text-align: center; font-weight: 800; font-size: 1.4rem; color: #fff; cursor: pointer; user-select: none; }
        .kb-key:active { background: var(--gold); color: #000; }
        .kb-key-action { background: #B8860B; color: #000; }

        .tab-btn { flex: 1; padding: 10px; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #64748b; cursor: pointer; border-radius: 8px; }
        .tab-btn.active { background-color: var(--gold); color: #000; }

        .location-card { background: #0d1117; border: 2px solid #FFD700; border-radius: 20px; animation: slideUp 0.3s; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #443308; border-radius: 10px; }
        
        /* Adicionar animação suave para aparecimento do textarea */
        #finalZPL {
            transition: all 0.3s ease;
        }
        
        /* Melhorar responsividade em telas muito pequenas */
        @media (max-width: 640px) {
            .app-kb .kb-key {
                padding: 12px 8px;
                font-size: 1.2rem;
            }
            
            .glass {
                padding: 1rem;
            }
        }
        
        /* Indicador visual melhor para modo ativo */
        .tab-btn.active {
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
    </style>
</head>
<body class="min-h-screen p-2 flex flex-col items-center">

    <div id="loader" class="fixed inset-0 z-[100] bg-black/90 flex flex-col items-center justify-center hidden">
        <div class="w-12 h-12 border-4 border-yellow-900/30 border-t-yellow-500 rounded-full animate-spin"></div>
        <p class="mt-4 text-yellow-500 font-black uppercase text-[10px]">Processando...</p>
    </div>

    <div id="toast" class="fixed top-4 right-4 bg-yellow-500 text-black px-6 py-3 rounded-xl font-black uppercase text-xs shadow-2xl opacity-0 transition-all duration-300 z-[9999]">
        <span>Mensagem</span>
    </div>

    <div class="w-full max-w-4xl space-y-4">
        
        <header class="flex flex-col items-center gap-4 glass p-6 rounded-[2.5rem]">
            <i class="fa-solid fa-qrcode text-yellow-500 text-3xl"></i>
            <div class="flex gap-2">
                <button onclick="window.loadFromCloud()" class="bg-yellow-900/20 text-yellow-500 px-4 py-2 rounded-xl text-[10px] font-black border border-yellow-800 uppercase">
                    <i class="fa-solid fa-sync"></i> Cloud Sync
                </button>
                <label class="bg-slate-800 text-slate-400 px-4 py-2 rounded-xl text-[10px] font-black border border-slate-700 uppercase cursor-pointer">
                    <i class="fa-solid fa-file-excel"></i> Importar
                    <input type="file" class="hidden" onchange="window.handleFileUpload(this)" accept=".xlsx">
                </label>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-4">
            <div class="lg:col-span-5 space-y-4">
                <section class="glass p-5 rounded-[2rem]">
                    <div class="flex p-1 bg-slate-900 rounded-xl mb-6 border border-slate-800">
                        <button onclick="window.setMode('validade')" id="tabVal" class="tab-btn active">Validade</button>
                        <button onclick="window.setMode('endereco')" id="tabEnd" class="tab-btn">Endereço</button>
                        <button onclick="window.setMode('localizar')" id="tabLoc" class="tab-btn">Localizar</button>
                    </div>

                    <div class="space-y-4">
                        <div class="relative">
                            <input type="text" id="mainCode" class="input-pro" placeholder="48060 ou EAN-13" inputmode="none" onfocus="window.setActiveInput(this)">
                            <div id="qtySavedIndicator" class="absolute right-3 top-1/2 -translate-y-1/2 hidden bg-green-600 text-white text-[8px] px-2 py-1 rounded-full font-black">SALVO</div>
                        </div>
                        <div id="previewName" class="text-[11px] font-black text-yellow-500 text-center uppercase min-h-[1.5rem]"></div>

                        <div id="locationResult" class="hidden location-card p-4 grid grid-cols-2 gap-2 text-center font-black">
                            <div class="bg-black/60 p-2 rounded-lg border border-yellow-900/30">
                                <div class="text-slate-500 text-[8px] uppercase">Rua</div>
                                <div id="resRua" class="text-xl text-white">--</div>
                            </div>
                            <div class="bg-black/60 p-2 rounded-lg border border-yellow-900/30">
                                <div class="text-slate-500 text-[8px] uppercase">Rack</div>
                                <div id="resRack" class="text-xl text-white">--</div>
                            </div>
                            <div class="bg-black/60 p-2 rounded-lg border border-yellow-900/30">
                                <div class="text-slate-500 text-[8px] uppercase">Linha</div>
                                <div id="resLinha" class="text-xl text-white">--</div>
                            </div>
                            <div class="bg-black/60 p-2 rounded-lg border border-yellow-900/30">
                                <div class="text-slate-500 text-[8px] uppercase">Coluna</div>
                                <div id="resColuna" class="text-xl text-white">--</div>
                            </div>
                        </div>

                        <div id="valRow" class="grid grid-cols-2 gap-3">
                            <input type="text" id="valDate" class="input-pro text-sm" placeholder="MMAAAA" onfocus="window.setActiveInput(this)">
                            <input type="text" id="valQtyEtq" class="input-pro text-sm" value="1" onfocus="window.setActiveInput(this)">
                        </div>

                        <div id="qtyRow" class="flex items-center justify-between p-3 bg-slate-950/50 rounded-xl border border-yellow-900/20">
                            <span class="text-[9px] font-black text-yellow-700 uppercase">Imp. Qtd?</span>
                            <div class="flex gap-2 items-center">
                                <input type="checkbox" id="qtyToggle" checked class="w-4 h-4 accent-yellow-500">
                                <input type="text" id="qtyItm" class="w-16 input-pro text-sm py-1" value="1" onfocus="window.setActiveInput(this)">
                            </div>
                        </div>

                        <button id="btnAction" onclick="window.addItem()" class="btn-primary">Adicionar à Fila</button>
                    </div>
                </section>

                <section class="app-kb">
                    <button onclick="window.pressKey('1')" class="kb-key">1</button>
                    <button onclick="window.pressKey('2')" class="kb-key">2</button>
                    <button onclick="window.pressKey('3')" class="kb-key">3</button>
                    <button onclick="window.pressKey('4')" class="kb-key">4</button>
                    <button onclick="window.pressKey('5')" class="kb-key">5</button>
                    <button onclick="window.pressKey('6')" class="kb-key">6</button>
                    <button onclick="window.pressKey('7')" class="kb-key">7</button>
                    <button onclick="window.pressKey('8')" class="kb-key">8</button>
                    <button onclick="window.pressKey('9')" class="kb-key">9</button>
                    <button onclick="window.backspace()" class="kb-key kb-key-action"><i class="fa-solid fa-delete-left"></i></button>
                    <button onclick="window.pressKey('0')" class="kb-key">0</button>
                    <button onclick="window.clearInput()" class="kb-key kb-key-action"><i class="fa-solid fa-trash"></i></button>
                </section>
            </div>

            <div class="lg:col-span-7 space-y-4">
                <section class="glass p-6 rounded-[2.5rem] flex flex-col h-full min-h-[500px]">
                    <div class="flex justify-between items-center mb-4 border-b border-yellow-900/20 pb-2">
                        <span class="text-[10px] font-black uppercase tracking-widest">Fila (<span id="queueBadge">0</span>)</span>
                        <button onclick="window.clearQueue()" class="text-red-500 text-[10px] font-black">LIMPAR</button>
                    </div>
                    <div class="flex-grow overflow-y-auto custom-scrollbar max-h-[350px]">
                        <table class="w-full text-[11px] text-left">
                            <tbody id="queueTable" class="divide-y divide-yellow-900/10"></tbody>
                        </table>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button onclick="window.generateZPL()" class="bg-yellow-500 text-black font-black py-4 rounded-xl uppercase text-xs">Gerar ZPL</button>
                        <button id="btnDownload" onclick="window.downloadFile()" disabled class="bg-slate-800 text-yellow-600 font-black py-4 rounded-xl uppercase text-xs opacity-50 cursor-not-allowed">Download .ZPL</button>
                    </div>
                    <!-- TEXTAREA MOSTRADA AUTOMATICAMENTE AO GERAR -->
                    <textarea id="finalZPL" readonly class="hidden mt-4 w-full h-32 bg-black text-cyan-500 p-4 rounded-xl font-mono text-[8px]"></textarea>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCiy4DOVPYYr_UtglmnVWUdZ8SqM26Neo8",
            authDomain: "zpl47-f751d.firebaseapp.com",
            projectId: "zpl47-f751d",
            databaseURL: "https://zpl47-f751d-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const queueRef = ref(db, "print_queue");
        const productsRef = ref(db, "master_products");

        window.inventory = [];
        window.queue = [];
        window.activeInput = null;
        window.mode = 'validade';

        // ============ LÓGICA DE EXTRAÇÃO E BUSCA (CORRIGIDA) ============
        
        // Extrai o identificador das posições 8, 9, 10, 11, 12 (Índice 7 a 11)
        const extractId = (code) => {
            const clean = String(code).replace(/\D/g, '');
            if (clean.length === 13) return clean.substring(7, 12);
            return clean;
        };

        window.findProductUniversal = (input) => {
            const cleanInput = String(input).replace(/\D/g, '');
            if (cleanInput.length < 5) return null;

            // Pega o que pesquisar (se for 13, extrai o miolo, se for 5, usa direto)
            const searchKey = cleanInput.length === 13 ? cleanInput.substring(7, 12) : cleanInput;

            return window.inventory.find(i => {
                const dbId = extractId(i.COD);
                return dbId === searchKey;
            });
        };

        // ============ FUNÇÃO UPDATE SEARCH CORRIGIDA ============
        window.updateSearch = (val) => {
            // 1. Limpa caracteres não numéricos
            const cleanInput = String(val).replace(/\D/g, '');
            
            // 2. Determina o que buscar: se tem 13 dígitos, extrai os 5 centrais
            const searchKey = cleanInput.length === 13 ? cleanInput.substring(7, 12) : cleanInput;
            
            // 3. Busca no inventário
            const prod = window.inventory.find(i => {
                const dbId = extractId(i.COD); // Extrai os 5 dígitos do código do banco
                return dbId === searchKey;
            });
            
            const preview = document.getElementById('previewName');
            const panel = document.getElementById('locationResult');
            const savedInd = document.getElementById('qtySavedIndicator');

            if (prod) {
                preview.textContent = prod.NOM;
                preview.style.color = "#FFD700";
                
                if (window.mode === 'localizar') {
                    panel.classList.remove('hidden');
                    document.getElementById('resRua').textContent = prod.RUA || '--';
                    document.getElementById('resRack').textContent = prod.RCK || '--';
                    document.getElementById('resLinha').textContent = prod.LIN || '--';
                    document.getElementById('resColuna').textContent = prod.COL || '--';
                }

                if (prod.QTY_DEFAULT && prod.QTY_DEFAULT !== '1') {
                    document.getElementById('qtyItm').value = prod.QTY_DEFAULT;
                    savedInd.classList.remove('hidden');
                }
            } else {
                // Mostra "NÃO CADASTRADO" apenas se tiver 5+ dígitos (ou 13 dígitos completos)
                preview.textContent = searchKey.length >= 5 ? "PRODUTO NÃO CADASTRADO" : "";
                preview.style.color = "#ff4444";
                panel.classList.add('hidden');
                savedInd.classList.add('hidden');
            }
        };

        // ============ GERAÇÃO ZPL (CORRIGIDA) ============
        window.generateZPL = () => {
            if (window.queue.length === 0) {
                window.showToast("Adicione itens à fila primeiro!");
                return;
            }
            document.getElementById('loader').classList.remove('hidden');

            setTimeout(() => {
                let zpl = "";
                const cleanStr = (t) => String(t || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().substring(0, 32);

                for (let i = 0; i < window.queue.length; i += 2) {
                    zpl += "^XA\n^CI28^PW812^LL1218\n";
                    
                    const drawLabel = (item, y) => {
                        if (!item) return "";
                        const d = item.fullData || {};
                        const barCode = String(item.codigo).replace(/\D/g, '');
                        // Identificador das posições 8-12 para o topo da etiqueta
                        const ident = extractId(barCode);
                        
                        let s = `^FO20,${y+30}^A0N,100,90^FD${ident}^FS\n`;
                        if(item.validade) s += `^FO235,${y+20}^GB550,65,75^FS^FO250,${y+30}^A0N,95,90^FR^FDVAL: ${item.validade}^FS\n`;
                        s += `^FO20,${y+140}^A0N,70,70^FB770,2,0,L,0^FD${cleanStr(item.tempName)}^FS\n`;
                        s += `^FO20,${y+300}^A0N,45,45^FDRUA: ${d.RUA||''} - RACK: ${d.RCK||''}^FS\n`;
                        s += `^FO20,${y+350}^A0N,45,45^FDLIN: ${d.LIN||''} - COL: ${d.COL||''}^FS\n`;
                        if(d.qtyItm) s += `^FO580,${y+310}^A0N,80,80^FDQ:${d.qtyItm}^FS\n`;
                        s += `^BY3,3,130^FO110,${y+410}^BCN,130,Y,N,N^FD${barCode}^FS\n`;
                        return s;
                    };

                    zpl += drawLabel(window.queue[i], 0);
                    if (window.queue[i+1]) zpl += drawLabel(window.queue[i+1], 600);
                    zpl += "^XZ\n";
                }

                const area = document.getElementById('finalZPL');
                area.value = zpl;
                area.classList.remove('hidden');
                document.getElementById('btnDownload').disabled = false;
                document.getElementById('btnDownload').classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('loader').classList.add('hidden');
                window.showToast("ZPL Gerado com Sucesso!");
            }, 600);
        };

        // ============ FUNÇÕES DE INTERFACE ============
        window.addItem = async () => {
            const val = document.getElementById('mainCode').value;
            if(!val) return;
            const p = window.findProductUniversal(val) || { NOM: 'PRODUTO AVULSO', COD: val };
            const qtyEtq = parseInt(document.getElementById('valQtyEtq').value) || 1;
            const qtyItm = document.getElementById('qtyItm').value;

            // Salva quantidade padrão se o toggle estiver ativo
            if(document.getElementById('qtyToggle').checked && p.COD) {
                await update(ref(db, `master_products/${p.COD}`), { QTY_DEFAULT: qtyItm });
            }

            for(let i=0; i<qtyEtq; i++){
                await push(queueRef, {
                    codigo: p.COD || val,
                    validade: window.mode === 'validade' ? document.getElementById('valDate').value : "",
                    tempName: p.NOM,
                    fullData: { ...p, qtyItm: document.getElementById('qtyToggle').checked ? qtyItm : "" },
                    created_at: Date.now() + i
                });
            }
            window.clearInput();
            window.showToast("Adicionado à fila!");
        };

        window.setMode = (m) => {
            window.mode = m;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(m==='validade'?'tabVal':m==='endereco'?'tabEnd':'tabLoc').classList.add('active');
            document.getElementById('valRow').classList.toggle('hidden', m !== 'validade');
            document.getElementById('qtyRow').classList.toggle('hidden', m === 'localizar');
            document.getElementById('btnAction').classList.toggle('hidden', m === 'localizar');
            window.clearInput();
        };

        // ============ FUNÇÕES DE TECLADO CORRIGIDAS ============
        window.pressKey = (val) => {
            if(!window.activeInput) window.activeInput = document.getElementById('mainCode');
            
            // Lógica especial para campo de data
            if(window.activeInput.id === 'valDate') {
                let v = window.activeInput.value.replace(/\D/g, '');
                if(v.length < 6) v += val;
                if(v.length >= 2) v = v.substring(0, 2) + '/' + v.substring(2, 6);
                window.activeInput.value = v;
                return;
            }
            
            // Para outros campos, apenas adiciona o dígito
            window.activeInput.value += val;
            
            // Se for o campo principal, atualiza a busca com o valor atual
            if(window.activeInput.id === 'mainCode') {
                window.updateSearch(window.activeInput.value);
            }
        };

        window.backspace = () => {
            if(!window.activeInput) return;
            window.activeInput.value = window.activeInput.value.slice(0, -1);
            if(window.activeInput.id === 'mainCode') {
                window.updateSearch(window.activeInput.value);
            }
        };

        window.clearInput = () => {
            if(window.activeInput) window.activeInput.value = "";
            document.getElementById('previewName').textContent = "";
            document.getElementById('locationResult').classList.add('hidden');
        };

        window.loadFromCloud = async () => {
            document.getElementById('loader').classList.remove('hidden');
            const snap = await get(productsRef);
            if(snap.exists()) {
                window.inventory = Object.values(snap.val());
                window.showToast(`Base de dados: ${window.inventory.length} itens`);
            }
            document.getElementById('loader').classList.add('hidden');
        };

        window.handleFileUpload = (input) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const master = {};
                json.forEach(r => {
                    const cod = String(r.COD || r.CÓDIGO || "");
                    if(cod) master[cod] = { COD: cod, NOM: r.NOME||"S/N", RUA: r.RUA||"", RCK: r.RACK||"", LIN: r.LINHA||"", COL: r.COLUNA||"" };
                });
                await set(productsRef, master);
                window.loadFromCloud();
            };
            reader.readAsArrayBuffer(input.files[0]);
        };

        onValue(queueRef, (snap) => {
            const data = snap.val();
            window.queue = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
            document.getElementById('queueBadge').textContent = window.queue.length;
            document.getElementById('queueTable').innerHTML = window.queue.map((item, idx) => `
                <tr class="border-b border-yellow-900/10">
                    <td class="p-2 font-bold text-yellow-600">${idx+1}</td>
                    <td class="p-2"><b>${item.codigo}</b><br><small>${item.tempName}</small></td>
                    <td class="p-2 text-right"><button onclick="window.removeItem('${item.id}')" class="text-red-500"><i class="fa-solid fa-times"></i></button></td>
                </tr>`).join('');
        });

        window.removeItem = (id) => remove(ref(db, `print_queue/${id}`));
        window.clearQueue = () => confirm("Deseja limpar toda a fila?") && remove(queueRef);
        window.showToast = (m) => { const t = document.getElementById('toast'); t.querySelector('span').textContent=m; t.classList.remove('opacity-0'); setTimeout(()=>t.classList.add('opacity-0'),2000); };
        window.downloadFile = () => {
            const blob = new Blob([document.getElementById('finalZPL').value], {type: 'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `etiquetas_${Date.now()}.zpl`; a.click();
        };
        window.setActiveInput = (el) => { window.activeInput = el; document.querySelectorAll('.input-pro').forEach(i => i.classList.remove('input-active')); el.classList.add('input-active'); };

        document.addEventListener('DOMContentLoaded', window.loadFromCloud);
    </script>
</body>
</html>
