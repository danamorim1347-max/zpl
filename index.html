<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZPL ZK47 PRO | Dev. Benilson Amorim</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        :root { --gold: #FFD700; --bg: #010409; }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: #f8fafc; overflow-x: hidden; background-image: radial-gradient(circle at 50% -20%, #443308 0%, transparent 50%); }
        .glass { background: #0d1117; border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 1.5rem; padding: 1.2rem; }
        .input-pro { background: #000; border: 1px solid #30363d; color: white; outline: none; font-family: 'JetBrains Mono', monospace; border-radius: 12px; padding: 12px; width: 100%; font-size: 1.2rem; font-weight: bold; text-align: center; }
        .input-pro:focus { border-color: var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); }
        .input-active { border-color: var(--gold) !important; background: #1a1608 !important; }
        
        .btn-primary { background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); border-radius: 14px; font-weight: 800; text-transform: uppercase; color: #000; padding: 14px; width: 100%; cursor: pointer; border: none; }
        .btn-primary:active { transform: scale(0.95); }

        .app-kb { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; background: #0d1117; padding: 12px; border-radius: 20px; border: 1px solid #443308; }
        .kb-key { background: #161b22; border: 1px solid #30363d; padding: 15px; border-radius: 12px; text-align: center; font-weight: 800; font-size: 1.4rem; color: #fff; cursor: pointer; user-select: none; }
        .kb-key:active { background: var(--gold); color: #000; }
        .kb-key-action { background: #B8860B; color: #000; }

        .tab-btn { flex: 1; padding: 10px; font-size: 10px; font-weight: 900; text-transform: uppercase; color: #64748b; cursor: pointer; border-radius: 8px; }
        .tab-btn.active { background-color: var(--gold); color: #000; }

        .location-card { background: #0d1117; border: 2px solid #FFD700; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #443308; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen p-2 flex flex-col items-center">

    <div id="loader" class="fixed inset-0 z-[100] bg-black/90 flex flex-col items-center justify-center hidden">
        <div class="w-12 h-12 border-4 border-yellow-900/30 border-t-yellow-500 rounded-full animate-spin"></div>
    </div>

    <div id="toast" class="fixed top-4 right-4 bg-yellow-500 text-black px-6 py-3 rounded-xl font-black uppercase text-xs shadow-2xl opacity-0 transition-all duration-300 z-[9999]">
        <span>Mensagem</span>
    </div>

    <div class="w-full max-w-4xl space-y-4">
        
        <header class="flex flex-col items-center gap-4 glass p-6 rounded-[2.5rem]">
            <i class="fa-solid fa-qrcode text-yellow-500 text-3xl"></i>
            <div class="flex gap-2">
                <button onclick="window.loadFromCloud()" class="bg-yellow-900/20 text-yellow-500 px-4 py-2 rounded-xl text-[10px] font-black border border-yellow-800 uppercase">Cloud Sync</button>
                <label class="bg-slate-800 text-slate-400 px-4 py-2 rounded-xl text-[10px] font-black border border-slate-700 uppercase cursor-pointer">
                    Importar Excel <input type="file" class="hidden" onchange="window.handleFileUpload(this)" accept=".xlsx">
                </label>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-4">
            <div class="lg:col-span-5 space-y-4">
                <section class="glass p-5 rounded-[2rem]">
                    <div class="flex p-1 bg-slate-900 rounded-xl mb-6 border border-slate-800">
                        <button onclick="window.setMode('validade')" id="tabVal" class="tab-btn active">Validade</button>
                        <button onclick="window.setMode('endereco')" id="tabEnd" class="tab-btn">Endereço</button>
                        <button onclick="window.setMode('localizar')" id="tabLoc" class="tab-btn">Localizar</button>
                    </div>

                    <div class="space-y-4">
                        <div class="relative">
                            <input type="text" id="mainCode" class="input-pro" placeholder="Digite o Código" inputmode="none" onfocus="window.setActiveInput(this)" oninput="window.updateSearch(this.value)">
                        </div>
                        
                        <!-- NOVO: Container para mostrar o endereço no modo localizar -->
                        <div id="locationInfo" class="location-card p-4 hidden">
                            <div class="text-center mb-2">
                                <div id="previewName" class="text-[13px] font-black text-yellow-500 uppercase min-h-[1.5rem]"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-[11px]">
                                <div class="bg-black/50 p-2 rounded-lg">
                                    <div class="text-yellow-700 font-bold">RUA</div>
                                    <div id="infoRua" class="font-mono font-bold text-white">-</div>
                                </div>
                                <div class="bg-black/50 p-2 rounded-lg">
                                    <div class="text-yellow-700 font-bold">RACK</div>
                                    <div id="infoRack" class="font-mono font-bold text-white">-</div>
                                </div>
                                <div class="bg-black/50 p-2 rounded-lg">
                                    <div class="text-yellow-700 font-bold">LINHA</div>
                                    <div id="infoLinha" class="font-mono font-bold text-white">-</div>
                                </div>
                                <div class="bg-black/50 p-2 rounded-lg">
                                    <div class="text-yellow-700 font-bold">COLUNA</div>
                                    <div id="infoColuna" class="font-mono font-bold text-white">-</div>
                                </div>
                            </div>
                            <div class="mt-3 text-center text-[9px] text-slate-400">
                                <i class="fas fa-map-marker-alt mr-1"></i> Endereço completo do produto
                            </div>
                        </div>

                        <div id="valRow" class="grid grid-cols-2 gap-3">
                            <input type="text" id="valDate" class="input-pro text-sm" placeholder="MMAAAA" onfocus="window.setActiveInput(this)">
                            <input type="text" id="valQtyEtq" class="input-pro text-sm" value="1" onfocus="window.setActiveInput(this)">
                        </div>

                        <div id="qtyRow" class="flex items-center justify-between p-3 bg-slate-950/50 rounded-xl border border-yellow-900/20">
                            <span class="text-[9px] font-black text-yellow-700 uppercase">Qtd por Emb?</span>
                            <div class="flex gap-2 items-center">
                                <input type="checkbox" id="qtyToggle" checked class="w-4 h-4 accent-yellow-500">
                                <input type="text" id="qtyItm" class="w-16 input-pro text-sm py-1" value="1" onfocus="window.setActiveInput(this)">
                            </div>
                        </div>

                        <button id="btnAction" onclick="window.addItem()" class="btn-primary">Adicionar à Fila</button>
                    </div>
                </section>

                <section class="app-kb">
                    <button onclick="window.pressKey('1')" class="kb-key">1</button>
                    <button onclick="window.pressKey('2')" class="kb-key">2</button>
                    <button onclick="window.pressKey('3')" class="kb-key">3</button>
                    <button onclick="window.pressKey('4')" class="kb-key">4</button>
                    <button onclick="window.pressKey('5')" class="kb-key">5</button>
                    <button onclick="window.pressKey('6')" class="kb-key">6</button>
                    <button onclick="window.pressKey('7')" class="kb-key">7</button>
                    <button onclick="window.pressKey('8')" class="kb-key">8</button>
                    <button onclick="window.pressKey('9')" class="kb-key">9</button>
                    <button onclick="window.backspace()" class="kb-key kb-key-action"><i class="fa-solid fa-delete-left"></i></button>
                    <button onclick="window.pressKey('0')" class="kb-key">0</button>
                    <button onclick="window.clearInput()" class="kb-key kb-key-action"><i class="fa-solid fa-trash"></i></button>
                </section>
            </div>

            <div class="lg:col-span-7 space-y-4">
                <section class="glass p-6 rounded-[2.5rem] flex flex-col h-full min-h-[500px]">
                    <div class="flex justify-between items-center mb-4 border-b border-yellow-900/20 pb-2">
                        <span class="text-[10px] font-black uppercase tracking-widest">Fila (<span id="queueBadge">0</span>)</span>
                        <button onclick="window.clearQueue()" class="text-red-500 text-[10px] font-black">LIMPAR</button>
                    </div>
                    <div class="flex-grow overflow-y-auto custom-scrollbar max-h-[350px]">
                        <table class="w-full text-[11px] text-left">
                            <tbody id="queueTable" class="divide-y divide-yellow-900/10"></tbody>
                        </table>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button onclick="window.generateZPL()" class="bg-yellow-500 text-black font-black py-4 rounded-xl uppercase text-xs">Gerar ZPL</button>
                        <button id="btnDownload" onclick="window.downloadFile()" disabled class="bg-slate-800 text-yellow-600 font-black py-4 rounded-xl uppercase text-xs opacity-50 cursor-not-allowed">Download</button>
                    </div>
                    <textarea id="finalZPL" readonly class="hidden mt-4 w-full h-32 bg-black text-cyan-500 p-4 rounded-xl font-mono text-[8px]"></textarea>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCiy4DOVPYYr_UtglmnVWUdZ8SqM26Neo8",
            authDomain: "zpl47-f751d.firebaseapp.com",
            projectId: "zpl47-f751d",
            databaseURL: "https://zpl47-f751d-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const queueRef = ref(db, "print_queue");
        const productsRef = ref(db, "master_products");

        window.inventory = [];
        window.queue = [];
        window.activeInput = null;
        window.mode = 'validade';

        // Extrai apenas os 5 dígitos do meio (identificador)
        const extractId = (code) => {
            const clean = String(code).replace(/\D/g, '');
            if (clean.length === 13) return clean.substring(7, 12);
            return clean;
        };

        window.findProductUniversal = (input) => {
            const cleanInput = String(input).replace(/\D/g, '');
            if (cleanInput.length < 5) return null;
            const searchKey = cleanInput.length === 13 ? cleanInput.substring(7, 12) : cleanInput;
            return window.inventory.find(i => extractId(i.COD) === searchKey);
        };

        window.updateSearch = (val) => {
            const prod = window.findProductUniversal(val);
            const preview = document.getElementById('previewName');
            const locationInfo = document.getElementById('locationInfo');
            
            if (prod) {
                preview.textContent = prod.NOM;
                preview.style.color = "#FFD700";
                
                // Atualizar informações de endereço
                document.getElementById('infoRua').textContent = prod.RUA || "-";
                document.getElementById('infoRack').textContent = prod.RCK || "-";
                document.getElementById('infoLinha').textContent = prod.LIN || "-";
                document.getElementById('infoColuna').textContent = prod.COL || "-";
                
                // Mostrar card de localização apenas no modo localizar
                if (window.mode === 'localizar') {
                    locationInfo.classList.remove('hidden');
                }
            } else {
                preview.textContent = val.length >= 5 ? "NÃO CADASTRADO" : "";
                preview.style.color = "#ff4444";
                
                // Esconder card de localização se não encontrado
                if (window.mode === 'localizar') {
                    locationInfo.classList.remove('hidden');
                    document.getElementById('infoRua').textContent = "-";
                    document.getElementById('infoRack').textContent = "-";
                    document.getElementById('infoLinha').textContent = "-";
                    document.getElementById('infoColuna').textContent = "-";
                }
            }
            
            // Esconder card de localização se campo vazio
            if (!val || val.length < 5) {
                locationInfo.classList.add('hidden');
            }
        };

        // ============ GERAÇÃO ZPL (CORREÇÃO DE BARCODE E RUA/RACK) ============
        window.generateZPL = () => {
            if (window.queue.length === 0) return;
            document.getElementById('loader').classList.remove('hidden');

            setTimeout(() => {
                let zpl = "";
                const cleanStr = (t) => String(t || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().substring(0, 32);

                for (let i = 0; i < window.queue.length; i += 2) {
                    zpl += "^XA\n^CI28^PW812^LL1218\n";
                    
                    const drawLabel = (item, y) => {
                        if (!item) return "";
                        
                        // O Identificador (Topo) é sempre os 5 dígitos
                        const ident = extractId(item.codigo_barras);
                        // O Código de Barras (Inferior) é o que foi digitado (13 dígitos)
                        const barCode = item.codigo_barras; 
                        
                        const productName = item.tempName || "PRODUTO";
                        const rua = (item.fullData?.RUA || "").trim();
                        const rack = (item.fullData?.RCK || "").trim();
                        const linha = (item.fullData?.LIN || "").trim();
                        const coluna = (item.fullData?.COL || "").trim();
                        
                        let s = `^FO20,${y+30}^A0N,100,90^FD${ident}^FS\n`;
                        
                        if(item.validade) {
                            s += `^FO235,${y+20}^GB550,65,75^FS^FO250,${y+30}^A0N,95,90^FR^FDVAL: ${item.validade}^FS\n`;
                        }
                        
                        s += `^FO20,${y+140}^A0N,70,70^FB770,2,0,L,0^FD${cleanStr(productName)}^FS\n`;
                        
                        // Rua e Rack sem prefixo fixo (usa o que está no banco)
                        if (rua || rack) {
                            s += `^FO20,${y+300}^A0N,45,45^FD${rua}  ${rack}^FS\n`;
                        }
                        
                        if (linha || coluna) {
                            s += `^FO20,${y+350}^A0N,45,45^FDLIN: ${linha} - COL: ${coluna}^FS\n`;
                        }
                        
                        if(item.fullData?.qtyItm) {
                            s += `^FO580,${y+310}^A0N,80,80^FDQ:${item.fullData.qtyItm}^FS\n`;
                        }
                        
                        // BARCODE CORRIGIDO: ^BY2 para caber 13 dígitos e ^BC (Code 128)
                        s += `^BY2,3,130^FO60,${y+410}^BCN,130,Y,N,N^FD${barCode}^FS\n`;
                        
                        return s;
                    };

                    zpl += drawLabel(window.queue[i], 0);
                    if (window.queue[i+1]) zpl += drawLabel(window.queue[i+1], 600);
                    zpl += "^XZ\n";
                }

                document.getElementById('finalZPL').value = zpl;
                document.getElementById('finalZPL').classList.remove('hidden');
                document.getElementById('btnDownload').disabled = false;
                document.getElementById('btnDownload').classList.remove('opacity-50');
                document.getElementById('loader').classList.add('hidden');
                window.showToast("ZPL Gerado!");
            }, 600);
        };

        window.addItem = async () => {
            const val = document.getElementById('mainCode').value; // Valor digitado (ex: 13 dígitos)
            if(!val) return;
            
            const p = window.findProductUniversal(val) || { NOM: 'PRODUTO AVULSO', COD: val };
            const qtyEtq = parseInt(document.getElementById('valQtyEtq').value) || 1;
            const qtyItm = document.getElementById('qtyItm').value;

            for(let i=0; i<qtyEtq; i++){
                await push(queueRef, {
                    codigo_barras: val, // Salva os 13 números para o código de barras
                    validade: window.mode === 'validade' ? document.getElementById('valDate').value : "",
                    tempName: p.NOM,
                    fullData: { 
                        ...p, 
                        qtyItm: document.getElementById('qtyToggle').checked ? qtyItm : "" 
                    },
                    created_at: Date.now() + i
                });
            }
            window.clearInput();
            window.showToast("Adicionado!");
        };

        window.setMode = (m) => {
            window.mode = m;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(m==='validade'?'tabVal':m==='endereco'?'tabEnd':'tabLoc').classList.add('active');
            
            // Mostrar/ocultar elementos conforme modo
            document.getElementById('valRow').classList.toggle('hidden', m !== 'validade');
            document.getElementById('qtyRow').classList.toggle('hidden', m === 'localizar');
            
            // Mostrar card de localização apenas se houver código digitado no modo localizar
            const mainCode = document.getElementById('mainCode').value;
            const locationInfo = document.getElementById('locationInfo');
            
            if (m === 'localizar' && mainCode && mainCode.length >= 5) {
                locationInfo.classList.remove('hidden');
            } else {
                locationInfo.classList.add('hidden');
            }
            
            // Atualizar texto do botão principal
            const btnAction = document.getElementById('btnAction');
            if (m === 'localizar') {
                btnAction.textContent = 'Localizar Produto';
                btnAction.disabled = true;
                btnAction.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                btnAction.textContent = 'Adicionar à Fila';
                btnAction.disabled = false;
                btnAction.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            window.clearInput();
        };

        window.pressKey = (val) => {
            if(!window.activeInput) window.activeInput = document.getElementById('mainCode');
            if(window.activeInput.id === 'valDate') {
                let v = window.activeInput.value.replace(/\D/g, '');
                if(v.length < 6) v += val;
                if(v.length >= 2) v = v.substring(0, 2) + '/' + v.substring(2, 6);
                window.activeInput.value = v;
                return;
            }
            window.activeInput.value += val;
            if(window.activeInput.id === 'mainCode') window.updateSearch(window.activeInput.value);
        };

        window.backspace = () => {
            if(!window.activeInput) return;
            window.activeInput.value = window.activeInput.value.slice(0, -1);
            if(window.activeInput.id === 'mainCode') window.updateSearch(window.activeInput.value);
        };

        window.clearInput = () => {
            if(window.activeInput) window.activeInput.value = "";
            document.getElementById('previewName').textContent = "";
            document.getElementById('locationInfo').classList.add('hidden');
        };

        window.loadFromCloud = async () => {
            document.getElementById('loader').classList.remove('hidden');
            const snap = await get(productsRef);
            if(snap.exists()) window.inventory = Object.values(snap.val());
            document.getElementById('loader').classList.add('hidden');
        };

        window.handleFileUpload = (input) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const master = {};
                json.forEach(r => {
                    const cod = String(r.COD || r.CÓDIGO || "");
                    if(cod) master[cod] = { COD: cod, NOM: r.NOME||"S/N", RUA: r.RUA||"", RCK: r.RACK||"", LIN: r.LINHA||"", COL: r.COLUNA||"" };
                });
                await set(productsRef, master);
                window.loadFromCloud();
            };
            reader.readAsArrayBuffer(input.files[0]);
        };

        onValue(queueRef, (snap) => {
            const data = snap.val();
            window.queue = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
            document.getElementById('queueBadge').textContent = window.queue.length;
            document.getElementById('queueTable').innerHTML = window.queue.map((item, idx) => `
                <tr class="border-b border-yellow-900/10">
                    <td class="p-2 font-bold text-yellow-600">${idx+1}</td>
                    <td class="p-2"><b>${item.codigo_barras}</b><br><small>${item.tempName}</small></td>
                    <td class="p-2 text-right"><button onclick="window.removeItem('${item.id}')" class="text-red-500"><i class="fa-solid fa-times"></i></button></td>
                </tr>`).join('');
        });

        window.removeItem = (id) => remove(ref(db, `print_queue/${id}`));
        window.clearQueue = () => confirm("Limpar fila?") && remove(queueRef);
        window.showToast = (m) => { const t = document.getElementById('toast'); t.querySelector('span').textContent=m; t.classList.remove('opacity-0'); setTimeout(()=>t.classList.add('opacity-0'),2000); };
        window.downloadFile = () => {
            const blob = new Blob([document.getElementById('finalZPL').value], {type: 'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `etiquetas.zpl`; a.click();
        };
        window.setActiveInput = (el) => { window.activeInput = el; document.querySelectorAll('.input-pro').forEach(i => i.classList.remove('input-active')); el.classList.add('input-active'); };

        document.addEventListener('DOMContentLoaded', window.loadFromCloud);
    </script>
</body>
</html>