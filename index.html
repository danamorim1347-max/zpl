<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZK47 PRO | Enterprise Logistics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap');
        
        :root { 
            --primary: #fbbf24; 
            --bg-deep: #020617; 
            --card-bg: #0f172a;
            --accent: #38bdf8;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-deep); 
            color: #f1f5f9;
            background-image: radial-gradient(circle at top right, #1e1b4b 0%, transparent 40%);
            min-height: 100vh;
        }

        .glass-panel { 
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .input-field { 
            background: #020617; 
            border: 2px solid #1e293b; 
            color: white; 
            transition: all 0.2s;
            font-family: 'JetBrains Mono', monospace;
        }

        .input-field:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.15);
            outline: none;
        }

        .btn-action {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-action:active { transform: scale(0.96); }

        .tab-active {
            background: var(--primary);
            color: #000;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
        }

        .stock-badge {
            background: rgba(56, 189, 248, 0.15);
            color: var(--accent);
            border: 1px solid rgba(56, 189, 248, 0.3);
        }

        .barcode-font { font-family: 'JetBrains Mono', monospace; }

        /* Linhas entre os itens da tabela */
        .row-divider {
            border-bottom: 1px solid rgba(51, 65, 85, 0.8);
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; padding: 0 !important; }
            .glass-panel { border: none !important; box-shadow: none !important; background: white !important; width: 100% !important; }
            .row-divider { border-bottom: 1px solid #000 !important; }
            .text-white, .text-slate-300, .text-slate-400 { color: black !important; }
            .text-amber-500 { color: black !important; font-weight: bold !important; }
            .stock-badge { border: 1px solid #000 !important; color: black !important; background: none !important; }
            table { width: 100% !important; border-collapse: collapse !important; }
            th, td { padding: 10px 5px !important; }
            .item-done-print { opacity: 0.4 !important; text-decoration: line-through !important; }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-6">

    <div id="loader" class="fixed inset-0 z-[100] bg-slate-950/80 backdrop-blur-sm flex items-center justify-center hidden">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
            <span class="text-amber-500 font-bold tracking-widest text-xs uppercase">Processando...</span>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-amber-500 text-slate-950 px-8 py-4 rounded-2xl font-black text-sm opacity-0 transition-all duration-300 z-[9999] shadow-2xl flex items-center gap-3">
        <i class="fa-solid fa-circle-info"></i>
        <span></span>
    </div>

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 no-print">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-amber-500 rounded-xl flex items-center justify-center shadow-lg shadow-amber-500/20">
                    <i class="fa-solid fa-barcode text-slate-950 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tighter uppercase leading-none">ZK47 <span class="text-amber-500 font-light">PRO</span></h1>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest leading-none mt-1">Industrial Picking & Labels</p>
                </div>
            </div>
            
            <div class="flex flex-wrap justify-center gap-2">
                <button onclick="App.syncInventory()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2.5 rounded-xl text-[10px] font-bold uppercase flex items-center gap-2 transition-all">
                    <i class="fa-solid fa-arrows-rotate"></i> Sincronizar
                </button>
                <label class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2.5 rounded-xl text-[10px] font-bold uppercase cursor-pointer flex items-center gap-2 border border-slate-700 transition-all">
                    <i class="fa-solid fa-database text-amber-500"></i> Cadastro
                    <input type="file" class="hidden" accept=".xlsx,.xls,.csv" onchange="App.handleFileUpload(this)">
                </label>
                <label class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2.5 rounded-xl text-[10px] font-bold uppercase cursor-pointer flex items-center gap-2 shadow-lg shadow-blue-500/20 transition-all">
                    <i class="fa-solid fa-file-import"></i> Importar Pedidos
                    <input type="file" class="hidden" accept=".xlsx,.xls,.csv" onchange="App.importOrderSheet(this)">
                </label>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Controls -->
            <div class="lg:col-span-4 space-y-6 no-print">
                <section class="glass-panel p-6">
                    <div class="flex p-1.5 bg-slate-950 rounded-2xl mb-6 border border-slate-800">
                        <button id="tabEti" onclick="App.setMode('etiqueta')" class="flex-1 py-3 rounded-xl text-[11px] font-black uppercase transition-all flex items-center justify-center gap-2 tab-active">
                            <i class="fa-solid fa-tags"></i> Etiquetas
                        </button>
                        <button id="tabSep" onclick="App.setMode('separacao')" class="flex-1 py-3 rounded-xl text-[11px] font-black uppercase transition-all flex items-center justify-center gap-2 text-slate-500">
                            <i class="fa-solid fa-list-check"></i> Separação
                        </button>
                    </div>

                    <!-- Label Form -->
                    <div id="etiquetaView" class="space-y-4">
                        <input type="text" id="mainCode" class="input-field w-full px-6 py-4 rounded-2xl text-lg font-bold" placeholder="Bipar Código..." onfocus="App.setActiveInput(this)" oninput="App.updateSearch(this.value)">
                        
                        <div id="liveAddress" class="grid grid-cols-4 gap-2 opacity-0 transition-all duration-300">
                            <div class="bg-slate-950 p-2 rounded-xl border border-slate-800 text-center">
                                <span class="block text-[7px] text-slate-500 font-black uppercase">Rua</span>
                                <span id="lRua" class="text-xs font-bold text-white">-</span>
                            </div>
                            <div class="bg-slate-950 p-2 rounded-xl border border-slate-800 text-center">
                                <span class="block text-[7px] text-slate-500 font-black uppercase">Rck</span>
                                <span id="lRack" class="text-xs font-bold text-white">-</span>
                            </div>
                            <div class="bg-slate-950 p-2 rounded-xl border border-slate-800 text-center">
                                <span class="block text-[7px] text-slate-500 font-black uppercase">Lin</span>
                                <span id="lLin" class="text-xs font-bold text-white">-</span>
                            </div>
                            <div class="bg-slate-950 p-2 rounded-xl border border-slate-800 text-center">
                                <span class="block text-[7px] text-slate-500 font-black uppercase">Col</span>
                                <span id="lCol" class="text-xs font-bold text-white">-</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-2">
                            <input type="text" id="valDate" class="input-field w-full p-3 rounded-xl text-xs" placeholder="Validade" onfocus="App.setActiveInput(this); App.setCurrentDate(this);">
                            <input type="text" id="valQtyEtq" class="input-field w-full p-3 rounded-xl text-xs" value="1" placeholder="Etq" onfocus="App.setActiveInput(this)">
                            <input type="text" id="valQtyItens" class="input-field w-full p-3 rounded-xl text-xs" placeholder="Emb" onfocus="App.setActiveInput(this)">
                        </div>
                        
                        <button onclick="App.addItemToQueue()" class="btn-action w-full bg-amber-500 text-slate-950 py-4 rounded-2xl text-xs flex items-center justify-center gap-2 shadow-lg shadow-amber-500/20">
                            <i class="fa-solid fa-plus-circle"></i> Adicionar à Fila
                        </button>
                    </div>

                    <!-- Picking Form -->
                    <div id="separacaoView" class="hidden space-y-4">
                        <div class="bg-slate-950 p-4 rounded-2xl border border-slate-800">
                            <textarea id="bulkList" class="bg-transparent w-full h-32 text-xs font-mono outline-none resize-none text-slate-300" placeholder="Cole os itens aqui..."></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="App.processBulkSeparation()" class="btn-action bg-blue-600 text-white py-4 rounded-2xl text-xs flex items-center justify-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> Gerar
                            </button>
                            <button onclick="window.print()" class="btn-action bg-slate-100 text-slate-900 py-4 rounded-2xl text-xs flex items-center justify-center gap-2">
                                <i class="fa-solid fa-print"></i> Imprimir
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Keyboard -->
                <section id="keyboard" class="grid grid-cols-3 gap-2 bg-slate-900/30 p-4 rounded-[2rem] border border-slate-800/50 no-print"></section>
            </div>

            <!-- List Display -->
            <div class="lg:col-span-8">
                <section class="glass-panel p-6 min-h-[700px] flex flex-col">
                    <div class="flex justify-between items-center mb-6 no-print">
                        <div class="flex items-center gap-3">
                            <div class="w-1 h-6 bg-amber-500 rounded-full"></div>
                            <h2 id="listTitle" class="font-black text-xs uppercase tracking-widest text-slate-400">Listagem Ativa</h2>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="App.clearCurrentCollection()" class="px-4 py-2 rounded-xl bg-rose-500/10 text-rose-500 text-[10px] font-black uppercase transition-all hover:bg-rose-500 hover:text-white">
                                <i class="fa-solid fa-trash-can mr-1"></i> Limpar Lista
                            </button>
                        </div>
                    </div>

                    <!-- Print Header (Somente Impressão) -->
                    <div class="hidden print:block mb-8 border-b-2 border-black pb-4">
                        <h1 class="text-2xl font-black uppercase">Checklist de Separação ZK47</h1>
                        <p class="text-sm">Data: <span id="printDate"></span> | Total Itens: <span id="printTotal">0</span></p>
                    </div>

                    <div class="flex-grow overflow-y-auto">
                        <table class="w-full text-left">
                            <tbody id="mainTableBody"></tbody>
                        </table>
                    </div>

                    <div id="footerActions" class="mt-6 pt-6 border-t border-slate-800 no-print"></div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCiy4DOVPYYr_UtglmnVWUdZ8SqM26Neo8",
            authDomain: "zpl47-f751d.firebaseapp.com",
            projectId: "zpl47-f751d",
            databaseURL: "https://zpl47-f751d-default-rtdb.firebaseio.com"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.App = {
            inventory: [],
            mode: 'etiqueta',
            activeInput: null,

            extractId(code) {
                if (!code) return '';
                const str = String(code).replace(/\D/g, '');
                return str.length === 13 ? str.substring(7, 12) : str;
            },

            normalizeProduct(prod) {
                if (!prod) return null;
                return {
                    COD: String(prod.COD || prod.codigo || '').trim(),
                    NOM: String(prod.NOM || prod.nome || prod.descricao || 'S/N').trim(),
                    RUA: String(prod.RUA || prod.rua || '').trim(),
                    RCK: String(prod.RCK || prod.rack || '').trim(),
                    LIN: String(prod.LIN || prod.linha || '').trim(),
                    COL: String(prod.COL || prod.coluna || '').trim(),
                    QTD_ITENS: String(prod.QTD_ITENS || prod.qtd_itens || prod.quantidade || '').trim(),
                    QTD_ESTOQUE: String(prod.QTD_ESTOQUE || prod.qtd_estoque || '0').trim()
                };
            },

            setCurrentDate(input) {
                if (!input.value) {
                    const now = new Date();
                    input.value = `${String(now.getMonth() + 1).padStart(2, '0')}${now.getFullYear()}`;
                }
            },

            listenMasterProducts() {
                onValue(ref(db, "master_products"), (snap) => {
                    this.inventory = snap.exists() ? Object.values(snap.val()).map(p => this.normalizeProduct(p)) : [];
                });
            },

            attachListener() {
                const path = this.mode === 'etiqueta' ? "print_queue" : "active_separation";
                onValue(ref(db, path), (snap) => {
                    const data = snap.val();
                    if (this.mode === 'etiqueta') this.renderQueue(data); else this.renderSeparation(data);
                    
                    // Atualizar info de impressão
                    if(data) {
                        document.getElementById('printTotal').textContent = Object.keys(data).length;
                        document.getElementById('printDate').textContent = new Date().toLocaleString();
                    }
                });
            },

            renderQueue(data) {
                const items = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
                const body = document.getElementById('mainTableBody');
                body.innerHTML = items.map(i => `
                    <tr class="row-divider">
                        <td class="py-4 px-2">
                            <span class="barcode-font text-[9px] text-amber-500/80 font-bold uppercase">${i.codigo_barras}</span>
                            <p class="text-sm font-bold text-white uppercase">${i.tempName}</p>
                        </td>
                        <td class="text-center py-4">
                            <span class="barcode-font text-[10px] text-slate-400">VAL: ${i.validade || '--/----'}</span>
                        </td>
                        <td class="text-right py-4 px-2">
                            <button onclick="App.deleteItem('${i.id}')" class="w-8 h-8 rounded-lg bg-rose-500/10 text-rose-500">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                document.getElementById('footerActions').innerHTML = `
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="App.generateZPL('download')" class="btn-action bg-amber-500 text-slate-950 py-3 rounded-xl text-[10px]">Baixar ZPL</button>
                        <button onclick="App.generateZPL('copy')" class="btn-action bg-slate-800 text-amber-500 border border-amber-500/30 py-3 rounded-xl text-[10px]">Copiar ZPL</button>
                    </div>
                `;
            },

            renderSeparation(data) {
                let items = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
                const collator = new Intl.Collator('pt', { numeric: true });
                items.sort((a, b) => collator.compare((a.rua || '') + (a.rack || ''), (b.rua || '') + (b.rack || '')));

                const body = document.getElementById('mainTableBody');
                body.innerHTML = items.map(i => {
                    const isDone = i.status === 'done';
                    return `
                    <tr class="row-divider transition-all ${isDone ? 'opacity-30 print:item-done-print' : ''}">
                        <td class="py-4 px-2">
                            <div class="flex items-center gap-4">
                                <div class="bg-slate-950 border border-slate-800 px-3 py-2 rounded-xl text-center min-w-[75px] print:border-black">
                                    <span class="block text-[7px] text-slate-500 font-black print:text-black">ENDEREÇO</span>
                                    <span class="text-xs font-black text-white print:text-black uppercase">${i.rua || '-'}${i.rack || '-'}</span>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="barcode-font text-[9px] text-slate-500 print:text-black">${i.code}</span>
                                        <span class="stock-badge text-[8px] px-2 py-0.5 rounded-full font-black">ESTOQUE: ${i.stock || 0}</span>
                                    </div>
                                    <p class="text-sm font-black text-white uppercase print:text-black leading-tight">${i.name}</p>
                                </div>
                            </div>
                        </td>
                        <td class="text-center py-4">
                            <div onclick="App.editQuantity('${i.id}', '${i.qty}')" class="cursor-pointer">
                                <span class="block text-[8px] text-slate-500 font-black uppercase mb-1 print:text-black">Pedir</span>
                                <span class="text-xl font-black text-amber-500 px-3 py-1 rounded-lg print:text-black">${i.qty || 1}</span>
                            </div>
                        </td>
                        <td class="text-right py-4 px-2 no-print">
                            <button onclick="App.toggleStatus('${i.id}', '${i.status}')" 
                                    class="w-10 h-10 rounded-xl border-2 ${isDone ? 'bg-emerald-500 border-emerald-500 text-slate-950' : 'border-slate-800 text-slate-700'} flex items-center justify-center transition-all">
                                <i class="fa-solid fa-check"></i>
                            </button>
                        </td>
                    </tr>
                `}).join('');
                document.getElementById('footerActions').innerHTML = `<p class="text-center text-[9px] text-slate-600 font-bold uppercase tracking-widest">Ordenado por Logística de Endereço</p>`;
            },

            updateSearch(val) {
                const code = this.extractId(val);
                const prod = this.inventory.find(i => i.COD && this.extractId(i.COD) === code);
                const live = document.getElementById('liveAddress');
                if (prod && val.length >= 5) {
                    document.getElementById('lRua').textContent = prod.RUA || "-";
                    document.getElementById('lRack').textContent = prod.RCK || "-";
                    document.getElementById('lLin').textContent = prod.LIN || "-";
                    document.getElementById('lCol').textContent = prod.COL || "-";
                    live.style.opacity = "1";
                    if (prod.QTD_ITENS) document.getElementById('valQtyItens').value = prod.QTD_ITENS;
                } else {
                    live.style.opacity = "0";
                }
            },

            setMode(m) {
                this.mode = m;
                document.getElementById('tabEti').className = `flex-1 py-3 rounded-xl text-[11px] font-black uppercase transition-all flex items-center justify-center gap-2 ${m === 'etiqueta' ? 'tab-active' : 'text-slate-500'}`;
                document.getElementById('tabSep').className = `flex-1 py-3 rounded-xl text-[11px] font-black uppercase transition-all flex items-center justify-center gap-2 ${m === 'separacao' ? 'tab-active' : 'text-slate-500'}`;
                document.getElementById('etiquetaView').classList.toggle('hidden', m !== 'etiqueta');
                document.getElementById('separacaoView').classList.toggle('hidden', m !== 'separacao');
                this.attachListener();
            },

            async addItemToQueue() {
                const code = document.getElementById('mainCode').value;
                if (!code) return;
                const prod = this.inventory.find(i => i.COD && this.extractId(i.COD) === this.extractId(code)) || { NOM: "AVULSO", COD: code };
                const n = this.normalizeProduct(prod);
                const qEtq = parseInt(document.getElementById('valQtyEtq').value) || 1;
                
                document.getElementById('loader').classList.remove('hidden');
                for (let i = 0; i < qEtq; i++) {
                    await push(ref(db, "print_queue"), {
                        codigo_barras: code,
                        validade: document.getElementById('valDate').value,
                        qtdItens: document.getElementById('valQtyItens').value,
                        tempName: n.NOM,
                        fullData: n
                    });
                }
                document.getElementById('loader').classList.add('hidden');
                this.showToast(`Adicionado: ${n.NOM}`);
                document.getElementById('mainCode').value = "";
            },

            async generateZPL(action) {
                const snap = await get(ref(db, "print_queue"));
                const items = snap.val() ? Object.values(snap.val()) : [];
                if (!items.length) return;

                let zpl = "";
                const clean = (t) => String(t || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().replace(/[^A-Z0-9\s\/\-.:,]/g, " ");

                for (let i = 0; i < items.length; i += 2) {
                    zpl += "^XA\n^CI28\n^PW812\n^LL1218\n";
                    [0, 600].forEach((y, idx) => {
                        const item = items[i + idx];
                        if (item) {
                            const r = item.fullData || {};
                            zpl += `^FO20,${y+20}^A0N,110,100^FD${this.extractId(item.codigo_barras)}^FS\n`;
                            if (item.validade) zpl += `^FO235,${y+10}^GB550,70,80^FS\n^FO250,${y+20}^A0N,105,100^FR^FDVAL: ${clean(item.validade)}^FS\n`;
                            zpl += `^FO20,${y+150}^A0N,60,60^FB770,2,0,L,0^FD${clean(item.tempName)}^FS\n`;
                            zpl += `^FO20,${y+320}^A0N,45,45^FD${clean(r.RUA)} ${clean(r.RCK)}  ${clean(r.LIN)}/${clean(r.COL)}^FS\n`;
                            if (item.qtdItens) zpl += `^FO580,${y+320}^A0N,80,80^FDQ:${item.qtdItens}^FS\n`;
                            zpl += `^BY3,3,180^FO60,${y+380}^BCN,180,Y,N,N^FD${item.codigo_barras}^FS\n`;
                        }
                    });
                    zpl += "^XZ\n";
                }

                if (action === 'copy') {
                    await navigator.clipboard.writeText(zpl);
                    this.showToast("ZPL Copiado!");
                } else {
                    const blob = new Blob([zpl], { type: 'text/plain' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob); a.download = `Etiquetas_${Date.now()}.zpl`; a.click();
                }
                await remove(ref(db, "print_queue"));
            },

            async processBulkSeparation() {
                const lines = document.getElementById('bulkList').value.split('\n').filter(l => l.trim() !== '');
                if (!lines.length) return;

                document.getElementById('loader').classList.remove('hidden');
                for (let line of lines) {
                    const tokens = line.trim().split(/[\s|;,]+/).filter(t => t !== '');
                    if (!tokens.length) continue;
                    const code = tokens[0];
                    let qty = 1;
                    for (let i = tokens.length - 1; i >= 0; i--) { if (!isNaN(tokens[i])) { qty = parseInt(tokens[i], 10); break; } }
                    const prod = this.inventory.find(i => i.COD && this.extractId(i.COD) === this.extractId(code)) || { NOM: "NÃO CADASTRADO", COD: code };
                    const n = this.normalizeProduct(prod);
                    await push(ref(db, "active_separation"), {
                        code, qty: String(qty), name: n.NOM,
                        rua: n.RUA, rack: n.RCK, stock: n.QTD_ESTOQUE, status: 'pending'
                    });
                }
                document.getElementById('bulkList').value = "";
                document.getElementById('loader').classList.add('hidden');
            },

            async handleFileUpload(input) {
                const file = input.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const rows = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), { type: 'array' }).Sheets[XLSX.read(new Uint8Array(e.target.result), { type: 'array' }).SheetNames[0]], { header: 1 });
                    const produtos = {};
                    for (let i = 1; i < rows.length; i++) {
                        const r = rows[i]; if (!r[0]) continue;
                        produtos[r[0]] = this.normalizeProduct({ COD: r[0], NOM: r[1], RUA: r[4], RCK: r[5], LIN: r[6], COL: r[7], QTD_ESTOQUE: r[10] });
                    }
                    await set(ref(db, "master_products"), produtos);
                    this.showToast("Cadastro Atualizado");
                };
                reader.readAsArrayBuffer(file);
            },

            async importOrderSheet(input) {
                const file = input.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const rows = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), { type: 'array' }).Sheets[XLSX.read(new Uint8Array(e.target.result), { type: 'array' }).SheetNames[0]], { header: 1 });
                    document.getElementById('loader').classList.remove('hidden');
                    for (let r of rows) {
                        if (!r[0]) continue;
                        const code = String(r[0]).trim();
                        const p = this.inventory.find(p => p.COD && this.extractId(p.COD) === this.extractId(code)) || { NOM: "IMPORTADO", COD: code };
                        const n = this.normalizeProduct(p);
                        await push(ref(db, "active_separation"), { code, qty: String(r[1] || 1), name: n.NOM, rua: n.RUA, rack: n.RCK, stock: n.QTD_ESTOQUE, status: 'pending' });
                    }
                    document.getElementById('loader').classList.add('hidden');
                    input.value = "";
                };
                reader.readAsArrayBuffer(file);
            },

            async deleteItem(id) { await remove(ref(db, (this.mode === 'etiqueta' ? 'print_queue' : 'active_separation') + '/' + id)); },
            async toggleStatus(id, s) { await set(ref(db, `active_separation/${id}/status`), s === 'done' ? 'pending' : 'done'); },
            async editQuantity(id, q) {
                const nq = prompt("Alterar Quantidade:", q);
                if (nq && !isNaN(nq)) await update(ref(db, `active_separation/${id}`), { qty: String(nq) });
            },
            async clearCurrentCollection() { if (confirm("Limpar toda a lista?")) await remove(ref(db, this.mode === 'etiqueta' ? "print_queue" : "active_separation")); },
            async syncInventory() { 
                document.getElementById('loader').classList.remove('hidden');
                const snap = await get(ref(db, "master_products"));
                this.inventory = snap.exists() ? Object.values(snap.val()).map(p => this.normalizeProduct(p)) : [];
                document.getElementById('loader').classList.add('hidden');
                this.showToast("Sincronizado");
            },

            initKeyboard() {
                const kb = document.getElementById('keyboard');
                [1,2,3,4,5,6,7,8,9,'DEL',0,'CLR'].forEach(v => {
                    const btn = document.createElement('button');
                    btn.className = `h-14 rounded-xl font-black text-lg transition-all ${v === 'DEL' ? 'bg-rose-500/10 text-rose-500' : (v === 'CLR' ? 'bg-amber-500 text-slate-950' : 'bg-slate-950 text-white border border-slate-800')}`;
                    btn.textContent = v;
                    btn.onclick = () => {
                        if (v === 'DEL') this.activeInput.value = this.activeInput.value.slice(0,-1);
                        else if (v === 'CLR') this.activeInput.value = "";
                        else this.activeInput.value += v;
                        if(this.activeInput.id === 'mainCode') this.updateSearch(this.activeInput.value);
                    };
                    kb.appendChild(btn);
                });
            },

            setActiveInput(el) { 
                this.activeInput = el; 
                document.querySelectorAll('.input-field').forEach(i => i.classList.remove('ring-2', 'ring-amber-500'));
                el.classList.add('ring-2', 'ring-amber-500'); 
            },
            
            showToast(msg) {
                const t = document.getElementById('toast');
                t.querySelector('span').textContent = msg;
                t.classList.remove('opacity-0');
                setTimeout(() => t.classList.add('opacity-0'), 2500);
            }
        };

        window.addEventListener('DOMContentLoaded', () => { 
            App.initKeyboard(); 
            App.listenMasterProducts(); 
            App.setMode('etiqueta'); 
        });
    </script>
</body>
</html>